<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Travel Schedule</title>
    
    <!-- æ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³é™¤å¤–è¨­å®š -->
    <meta name="robots" content="noindex, nofollow, noarchive, nosnippet, noimageindex">
    <meta name="googlebot" content="noindex, nofollow, noarchive, nosnippet, noimageindex">
    <meta name="bingbot" content="noindex, nofollow, noarchive, nosnippet, noimageindex">
    
    <!-- PWA Manifestï¼ˆãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆè¨­å®šï¼‰ -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#3498db">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Travel Schedule">
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiByeD0iMjQiIGZpbGw9IiMzNDk4ZGIiLz4KPHN2ZyB4PSI0OCIgeT0iNDgiIHdpZHRoPSI5NiIgaGVpZ2h0PSI5NiI+CjxwYXRoIGQ9Ik00OCAyNEMyNCAxMiAyNCAzNiA0OCA0OEw4NCA0OFY4NEw0OCA4NFY1MkwxMiA1MkMxMiA2MCAyNCA2MCA0OCA2MFY4NEgxMlY5NkgxMzJWODRIOTZWNjBIMTMyVjQ4SDk2VjI0SDQ4WiIgZmlsbD0iI2ZmZmZmZiIvPgo8L3N2Zz4KPC9zdmc+">
    <style>
        /* CSS Variables for consistent theming */
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --background-color: #f8f9fa;
            --card-background: #ffffff;
            --text-color: #2c3e50;
            --text-muted: #6c757d;
            --border-color: #dee2e6;
            --shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            --border-radius: 8px;
            --spacing-sm: 0.5rem;
            --spacing-md: 1rem;
            --spacing-lg: 2rem;
            --font-size-sm: 0.875rem;
            --font-size-md: 1rem;
            --font-size-lg: 1.125rem;
            --font-size-xl: 1.5rem;
        }

        /* Reset and base styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            background-color: var(--background-color);
        }

        /* Container */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: var(--spacing-lg);
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: var(--spacing-lg);
            padding: var(--spacing-lg);
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }

        .header h1 {
            font-size: var(--font-size-xl);
            margin-bottom: var(--spacing-sm);
        }

        .header p {
            font-size: var(--font-size-md);
            opacity: 0.9;
        }

        /* Timeline container */
        .timeline {
            position: relative;
            max-width: 100%;
        }

        /* Timeline line */
        .timeline::before {
            content: '';
            position: absolute;
            top: 0;
            left: 2rem;
            width: 3px;
            height: 100%;
            background: var(--secondary-color);
            z-index: 1;
        }

        /* Timeline item */
        .timeline-item {
            position: relative;
            margin-bottom: var(--spacing-lg);
            padding-left: 5rem;
        }

        /* Timeline marker */
        .timeline-item::before {
            content: '';
            position: absolute;
            left: 1.25rem;
            top: 0.5rem;
            width: 1.5rem;
            height: 1.5rem;
            background: var(--secondary-color);
            border-radius: 50%;
            border: 4px solid var(--card-background);
            z-index: 2;
        }

        /* Event markers */
        .timeline-item.event::before {
            background: var(--accent-color);
        }

        /* Historical site markers */
        .timeline-item.historical::before {
            background: linear-gradient(135deg, #8B4513, #D2691E);
            border: 4px solid var(--card-background);
        }

        .timeline-item.historical .activity {
            color: #8B4513;
        }

        /* Timeline card */
        .timeline-card {
            background: var(--card-background);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: var(--spacing-md);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .timeline-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }

        /* Time display */
        .time {
            font-size: var(--font-size-sm);
            color: var(--text-muted);
            font-weight: 600;
            margin-bottom: var(--spacing-sm);
        }

        /* Location/Activity title */
        .activity {
            font-size: var(--font-size-lg);
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: var(--spacing-sm);
        }

        .activity.event {
            color: var(--accent-color);
        }

        /* Description */
        .description {
            font-size: var(--font-size-md);
            color: var(--text-color);
            line-height: 1.6;
        }

        /* Links */
        .description a {
            color: var(--secondary-color);
            text-decoration: none;
            word-break: break-all;
            transition: color 0.2s ease;
        }

        .description a:hover {
            color: var(--primary-color);
            text-decoration: underline;
        }

        /* Highlight important information */
        .highlight {
            background: rgba(231, 76, 60, 0.1);
            padding: 2px 4px;
            border-radius: 3px;
            font-weight: 600;
        }

        /* Distance/Duration badges */
        .badge {
            display: inline-block;
            background: var(--secondary-color);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: var(--font-size-sm);
            font-weight: 600;
            margin-left: var(--spacing-sm);
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .container {
                padding: var(--spacing-md);
            }

            .header {
                padding: var(--spacing-md);
            }

            .header h1 {
                font-size: var(--font-size-lg);
            }

            .timeline::before {
                left: 1rem;
            }

            .timeline-item {
                padding-left: 3rem;
            }

            .timeline-item::before {
                left: 0.25rem;
                width: 1rem;
                height: 1rem;
            }

            .activity {
                font-size: var(--font-size-md);
            }

            .description {
                font-size: var(--font-size-sm);
            }

            .badge {
                display: block;
                margin: var(--spacing-sm) 0;
                width: fit-content;
            }
        }

        /* Print styles */
        @media print {
            .timeline::before {
                background: #000 !important;
            }
            
            .timeline-item::before {
                background: #000 !important;
            }
            
            .timeline-card {
                break-inside: avoid;
                box-shadow: none;
                border: 1px solid var(--border-color);
            }
        }

        /* Focus styles for accessibility */
        .timeline-card:focus-within {
            outline: 2px solid var(--secondary-color);
            outline-offset: 2px;
        }

        a:focus {
            outline: 2px solid var(--secondary-color);
            outline-offset: 2px;
        }
        
        /* PWAå°‚ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        .pwa-mode {
            --header-padding-top: env(safe-area-inset-top, 20px);
        }
        
        .pwa-mode .header {
            padding-top: calc(var(--spacing-lg) + var(--header-padding-top));
        }
        
        /* ã‚²ãƒ¼ãƒŸãƒ•ã‚£ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes stampModalFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes stampBounce {
            0% { transform: scale(0.3) rotate(-10deg); opacity: 0; }
            50% { transform: scale(1.1) rotate(5deg); opacity: 1; }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }
        
        @keyframes achievementShine {
            0% { transform: scale(0.5); opacity: 0; box-shadow: 0 0 0 rgba(255,255,255,0.5); }
            50% { transform: scale(1.1); opacity: 1; box-shadow: 0 0 30px rgba(255,255,255,0.8); }
            100% { transform: scale(1); opacity: 1; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        }
        
        @keyframes slideUpBanner {
            from { 
                transform: translateY(100%); 
                opacity: 0; 
            }
            to { 
                transform: translateY(0); 
                opacity: 1; 
            }
        }
        
        /* å†™çœŸã‚®ãƒ£ãƒ©ãƒªãƒ¼ */
        .photo-gallery {
            margin-top: 12px;
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        
        .photo-thumbnail {
            width: 60px;
            height: 60px;
            background-size: cover;
            background-position: center;
            border-radius: 6px;
            cursor: pointer;
            border: 2px solid #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: transform 0.2s ease;
            position: relative;
        }
        
        .photo-thumbnail:hover {
            transform: scale(1.1);
            z-index: 10;
        }
        
        /* ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ãƒãƒŠãƒ¼ */
        .notification-banner {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            z-index: 1002;
            display: flex;
            align-items: center;
            justify-content: space-between;
            animation: slideUpBanner 0.5s ease-out;
        }
        
        /* ã‚ªãƒ•ãƒ©ã‚¤ãƒ³è¡¨ç¤º */
        .offline-indicator {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: #dc3545;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            z-index: 1001;
        }
        
        .online-indicator {
            background: #28a745;
        }

        /* Control Panel */
        .control-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--card-background);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: var(--spacing-md);
            z-index: 100;
            min-width: 280px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .control-panel h3 {
            color: var(--primary-color);
            margin-bottom: var(--spacing-sm);
            font-size: var(--font-size-md);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: var(--spacing-sm);
        }

        /* Progress Tracker */
        .progress-section {
            margin-bottom: var(--spacing-md);
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--border-color);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: var(--spacing-sm);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--secondary-color), var(--accent-color));
            transition: width 0.3s ease;
            width: 0%;
        }

        .progress-text {
            font-size: var(--font-size-sm);
            color: var(--text-muted);
            text-align: center;
        }

        /* Cost Calculator */
        .cost-section {
            margin-bottom: var(--spacing-md);
        }

        .cost-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: var(--spacing-sm);
            font-size: var(--font-size-sm);
        }

        .cost-total {
            font-weight: 700;
            color: var(--primary-color);
            border-top: 1px solid var(--border-color);
            padding-top: var(--spacing-sm);
        }

        /* Time Adjuster */
        .time-adjuster {
            margin-bottom: var(--spacing-md);
        }

        .time-controls {
            display: flex;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-sm);
        }

        .time-btn {
            padding: 4px 8px;
            border: 1px solid var(--border-color);
            background: var(--card-background);
            border-radius: 4px;
            font-size: var(--font-size-sm);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .time-btn:hover {
            background: var(--secondary-color);
            color: white;
        }

        .current-delay {
            font-size: var(--font-size-sm);
            color: var(--text-muted);
            text-align: center;
        }

        /* Completed items */
        .timeline-item.completed {
            opacity: 0.7;
        }

        .timeline-item.completed .timeline-card {
            background: #f8f9fa;
            border-left: 4px solid var(--secondary-color);
        }

        .timeline-item.current {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        /* Toggle button */
        .toggle-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--secondary-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            cursor: pointer;
            box-shadow: var(--shadow);
            z-index: 101;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .toggle-panel:hover {
            background: var(--primary-color);
            transform: scale(1.1);
        }

        .control-panel.hidden {
            display: none;
        }

        /* Interactive Map Modal */
        .map-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .map-modal.active {
            display: flex;
        }

        .map-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            max-width: 90%;
            max-height: 90%;
            overflow: hidden;
            position: relative;
        }

        .map-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #dee2e6;
        }

        .map-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6c757d;
        }

        .map-close:hover {
            color: #e74c3c;
        }

        .map-content {
            width: 600px;
            height: 400px;
            background: #f8f9fa;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6c757d;
            font-size: 14px;
            text-align: center;
            line-height: 1.5;
        }

        /* Timeline enhancements */
        .timeline-item {
            position: relative;
            margin-bottom: var(--spacing-lg);
            padding-left: 5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .timeline-item:hover {
            transform: translateX(5px);
        }

        .timeline-item.completed {
            opacity: 0.7;
        }

        .timeline-item.completed .timeline-card {
            background: #f8f9fa;
            border-left: 4px solid var(--secondary-color);
        }

        .timeline-item.current {
            animation: pulse 2s infinite;
        }

        .timeline-item.current .timeline-card {
            box-shadow: 0 4px 20px rgba(52, 152, 219, 0.3);
            border-left: 4px solid var(--secondary-color);
        }

        /* Action buttons */
        .action-buttons {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .action-btn.map-btn {
            background: #3498db;
            color: white;
        }

        .action-btn.map-btn:hover {
            background: #2980b9;
        }

        .action-btn.directions-btn {
            background: #27ae60;
            color: white;
        }

        .action-btn.directions-btn:hover {
            background: #219a52;
        }

        .action-btn.info-btn {
            background: #f39c12;
            color: white;
        }

        .action-btn.info-btn:hover {
            background: #d68910;
        }

        /* Status indicators */
        .status-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            z-index: 10;
        }

        .status-indicator.completed {
            background: #d4edda;
            color: #155724;
        }

        .status-indicator.current {
            background: #cce5ff;
            color: #004085;
        }

        .status-indicator.upcoming {
            background: #fff3cd;
            color: #856404;
        }

        /* Weather info in timeline items */
        .weather-info {
            position: absolute;
            top: 10px;
            right: 80px; /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã®å·¦å´ã«é…ç½® */
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 6px 8px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 4px;
            z-index: 5;
            max-width: 120px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .weather-info .weather-icon {
            font-size: 16px;
            flex-shrink: 0;
        }

        .weather-info .weather-details {
            display: flex;
            flex-direction: column;
            gap: 1px;
            min-width: 0;
        }

        .weather-info .weather-temp {
            font-weight: 600;
            color: var(--primary-color);
            line-height: 1;
        }

        .weather-info .weather-desc {
            color: var(--text-muted);
            font-size: 10px;
            line-height: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œã§ã®èª¿æ•´ */
        @media (max-width: 768px) {
            .weather-info {
                position: static;
                margin-top: 8px;
                margin-bottom: 8px;
                max-width: none;
                display: inline-flex;
            }
            
            .status-indicator {
                position: static;
                margin-bottom: 8px;
                display: inline-block;
            }
            
            .timeline-card {
                position: relative;
                padding-top: 12px;
            }
            
            .status-weather-container {
                display: flex;
                justify-content: space-between;
                align-items: flex-start;
                margin-bottom: 8px;
                flex-wrap: wrap;
                gap: 8px;
            }
        }

        /* Notification system */
        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--card-background);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 12px 20px;
            box-shadow: var(--shadow);
            z-index: 1001;
            opacity: 0;
            transform: translateX(-50%) translateY(-20px);
            transition: all 0.3s ease;
        }

        .notification.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        .notification.success {
            border-left: 4px solid #27ae60;
        }

        .notification.info {
            border-left: 4px solid #3498db;
        }

        .notification.warning {
            border-left: 4px solid #f39c12;
        }

        /* Dark mode support */
        .dark-mode {
            --primary-color: #3498db;
            --secondary-color: #2980b9;
            --background-color: #1a1a1a;
            --card-background: #2d2d2d;
            --text-color: #ffffff;
            --text-muted: #b0b0b0;
            --border-color: #444444;
        }

        .dark-mode body {
            background-color: var(--background-color);
            color: var(--text-color);
        }

        .dark-mode .timeline-card {
            background: var(--card-background);
            color: var(--text-color);
        }

        .dark-mode .control-panel {
            background: var(--card-background);
            color: var(--text-color);
        }

        /* Mobile adjustments */
        @media (max-width: 768px) {
            .map-content {
                width: 100%;
                height: 300px;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .action-btn {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Control Panel -->
        <button class="toggle-panel" onclick="togglePanel()" aria-label="ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ«ã‚’é–‹ã">
            âš™ï¸
        </button>
        
        <div class="control-panel hidden" id="controlPanel">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h3 style="margin: 0;">ğŸ“Š æ—…è¡Œã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«</h3>
                <button class="time-btn" onclick="toggleDarkMode()" style="padding: 4px 8px; margin: 0;">
                    ğŸŒ™
                </button>
            </div>
            
            <div class="progress-section">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-text" id="progressText">0/16 å®Œäº†</div>
            </div>

            <h3>ğŸ’° è²»ç”¨è¨ˆç®—</h3>
            <div class="cost-section" id="costSection">
                <div class="cost-item">
                    <span>HELLO CYCLINGï¼š</span>
                    <span>Â¥850</span>
                </div>
                <div class="cost-item">
                    <span>é›»è»Šä»£ï¼š</span>
                    <span>Â¥660</span>
                </div>
                <div class="cost-item">
                    <span>é£Ÿäº‹ä»£ï¼ˆæ¨å®šï¼‰ï¼š</span>
                    <span>Â¥3,000</span>
                </div>
                <div class="cost-item">
                    <span>ãã®ä»–ï¼š</span>
                    <span>Â¥1,000</span>
                </div>
                <div class="cost-item cost-total">
                    <span>åˆè¨ˆï¼š</span>
                    <span>Â¥5,510</span>
                </div>
                <div style="margin-top: 8px;">
                    <button class="time-btn" onclick="showExpenseForm()" style="width: 100%; font-size: 11px;">
                        â• å®Ÿè²»è¨˜éŒ²
                    </button>
                </div>
            </div>

            <h3>â° æ™‚é–“èª¿æ•´</h3>
            <div class="time-adjuster">
                <div class="time-controls">
                    <button class="time-btn" onclick="adjustTime(-15)">-15åˆ†</button>
                    <button class="time-btn" onclick="adjustTime(-5)">-5åˆ†</button>
                    <button class="time-btn" onclick="adjustTime(5)">+5åˆ†</button>
                    <button class="time-btn" onclick="adjustTime(15)">+15åˆ†</button>
                </div>
                <div class="current-delay" id="currentDelay">é…å»¶: 0åˆ†</div>
                <button class="time-btn" onclick="resetTime()" style="width: 100%; margin-top: 8px;">ãƒªã‚»ãƒƒãƒˆ</button>
            </div>
        </div>

        <header class="header">
            <h1>2025å¹´7æœˆ19æ—¥ æ¸‹è°·â†’æ¨ªæµœ ä¸€æ—¥ãƒ—ãƒ©ãƒ³</h1>
            <p>HELLO CYCLING ã¨é›»è»Šã‚’ä½¿ã£ãŸæ¨ªæµœã‚°ãƒ«ãƒ¡ãƒ»ã‚¤ãƒ™ãƒ³ãƒˆå·¡ã‚Š</p>
        </header>

        <main class="timeline" role="main">
            <!-- å‡ºç™º -->
            <article class="timeline-item" data-location="æ¸‹è°·é§…">
                <div class="timeline-card">
                    <div class="status-indicator upcoming">äºˆå®š</div>
                    <time class="time" datetime="06:55">06:55</time>
                    <h2 class="activity">æ¸‹è°·é§…ã€ˆå¾³çœŸä¼š QUARTZ TOWER ãƒãƒ¼ãƒˆã€‰ã§ãƒ¬ãƒ³ã‚¿ãƒ«</h2>
                    <div class="description">
                        HELLO CYCLING 24hãƒãƒ¼ãƒˆã€‚7å°ç¨‹åº¦ã€‚ã‚¢ãƒ—ãƒªã§å‰å¤œã«30åˆ†å–ã‚Šç½®ãã™ã‚‹ã¨ç¢ºå®Ÿã€‚<br>
                        <a href="https://cycle.ryde-go.com/ports/10072" target="_blank" rel="noopener noreferrer">https://cycle.ryde-go.com/ports/10072</a>
                    </div>
                    <div class="action-buttons">
                        <button class="action-btn map-btn" onclick="showMap('æ¸‹è°·é§…')">
                            ğŸ“ åœ°å›³
                        </button>
                        <a href="https://maps.google.com/maps?q=æ¸‹è°·é§…+QUARTZ+TOWER" target="_blank" class="action-btn directions-btn">
                            ğŸ§­ çµŒè·¯
                        </a>
                        <button class="action-btn info-btn" onclick="showStationInfo('æ¸‹è°·é§…')">
                            â„¹ï¸ æƒ…å ±
                        </button>
                    </div>
                </div>
            </article>

            <!-- ç§»å‹•1 -->
            <article class="timeline-item" data-location="æ¨ªæµœå¸‚ä¸­å¤®å¸å£²å¸‚å ´">
                <div class="timeline-card">
                    <div class="status-indicator upcoming">äºˆå®š</div>
                    <time class="time" datetime="06:55/08:45">06:55â€“08:45</time>
                    <h2 class="activity">æ¸‹è°· â†’ æ¨ªæµœå¸‚ä¸­å¤®å¸å£²å¸‚å ´æœ¬å ´ï¼ˆæ°´ç”£ä»²å¸æ£Ÿï¼‰<span class="badge">ç´„28kmãƒ»1æ™‚é–“50åˆ†</span></h2>
                    <div class="description">
                        å›½é“246â†’15â†’1å·â†’æ–°æ¨ªæµœé€šã‚Šã€‚å¹³å‡14km/hï¼‹ä¿¡å·å¾…ã¡10åˆ†ã€‚
                    </div>
                    <div class="action-buttons">
                        <button class="action-btn map-btn" onclick="showMap('æ¨ªæµœå¸‚ä¸­å¤®å¸å£²å¸‚å ´')">
                            ğŸ“ åœ°å›³
                        </button>
                        <a href="https://maps.google.com/maps/dir/æ¸‹è°·é§…/æ¨ªæµœå¸‚ä¸­å¤®å¸å£²å¸‚å ´" target="_blank" class="action-btn directions-btn">
                            ğŸš´ è‡ªè»¢è»Šãƒ«ãƒ¼ãƒˆ
                        </a>
                        <button class="action-btn info-btn" onclick="showTrafficInfo()">
                            ğŸš¦ äº¤é€šæƒ…å ±
                        </button>
                    </div>
                </div>
            </article>

            <!-- æ­´å²ã‚¹ãƒãƒƒãƒˆ1 -->
            <article class="timeline-item historical" data-location="å“å·å®¿">
                <div class="timeline-card">
                    <div class="status-indicator upcoming">é€šé</div>
                    <time class="time" datetime="07:20">07:20</time>
                    <h2 class="activity">ğŸ›ï¸ å“å·å®¿ï¼ˆæ±æµ·é“ä¸€ç•ªç›®ã®å®¿å ´ï¼‰</h2>
                    <div class="description">
                        ã‚¢ãƒ¼ãƒå½¢ã®"æ—§æ±æµ·é“"æ¡ˆå†…ã‚²ãƒ¼ãƒˆã¨è¡—é“ç¯ãŒä¸¦ã¶å®¿å ´è·¡ã€‚é“æ²¿ã„å³æ‰‹ã«ã€Œå“å·å®¿äº¤æµé¤¨ æœ¬å®¿ãŠä¼‘ã¿å‡¦ã€ã®ç™½å£ãŒè¦‹ãˆã‚‹ã€‚<br>
                        <a href="https://www.gltjp.com/ja/directory/item/11086/" target="_blank" rel="noopener noreferrer">å¥½é‹æ—¥æœ¬è¡Œ - æ—§æ±æµ·é“ å“å·å®¿</a>
                    </div>
                    <div class="action-buttons">
                        <button class="action-btn map-btn" onclick="showMap('å“å·å®¿')">
                            ğŸ“ åœ°å›³
                        </button>
                        <button class="action-btn info-btn" onclick="showHistoryInfo('å“å·å®¿')">
                            ğŸ›ï¸ æ­´å²è©³ç´°
                        </button>
                    </div>
                </div>
            </article>

            <!-- æ­´å²ã‚¹ãƒãƒƒãƒˆ2 -->
            <article class="timeline-item historical" data-location="å·å´å®¿è·¡">
                <div class="timeline-card">
                    <div class="status-indicator upcoming">é€šé</div>
                    <time class="time" datetime="07:50">07:50</time>
                    <h2 class="activity">ğŸ›ï¸ å·å´å®¿è·¡</h2>
                    <div class="description">
                        ã€Œæ±æµ·é“å·å´å®¿ã€ã®è¡Œç¯å½¢è¡—ç¯ã¨èŠ­è•‰å¥ç¢‘ï¼ˆå·¦æ­©é“å´ï¼‰ã€‚æœ¬é™£è·¡ã¯äº¤å·®ç‚¹ã«èª¬æ˜æ¿ã®ã¿æ®‹å­˜ã€‚<br>
                        <a href="https://www.tabirai.net/localinfo/article/article-23188/" target="_blank" rel="noopener noreferrer">ãŸã³ã‚‰ã„ - å·å´ã®æ—§æ±æµ·é“</a>
                    </div>
                    <div class="action-buttons">
                        <button class="action-btn map-btn" onclick="showMap('å·å´å®¿è·¡')">
                            ğŸ“ åœ°å›³
                        </button>
                        <button class="action-btn info-btn" onclick="showHistoryInfo('å·å´å®¿è·¡')">
                            ğŸ›ï¸ æ­´å²è©³ç´°
                        </button>
                    </div>
                </div>
            </article>

            <!-- æ­´å²ã‚¹ãƒãƒƒãƒˆ3 -->
            <article class="timeline-item historical" data-location="ç”Ÿéº¦äº‹ä»¶ç¢‘">
                <div class="timeline-card">
                    <div class="status-indicator upcoming">é€šé</div>
                    <time class="time" datetime="08:10">08:10</time>
                    <h2 class="activity">ğŸ›ï¸ ç”Ÿéº¦äº‹ä»¶ç¢‘</h2>
                    <div class="description">
                        å›½é“15å·ã¨æ—§æ±æµ·é“ãŒäº¤ã‚ã‚‹è§’ã®çŸ³ç¢‘ã€‚è–©è‹±æˆ¦äº‰ã®ç™ºç«¯ã¨ãªã£ãŸäº‹ä»¶ã‚’ä¼ãˆã‚‹ã€‚æ­©é“ã‹ã‚‰æ•°ç§’ã§è¦–èªå¯èƒ½ã€‚<br>
                        <a href="https://trip.pref.kanagawa.jp/sc/destination/scene-of-the-namamugi-incident-and-monument/140" target="_blank" rel="noopener noreferrer">ç¥å¥ˆå·çœŒè¦³å…‰ - ç”Ÿéº¦äº‹ä»¶ç¢‘</a>
                    </div>
                    <div class="action-buttons">
                        <button class="action-btn map-btn" onclick="showMap('ç”Ÿéº¦äº‹ä»¶ç¢‘')">
                            ğŸ“ åœ°å›³
                        </button>
                        <button class="action-btn info-btn" onclick="showHistoryInfo('ç”Ÿéº¦äº‹ä»¶ç¢‘')">
                            ğŸ›ï¸ æ­´å²è©³ç´°
                        </button>
                    </div>
                </div>
            </article>

            <!-- æ­´å²ã‚¹ãƒãƒƒãƒˆ4 -->
            <article class="timeline-item historical" data-location="ç¥å¥ˆå·å®¿æ­´å²ã®é“">
                <div class="timeline-card">
                    <div class="status-indicator upcoming">é€šé</div>
                    <time class="time" datetime="08:25">08:25</time>
                    <h2 class="activity">ğŸ›ï¸ ç¥å¥ˆå·å®¿æ­´å²ã®é“</h2>
                    <div class="description">
                        è¡—è·¯æ¨¹ãŒä¸¦ã¶å‚é“æ²¿ã„ã«å®¿å ´è§£èª¬ãƒ‘ãƒãƒ«ã€‚ã€Œè¢–ãƒ¶æµ¦ã€ã®å…¥æ±Ÿè·¡ã‚’è¦‹ä¸‹ã‚ã™å°‘ã—é«˜å°ã®æ™¯è¦³ã€‚<br>
                        <a href="https://www.kanagawa-kankou.or.jp/features/tokaido-column515943" target="_blank" rel="noopener noreferrer">ç¥å¥ˆå·çœŒè¦³å…‰å”ä¼š - æ—§æ±æµ·é“ ç¥å¥ˆå·å®¿</a>
                    </div>
                    <div class="action-buttons">
                        <button class="action-btn map-btn" onclick="showMap('ç¥å¥ˆå·å®¿æ­´å²ã®é“')">
                            ğŸ“ åœ°å›³
                        </button>
                        <button class="action-btn info-btn" onclick="showHistoryInfo('ç¥å¥ˆå·å®¿æ­´å²ã®é“')">
                            ğŸ›ï¸ æ­´å²è©³ç´°
                        </button>
                    </div>
                </div>
            </article>

            <!-- ã‚¤ãƒ™ãƒ³ãƒˆ1 -->
            <article class="timeline-item event" data-location="æ°´ç”£ä»²å¸æ£Ÿ">
                <div class="timeline-card">
                    <div class="status-indicator upcoming">äºˆå®š</div>
                    <time class="time" datetime="08:45/09:45">08:45â€“09:45</time>
                    <h2 class="activity event">æ°´ç”£ä»²å¸æ£Ÿ ä¸€èˆ¬é–‹æ”¾</h2>
                    <div class="description">
                        <span class="highlight">8:00â€“10:00</span>ï¼ˆå…¥å ´ç„¡æ–™ï¼‰ã€‚é®®é­šç›´å£²ãƒ»ãƒã‚°ãƒ­è§£ä½“ãªã©ã€‚ãƒ•ã‚©ãƒ¼ã‚¯ãƒªãƒ•ãƒˆé€šè¡ŒåŒºç”»ã«æ³¨æ„ã€‚
                    </div>
                    <div class="action-buttons">
                        <button class="action-btn map-btn" onclick="showMap('æ°´ç”£ä»²å¸æ£Ÿ')">
                            ğŸ“ åœ°å›³
                        </button>
                        <button class="action-btn info-btn" onclick="showEventInfo('æ°´ç”£ä»²å¸æ£Ÿ')">
                            ğŸª ã‚¤ãƒ™ãƒ³ãƒˆè©³ç´°
                        </button>
                    </div>
                </div>
            </article>

            <!-- ç§»å‹•2 -->
            <article class="timeline-item" data-location="å…­è§’æ©‹å•†åº—è¡—">
                <div class="timeline-card">
                    <div class="status-indicator upcoming">äºˆå®š</div>
                    <time class="time" datetime="09:45/10:05">09:45â€“10:05</time>
                    <h2 class="activity">å¸‚å ´ â†’ å…­è§’æ©‹å•†åº—è¡—<span class="badge">ç´„2kmãƒ»è‡ªè»¢è»Š</span></h2>
                    <div class="description">
                        10åˆ†å¼·ã€‚å•†åº—è¡—é§è¼ªå ´ã¸ã€‚
                    </div>
                    <div class="action-buttons">
                        <button class="action-btn map-btn" onclick="showMap('å…­è§’æ©‹å•†åº—è¡—')">
                            ğŸ“ åœ°å›³
                        </button>
                        <a href="https://maps.google.com/maps/dir/æ¨ªæµœå¸‚ä¸­å¤®å¸å£²å¸‚å ´/å…­è§’æ©‹å•†åº—è¡—" target="_blank" class="action-btn directions-btn">
                            ğŸš´ è‡ªè»¢è»Šãƒ«ãƒ¼ãƒˆ
                        </a>
                    </div>
                </div>
            </article>

            <!-- æ­´å²ã‚¹ãƒãƒƒãƒˆ5 -->
            <article class="timeline-item historical" data-location="ç¥å¥ˆå·å®¿æ­´å²ã®é“æ¡ˆå†…æ¿">
                <div class="timeline-card">
                    <div class="status-indicator upcoming">é€šé</div>
                    <time class="time" datetime="09:55">09:55é ƒ</time>
                    <h2 class="activity">ğŸ›ï¸ ç¥å¥ˆå·å®¿"æ­´å²ã®é“"æ¡ˆå†…æ¿</h2>
                    <div class="description">
                        æ±Ÿæˆ¸ã‹ã‚‰ï¼“ç•ªç›®ã®å®¿å ´ã€‚å‚é“æ²¿ã„ã«æ—§æœ¬é™£è·¡ã‚„å®¿å ´çµµå›³ãƒ‘ãƒãƒ«ãŒç«‹ã¤ã€‚å‚ä¸Šã®ãƒ“ãƒ«å£é¢ã«æµ®ä¸–çµµãƒ¬ãƒ—ãƒªã‚«ã€‚<br>
                        <a href="https://www.city.yokohama.lg.jp/kanagawa/shokai/rekishi/syuku.html" target="_blank" rel="noopener noreferrer">æ¨ªæµœå¸‚å…¬å¼ã‚µã‚¤ãƒˆ - ç¥å¥ˆå·å®¿æ­´å²ã®é“</a>
                    </div>
                    <div class="action-buttons">
                        <button class="action-btn map-btn" onclick="showMap('ç¥å¥ˆå·å®¿æ­´å²ã®é“æ¡ˆå†…æ¿')">
                            ğŸ“ åœ°å›³
                        </button>
                        <button class="action-btn info-btn" onclick="showHistoryInfo('ç¥å¥ˆå·å®¿æ­´å²ã®é“æ¡ˆå†…æ¿')">
                            ğŸ›ï¸ æ­´å²è©³ç´°
                        </button>
                    </div>
                </div>
            </article>

            <!-- æ•£ç­– -->
            <article class="timeline-item" data-location="å…­è§’æ©‹å•†åº—è¡—">
                <div class="timeline-card">
                    <div class="status-indicator upcoming">äºˆå®š</div>
                    <time class="time" datetime="10:05/11:00">10:05â€“11:00</time>
                    <h2 class="activity">å…­è§’æ©‹ãƒ¢ãƒ¼ãƒ‹ãƒ³ã‚°æ•£ç­–</h2>
                    <div class="description">
                        å–«èŒ¶ã€Œçˆç²æ–‡æ˜ã€ã§ä¼‘æ†©å¯ã€‚
                    </div>
                    <div class="action-buttons">
                        <button class="action-btn map-btn" onclick="showMap('å…­è§’æ©‹å•†åº—è¡—')">
                            ğŸ“ åœ°å›³
                        </button>
                        <button class="action-btn info-btn" onclick="showShoppingInfo('å…­è§’æ©‹å•†åº—è¡—')">
                            ğŸ›ï¸ åº—èˆ—æƒ…å ±
                        </button>
                    </div>
                </div>
            </article>

            <!-- æ˜¼é£Ÿ -->
            <article class="timeline-item" data-location="ãƒ©ãƒ¼ãƒ¡ãƒ³æœ«å»£å®¶">
                <div class="timeline-card">
                    <div class="status-indicator upcoming">äºˆå®š</div>
                    <time class="time" datetime="11:00/11:45">11:00â€“11:45</time>
                    <h2 class="activity">æ˜¼é£Ÿï¼šãƒ©ãƒ¼ãƒ¡ãƒ³æœ«å»£å®¶</h2>
                    <div class="description">
                        <span class="highlight">11:00é–‹åº—</span>ï¼æ—¥ãƒ»æœˆä¼‘ã€‚å¾…ã¡15â€“25åˆ†ã€‚<br>
                        <a href="https://www.hellocycling.jp/station/tokyo/%E6%B8%8B%E8%B0%B7%E5%8C%BA" target="_blank" rel="noopener noreferrer">https://www.hellocycling.jp/station/tokyo/%E6%B8%8B%E8%B0%B7%E5%8C%BA</a>
                    </div>
                    <div class="action-buttons">
                        <button class="action-btn map-btn" onclick="showMap('ãƒ©ãƒ¼ãƒ¡ãƒ³æœ«å»£å®¶')">
                            ğŸ“ åœ°å›³
                        </button>
                        <button class="action-btn info-btn" onclick="showRestaurantInfo('ãƒ©ãƒ¼ãƒ¡ãƒ³æœ«å»£å®¶')">
                            ğŸœ åº—èˆ—æƒ…å ±
                        </button>
                    </div>
                </div>
            </article>

            <!-- ç§»å‹•3 -->
            <article class="timeline-item" data-location="åŒ—ä»²ãƒ–ãƒªãƒƒã‚¯ï¼†ãƒ›ãƒ¯ã‚¤ãƒˆ">
                <div class="timeline-card">
                    <div class="status-indicator upcoming">äºˆå®š</div>
                    <time class="time" datetime="11:45/12:05">11:45â€“12:05</time>
                    <h2 class="activity">å…­è§’æ©‹ â†’ åŒ—ä»²ãƒ–ãƒªãƒƒã‚¯ï¼†ãƒ›ãƒ¯ã‚¤ãƒˆ<span class="badge">ç´„3kmãƒ»è‡ªè»¢è»Š</span></h2>
                    <div class="description">
                        ã¿ãªã¨ã¿ã‚‰ã„å¤§é€šã‚Šã€‚
                    </div>
                    <div class="action-buttons">
                        <button class="action-btn map-btn" onclick="showMap('åŒ—ä»²ãƒ–ãƒªãƒƒã‚¯ï¼†ãƒ›ãƒ¯ã‚¤ãƒˆ')">
                            ğŸ“ åœ°å›³
                        </button>
                        <a href="https://maps.google.com/maps/dir/å…­è§’æ©‹/åŒ—ä»²ãƒ–ãƒªãƒƒã‚¯ï¼†ãƒ›ãƒ¯ã‚¤ãƒˆ" target="_blank" class="action-btn directions-btn">
                            ğŸš´ è‡ªè»¢è»Šãƒ«ãƒ¼ãƒˆ
                        </a>
                    </div>
                </div>
            </article>

            <!-- æ­´å²ã‚¹ãƒãƒƒãƒˆ6 -->
            <article class="timeline-item historical" data-location="é¦¬è»Šé“">
                <div class="timeline-card">
                    <div class="status-indicator upcoming">é€šé</div>
                    <time class="time" datetime="11:55">11:55é ƒ</time>
                    <h2 class="activity">ğŸ›ï¸ é¦¬è»Šé“ï¼ˆãƒã‚·ãƒ£ãƒŸãƒï¼‰çŸ³ç•³ã¨ã‚¬ã‚¹ç¯</h2>
                    <div class="description">
                        1866å¹´ã«é–‹å‰Šã•ã‚ŒãŸã€Œé¦¬è»ŠãŒé€šã‚‹é“ã€ã€‚è·¯è‚©ã«ã¯æ˜æ²»åˆã®ã‚¬ã‚¹ç¯ãƒ¬ãƒ—ãƒªã‚«ã¨"Carriage Road"éŠ˜æ¿ã€‚<br>
                        <a href="https://yokohamatravelguide.com/bashamichi-yokohamas-historic-gem/" target="_blank" rel="noopener noreferrer">Yokohama Travel Guide - Bashamichi</a>
                    </div>
                    <div class="action-buttons">
                        <button class="action-btn map-btn" onclick="showMap('é¦¬è»Šé“')">
                            ğŸ“ åœ°å›³
                        </button>
                        <button class="action-btn info-btn" onclick="showHistoryInfo('é¦¬è»Šé“')">
                            ğŸ›ï¸ æ­´å²è©³ç´°
                        </button>
                    </div>
                </div>
            </article>

            <!-- æ­´å²ã‚¹ãƒãƒƒãƒˆ7 -->
            <article class="timeline-item historical" data-location="æ¨ªæµœä¸‰å¡”">
                <div class="timeline-card">
                    <div class="status-indicator upcoming">é€šé</div>
                    <time class="time" datetime="12:05/12:10">12:05â€“12:10</time>
                    <h2 class="activity">ğŸ›ï¸ æ¨ªæµœä¸‰å¡” Kingãƒ»Queenãƒ»Jack</h2>
                    <div class="description">
                        1920å¹´ä»£ã€œ1930å¹´ä»£ç«£å·¥ã€‚å¡”ã®æ„›ç§°ã¯èˆ¹ä¹—ã‚ŠãŒèˆªè·¯æ¨™è­˜ã«ã—ãŸä¼æ‰¿ã«ç”±æ¥ã€‚çœŒåºï¼ˆKingï¼‰ã¯å¸å† æ§˜å¼ã€ç¨é–¢ï¼ˆQueenï¼‰ã¯ã‚¤ã‚¹ãƒ©ãƒ é¢¨ãƒ‰ãƒ¼ãƒ ãŒç‰¹å¾´ã€‚<br>
                        <a href="https://www.yokohamajapan.com/things-to-do/detail.php?id=54" target="_blank" rel="noopener noreferrer">æ¨ªæµœã‚¸ãƒ£ãƒ‘ãƒ³ - King's Tower</a>
                    </div>
                    <div class="action-buttons">
                        <button class="action-btn map-btn" onclick="showMap('æ¨ªæµœä¸‰å¡”')">
                            ğŸ“ åœ°å›³
                        </button>
                        <button class="action-btn info-btn" onclick="showHistoryInfo('æ¨ªæµœä¸‰å¡”')">
                            ğŸ›ï¸ æ­´å²è©³ç´°
                        </button>
                    </div>
                </div>
            </article>

            <!-- ã‚¤ãƒ™ãƒ³ãƒˆ2 -->
            <article class="timeline-item event" data-location="æ¨ªæµœåŒ—ä»²ãƒãƒ«ã‚·ã‚§">
                <div class="timeline-card">
                    <div class="status-indicator upcoming">äºˆå®š</div>
                    <time class="time" datetime="12:05/13:30">12:05â€“13:30</time>
                    <h2 class="activity event">æ¨ªæµœåŒ—ä»²ãƒãƒ«ã‚·ã‚§</h2>
                    <div class="description">
                        <span class="highlight">10:00â€“16:00</span>ã€‚åœ°å…ƒé‡èœãƒ»ã‚¯ãƒ©ãƒ•ãƒˆãƒ¯ã‚¤ãƒ³ç´„40åº—ã€‚
                    </div>
                    <div class="action-buttons">
                        <button class="action-btn map-btn" onclick="showMap('æ¨ªæµœåŒ—ä»²ãƒãƒ«ã‚·ã‚§')">
                            ğŸ“ åœ°å›³
                        </button>
                        <button class="action-btn info-btn" onclick="showEventInfo('æ¨ªæµœåŒ—ä»²ãƒãƒ«ã‚·ã‚§')">
                            ğŸª ã‚¤ãƒ™ãƒ³ãƒˆè©³ç´°
                        </button>
                    </div>
                </div>
            </article>

            <!-- ç§»å‹•4 -->
            <article class="timeline-item" data-location="èµ¤ãƒ¬ãƒ³ã‚¬å€‰åº«">
                <div class="timeline-card">
                    <div class="status-indicator upcoming">äºˆå®š</div>
                    <time class="time" datetime="13:30/14:15">13:30â€“14:15</time>
                    <h2 class="activity">åŒ—ä»² â†’ èµ¤ãƒ¬ãƒ³ã‚¬å€‰åº«ãƒãƒ¼ãƒˆ<span class="badge">ç´„1km</span></h2>
                    <div class="description">
                        æ°´éš›ãƒ—ãƒ­ãƒ ãƒŠãƒ¼ãƒ‰ã‚’å—ã¸ã€‚
                    </div>
                    <div class="action-buttons">
                        <button class="action-btn map-btn" onclick="showMap('èµ¤ãƒ¬ãƒ³ã‚¬å€‰åº«')">
                            ğŸ“ åœ°å›³
                        </button>
                        <a href="https://maps.google.com/maps/dir/åŒ—ä»²/èµ¤ãƒ¬ãƒ³ã‚¬å€‰åº«" target="_blank" class="action-btn directions-btn">
                            ğŸš´ è‡ªè»¢è»Šãƒ«ãƒ¼ãƒˆ
                        </a>
                    </div>
                </div>
            </article>

            <!-- æ­´å²ã‚¹ãƒãƒƒãƒˆ8 -->
            <article class="timeline-item historical" data-location="æ¨ªæµœèµ¤ãƒ¬ãƒ³ã‚¬å€‰åº«">
                <div class="timeline-card">
                    <div class="status-indicator upcoming">åˆ°ç€</div>
                    <time class="time" datetime="14:05/14:15">14:05â€“14:15</time>
                    <h2 class="activity">ğŸ›ï¸ æ¨ªæµœèµ¤ãƒ¬ãƒ³ã‚¬å€‰åº«ï¼ˆ1911/1913ï¼‰</h2>
                    <div class="description">
                        æ˜æ²»å¾ŒæœŸã«å»ºã¦ã‚‰ã‚ŒãŸç…‰ç“¦é€ ã‚Šã®æ—§ç¨é–¢å€‰åº«ã€‚é–¢æ±å¤§éœ‡ç½å¾Œã‚‚æ®‹ã£ãŸè€éœ‡ç…‰ç“¦ã®è¿«åŠ›ã‚’ã‚µãƒ‰ãƒ«è¶Šã—ã«ä¸€æœ›ã€‚<br>
                        <a href="https://en.wikipedia.org/wiki/Yokohama_Red_Brick_Warehouse" target="_blank" rel="noopener noreferrer">Wikipedia - æ¨ªæµœèµ¤ãƒ¬ãƒ³ã‚¬å€‰åº«</a>
                    </div>
                    <div class="action-buttons">
                        <button class="action-btn map-btn" onclick="showMap('æ¨ªæµœèµ¤ãƒ¬ãƒ³ã‚¬å€‰åº«')">
                            ğŸ“ åœ°å›³
                        </button>
                        <button class="action-btn info-btn" onclick="showHistoryInfo('æ¨ªæµœèµ¤ãƒ¬ãƒ³ã‚¬å€‰åº«')">
                            ğŸ›ï¸ æ­´å²è©³ç´°
                        </button>
                    </div>
                </div>
            </article>

            <!-- ã‚¤ãƒ™ãƒ³ãƒˆ3 -->
            <article class="timeline-item event" data-location="BAY WALK MARKET">
                <div class="timeline-card">
                    <div class="status-indicator upcoming">äºˆå®š</div>
                    <time class="time" datetime="14:15/15:00">14:15â€“15:00</time>
                    <h2 class="activity event">BAY WALK MARKET 2025</h2>
                    <div class="description">
                        HAMMERHEAD <span class="highlight">12:00â€“</span>ï¼èµ¤ãƒ¬ãƒ³ã‚¬ <span class="highlight">15:30â€“</span>ã€‚é›‘è²¨ãƒ»ã‚¯ãƒ©ãƒ•ãƒˆãƒ“ãƒ¼ãƒ«ã€‚<br>
                        <a href="https://cycle.ryde-go.com/ports/12546" target="_blank" rel="noopener noreferrer">https://cycle.ryde-go.com/ports/12546</a>
                    </div>
                    <div class="action-buttons">
                        <button class="action-btn map-btn" onclick="showMap('BAY WALK MARKET')">
                            ğŸ“ åœ°å›³
                        </button>
                        <button class="action-btn info-btn" onclick="showEventInfo('BAY WALK MARKET')">
                            ğŸª ã‚¤ãƒ™ãƒ³ãƒˆè©³ç´°
                        </button>
                    </div>
                </div>
            </article>

            <!-- ç§»å‹•5 -->
            <article class="timeline-item" data-location="æ–°æ‰ç”°">
                <div class="timeline-card">
                    <div class="status-indicator upcoming">äºˆå®š</div>
                    <time class="time" datetime="15:00/15:45">15:00â€“15:45</time>
                    <h2 class="activity">èµ¤ãƒ¬ãƒ³ã‚¬ â†’ æ–°æ‰ç”°<span class="badge">ç´„14kmãƒ»è‡ªè»¢è»Š</span></h2>
                    <div class="description">
                        å›½é“357å·æµ·æ²¿ã„ã€‚
                    </div>
                    <div class="action-buttons">
                        <button class="action-btn map-btn" onclick="showMap('æ–°æ‰ç”°')">
                            ğŸ“ åœ°å›³
                        </button>
                        <a href="https://maps.google.com/maps/dir/èµ¤ãƒ¬ãƒ³ã‚¬å€‰åº«/æ–°æ‰ç”°" target="_blank" class="action-btn directions-btn">
                            ğŸš´ è‡ªè»¢è»Šãƒ«ãƒ¼ãƒˆ
                        </a>
                    </div>
                </div>
            </article>

            <!-- æ­´å²ã‚¹ãƒãƒƒãƒˆ9 -->
            <article class="timeline-item historical" data-location="æ—§æ ¹å²¸ç«¶é¦¬å ´">
                <div class="timeline-card">
                    <div class="status-indicator upcoming">é€šé</div>
                    <time class="time" datetime="15:25">15:25é ƒ</time>
                    <h2 class="activity">ğŸ›ï¸ æ—§æ ¹å²¸ç«¶é¦¬å ´ä¸€ç­‰è¦³è¦§å¸­è·¡ï¼ˆ1866ï¼‰</h2>
                    <div class="description">
                        æ—¥æœ¬æœ€å¤ã®æ´‹å¼ç«¶é¦¬å ´ã‚¹ã‚¿ãƒ³ãƒ‰éºæ§‹ã€‚å›½é“357å·ã‹ã‚‰å·¦å‰æ–¹é«˜å°ã«ç™½ã„çŸ³é€ å»ºç¯‰ãŒè¦‹ãˆã‚‹ã€‚<br>
                        <a href="https://offbeatjapan.com/negishi-racecourse-yokohama-story/" target="_blank" rel="noopener noreferrer">Offbeat Japan - Negishi Racecourse</a>
                    </div>
                    <div class="action-buttons">
                        <button class="action-btn map-btn" onclick="showMap('æ—§æ ¹å²¸ç«¶é¦¬å ´')">
                            ğŸ“ åœ°å›³
                        </button>
                        <button class="action-btn info-btn" onclick="showHistoryInfo('æ—§æ ¹å²¸ç«¶é¦¬å ´')">
                            ğŸ›ï¸ æ­´å²è©³ç´°
                        </button>
                    </div>
                </div>
            </article>

            <!-- è¿”å´ -->
            <article class="timeline-item" data-location="æ–°æ‰ç”°é§…ç¬¬å››è‡ªè»¢è»Šé§è»Šå ´">
                <div class="timeline-card">
                    <div class="status-indicator upcoming">äºˆå®š</div>
                    <time class="time" datetime="15:45">15:45</time>
                    <h2 class="activity">æ–°æ‰ç”°é§…ç¬¬å››è‡ªè»¢è»Šé§è»Šå ´ãƒãƒ¼ãƒˆã§è¿”å´</h2>
                    <div class="description">
                        æ‰ç”°å®¶æœ¬åº—ã¾ã§å¾’æ­©ç´„2åˆ†ã€‚24hå—ä»˜ã€‚<br>
                        <a href="https://cycle.ryde-go.com/ports/12546" target="_blank" rel="noopener noreferrer">https://cycle.ryde-go.com/ports/12546</a>
                    </div>
                    <div class="action-buttons">
                        <button class="action-btn map-btn" onclick="showMap('æ–°æ‰ç”°é§…ç¬¬å››è‡ªè»¢è»Šé§è»Šå ´')">
                            ğŸ“ åœ°å›³
                        </button>
                        <button class="action-btn info-btn" onclick="showPortInfo('æ–°æ‰ç”°é§…ç¬¬å››è‡ªè»¢è»Šé§è»Šå ´')">
                            ğŸš² ãƒãƒ¼ãƒˆæƒ…å ±
                        </button>
                    </div>
                </div>
            </article>

            <!-- å¤•é£Ÿ -->
            <article class="timeline-item" data-location="æ‰ç”°å®¶æœ¬åº—">
                <div class="timeline-card">
                    <div class="status-indicator upcoming">äºˆå®š</div>
                    <time class="time" datetime="15:50/16:40">15:50â€“16:40</time>
                    <h2 class="activity">å¤•é£Ÿï¼šãƒ©ãƒ¼ãƒ¡ãƒ³æ‰ç”°å®¶ æœ¬åº—</h2>
                    <div class="description">
                        <span class="highlight">5:00â€“22:00</span>ï¼æ—¥ä¼‘ã€‚å¤•æ–¹ã¯ä¸¦ã³çŸ­ã‚ã€‚ã€Œå‘³è–„ã‚ã€æŒ‡å®šã‚‚å¯ã€‚<br>
                        <a href="https://www.navitime.co.jp/poi?spot=01325-9719" target="_blank" rel="noopener noreferrer">https://www.navitime.co.jp/poi?spot=01325-9719</a>
                    </div>
                    <div class="action-buttons">
                        <button class="action-btn map-btn" onclick="showMap('æ‰ç”°å®¶æœ¬åº—')">
                            ğŸ“ åœ°å›³
                        </button>
                        <button class="action-btn info-btn" onclick="showRestaurantInfo('æ‰ç”°å®¶æœ¬åº—')">
                            ğŸœ åº—èˆ—æƒ…å ±
                        </button>
                    </div>
                </div>
            </article>

            <!-- é›»è»Šç§»å‹•1 -->
            <article class="timeline-item" data-location="æ–°æ‰ç”°é§…">
                <div class="timeline-card">
                    <div class="status-indicator upcoming">äºˆå®š</div>
                    <time class="time" datetime="16:45/17:15">16:45â€“17:15</time>
                    <h2 class="activity">é›»è»Šï¼šæ–°æ‰ç”° â†’ ç™½æ¥½<span class="badge">ç´„30åˆ†ãƒ»IC 370å††</span></h2>
                    <div class="description">
                        JRæ–°æ‰ç”° â†’ JRæ¨ªæµœ â†’ æ±æ€¥æ±æ¨ªç·šç™½æ¥½ã€‚ä¹—æ›1å›ã€‚
                    </div>
                    <div class="action-buttons">
                        <button class="action-btn map-btn" onclick="showMap('æ–°æ‰ç”°é§…')">
                            ğŸ“ åœ°å›³
                        </button>
                        <button class="action-btn info-btn" onclick="showTrainInfo('æ–°æ‰ç”°-ç™½æ¥½')">
                            ğŸš† æ™‚åˆ»è¡¨
                        </button>
                    </div>
                </div>
            </article>

            <!-- ä¼‘æ†© -->
            <article class="timeline-item" data-location="ç™½æ¥½å•†åº—è¡—">
                <div class="timeline-card">
                    <div class="status-indicator upcoming">äºˆå®š</div>
                    <time class="time" datetime="17:15/18:30">17:15â€“18:30</time>
                    <h2 class="activity">ç™½æ¥½å•†åº—è¡—ã§ä¼‘æ†©ãƒ»ãƒ¤ãƒŸå¸‚å±‹å°ä¸‹è¦‹</h2>
                    <div class="description">
                        ã€Œå±±ç”°å±‹ã€ã‹ãæ°·ãªã©ã§ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ã€‚
                    </div>
                    <div class="action-buttons">
                        <button class="action-btn map-btn" onclick="showMap('ç™½æ¥½å•†åº—è¡—')">
                            ğŸ“ åœ°å›³
                        </button>
                        <button class="action-btn info-btn" onclick="showShoppingInfo('ç™½æ¥½å•†åº—è¡—')">
                            ï¿½ï¸ åº—èˆ—æƒ…å ±
                        </button>
                    </div>
                </div>
            </article>

            <!-- ã‚¤ãƒ™ãƒ³ãƒˆ4 -->
            <article class="timeline-item event" data-location="å…­è§’æ©‹ãƒ¤ãƒŸå¸‚">
                <div class="timeline-card">
                    <div class="status-indicator upcoming">äºˆå®š</div>
                    <time class="time" datetime="18:30/20:00">18:30â€“20:00</time>
                    <h2 class="activity event">ç¬¬150å› å…­è§’æ©‹ãƒ¤ãƒŸå¸‚</h2>
                    <div class="description">
                        <span class="highlight">18:30â€“21:30</span>ã€‚LIVEç›†è¸Šã‚Šãƒ»å¤šå›½ç±å±‹å°ã€‚19æ™‚å°ãŒæœ€æ··é›‘ã€‚<br>
                        <a href="https://www.hellocycling.jp/time_price/" target="_blank" rel="noopener noreferrer">https://www.hellocycling.jp/time_price/</a>
                    </div>
                    <div class="action-buttons">
                        <button class="action-btn map-btn" onclick="showMap('å…­è§’æ©‹ãƒ¤ãƒŸå¸‚')">
                            ğŸ“ åœ°å›³
                        </button>
                        <button class="action-btn info-btn" onclick="showEventInfo('å…­è§’æ©‹ãƒ¤ãƒŸå¸‚')">
                            ğŸª ã‚¤ãƒ™ãƒ³ãƒˆè©³ç´°
                        </button>
                    </div>
                </div>
            </article>

            <!-- é›»è»Šç§»å‹•2 -->
            <article class="timeline-item" data-location="ç™½æ¥½é§…">
                <div class="timeline-card">
                    <div class="status-indicator upcoming">äºˆå®š</div>
                    <time class="time" datetime="20:05/20:30">20:05â€“20:30</time>
                    <h2 class="activity">é›»è»Šï¼šç™½æ¥½ â†’ æ¸‹è°·<span class="badge">ç´„25åˆ†ãƒ»IC 290å††</span></h2>
                    <div class="description">
                        æ±æ€¥æ±æ¨ªç·šç‰¹æ€¥ã€‚ä¹—æ›ãªã—ã€‚
                    </div>
                    <div class="action-buttons">
                        <button class="action-btn map-btn" onclick="showMap('ç™½æ¥½é§…')">
                            ğŸ“ åœ°å›³
                        </button>
                        <button class="action-btn info-btn" onclick="showTrainInfo('ç™½æ¥½-æ¸‹è°·')">
                            ğŸš† æ™‚åˆ»è¡¨
                        </button>
                    </div>
                </div>
            </article>

            <!-- åˆ°ç€ -->
            <article class="timeline-item" data-location="æ¸‹è°·é§…">
                <div class="timeline-card">
                    <div class="status-indicator upcoming">äºˆå®š</div>
                    <time class="time" datetime="20:30">20:30</time>
                    <h2 class="activity">æ¸‹è°·é§…ã€€ç€ãƒ»è§£æ•£</h2>
                    <div class="description">
                        é§…æ§‹å†…æ··é›‘ã€‚ã‚¹ãƒˆãƒ¬ãƒƒãƒã§ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ã€‚
                    </div>
                    <div class="action-buttons">
                        <button class="action-btn map-btn" onclick="showMap('æ¸‹è°·é§…')">
                            ğŸ“ åœ°å›³
                        </button>
                        <button class="action-btn info-btn" onclick="showStationInfo('æ¸‹è°·é§…')">
                            â„¹ï¸ é§…æƒ…å ±
                        </button>
                    </div>
                </div>
            </article>
        </main>

        <!-- Map Modal -->
        <div class="map-modal" id="mapModal">
            <div class="map-container">
                <div class="map-header">
                    <h3 id="mapTitle">åœ°å›³</h3>
                    <button class="map-close" onclick="closeMap()">&times;</button>
                </div>
                <div class="map-content" id="mapContent">
                    <div>
                        <p>ğŸ“ åœ°å›³æ©Ÿèƒ½</p>
                        <p>ã“ã®æ©Ÿèƒ½ã§ã¯ä»¥ä¸‹ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ï¼š</p>
                        <ul style="text-align: left; margin: 10px 0;">
                            <li>é¸æŠã—ãŸå ´æ‰€ã®åœ°å›³</li>
                            <li>å‘¨è¾ºã®æ–½è¨­æƒ…å ±</li>
                            <li>æœ€é©ãªãƒ«ãƒ¼ãƒˆæ¡ˆå†…</li>
                            <li>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ äº¤é€šæƒ…å ±</li>
                        </ul>
                        <p><small>å®Ÿéš›ã®å®Ÿè£…ã§ã¯ã€Google Maps APIã‚„Mapbox APIã‚’ä½¿ç”¨ã—ã¦<br>ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãªåœ°å›³ã‚’è¡¨ç¤ºã§ãã¾ã™ã€‚</small></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notification Container -->
        <div class="notification" id="notification"></div>
    </div>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let currentDelay = 0;
        let completedItems = new Set();
        let currentItem = 0;
        let weatherData = null;
        let locationPermission = false;
        
        // PWAé–¢é€£å¤‰æ•°
        let deferredPrompt;
        let isOnline = navigator.onLine;
        let swRegistration = null;
        
        // IndexedDBè¨­å®šï¼ˆå®Ÿè²»è¨˜éŒ²ç”¨ï¼‰
        let db = null;
        const DB_NAME = 'YokohamaTravelDB';
        const DB_VERSION = 1;
        
        // APIè¨­å®š
        const API_CONFIG = {
            weather: {
                // ç„¡æ–™ã®å¤©æ°—æƒ…å ±ã‚µãƒ¼ãƒ“ã‚¹ï¼ˆä¼šå“¡ç™»éŒ²ä¸è¦ï¼‰
                baseUrl: 'https://wttr.in/',
                fallbackUrl: 'https://api.open-meteo.com/v1/forecast'
            },
            events: {
                // å…¬é–‹RSS/JSONãƒ•ã‚£ãƒ¼ãƒ‰
                baseUrl: 'https://www.city.yokohama.lg.jp/',
                rssFeeds: [
                    'https://www.city.yokohama.lg.jp/eventinfo/rss.xml',
                    'https://akarenga.jp/rss/'
                ]
            },
            traffic: {
                // å…¬é–‹äº¤é€šæƒ…å ±
                baseUrl: 'https://transit.yahoo.co.jp/',
                publicFeeds: [
                    'https://www.jreast.co.jp/traininfo/rss.xml'
                ]
            },
            // ç°¡å˜ã«ç™»éŒ²ã§ãã‚‹ã‚µãƒ¼ãƒ“ã‚¹ï¼ˆæ¨å¥¨ï¼‰
            openweather: {
                // OpenWeatherMap - ç°¡å˜ãªç„¡æ–™ç™»éŒ²ã§APIã‚­ãƒ¼å–å¾—å¯èƒ½
                key: '', // ã“ã“ã«APIã‚­ãƒ¼ã‚’è¨­å®š
                baseUrl: 'https://api.openweathermap.org/data/2.5/'
            }
        };
        
        /*
        =====================================================
        ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ©Ÿèƒ½ã®è¨­å®šæ–¹æ³•ï¼ˆ2025å¹´å¯¾å¿œç‰ˆï¼‰
        =====================================================
        
        ã€ä¼šå“¡ç™»éŒ²ä¸è¦ã§ã™ãã«ä½¿ãˆã‚‹æ©Ÿèƒ½ã€‘
        
        1. å¤©æ°—æƒ…å ±
           âœ… Open-Meteo APIï¼ˆå®Œå…¨ç„¡æ–™ãƒ»ç™»éŒ²ä¸è¦ï¼‰
           - https://open-meteo.com/
           - ç¾åœ¨æ—¢ã«å®Ÿè£…æ¸ˆã¿ã€ã™ãã«åˆ©ç”¨å¯èƒ½
           
           âœ… wttr.inï¼ˆãƒ†ã‚­ã‚¹ãƒˆãƒ™ãƒ¼ã‚¹å¤©æ°—APIï¼‰
           - https://wttr.in/
           - ç¾åœ¨æ—¢ã«å®Ÿè£…æ¸ˆã¿ã€ã™ãã«åˆ©ç”¨å¯èƒ½
        
        2. ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±
           âœ… å…¬é–‹ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ‡ãƒ¼ã‚¿ï¼ˆç™»éŒ²ä¸è¦ï¼‰
           - æ—¢å­˜ã®é–‹å‚¬ãƒ‘ã‚¿ãƒ¼ãƒ³ã‹ã‚‰è‡ªå‹•åˆ¤å®š
           - å…¬å¼ã‚µã‚¤ãƒˆã¸ã®ãƒªãƒ³ã‚¯æä¾›
           
        3. äº¤é€šæƒ…å ±
           âœ… å…¬é–‹ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¨å®šï¼ˆç™»éŒ²ä¸è¦ï¼‰
           - æ™‚é–“å¸¯ãƒ»å¤©å€™ãƒ»æ›œæ—¥ã«ã‚ˆã‚‹é…å»¶å‚¾å‘æ¨å®š
           - å„äº¤é€šæ©Ÿé–¢ã®å…¬å¼ã‚µã‚¤ãƒˆã¸ã®ãƒªãƒ³ã‚¯
        
        ã€ç°¡å˜ç™»éŒ²ï¼ˆ5åˆ†ç¨‹åº¦ï¼‰ã§å¤§å¹…æ”¹å–„ã§ãã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã€‘
        
        1. OpenWeatherMapï¼ˆæ¨å¥¨ï¼‰
           - ç„¡æ–™ãƒ—ãƒ©ãƒ³: 1,000å›/æ—¥ã®APIå‘¼ã³å‡ºã—
           - ç™»éŒ²æ‰‹é †:
             â‘  https://openweathermap.org/ ã«ã‚¢ã‚¯ã‚»ã‚¹
             â‘¡ ã€ŒSign Upã€ã§ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ
             â‘¢ API Keysãƒšãƒ¼ã‚¸ã§ã‚­ãƒ¼ã‚’ã‚³ãƒ”ãƒ¼
             â‘£ ä¸‹è¨˜ã®API_CONFIG.openweather.keyã«è²¼ã‚Šä»˜ã‘
        
        2. Google Maps Platform
           - æœˆ300ãƒ‰ãƒ«åˆ†ã®ç„¡æ–™ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ
           - åœ°å›³ãƒ»äº¤é€šæƒ…å ±ãƒ»å–¶æ¥­æ™‚é–“ãŒå¤§å¹…æ”¹å–„
        
        3. Yahoo! API
           - æ—¥æœ¬ã®äº¤é€šæƒ…å ±ã«ç‰¹åŒ–
           - ç„¡æ–™ãƒ—ãƒ©ãƒ³ã‚ã‚Š
        
        ã€ä½¿ç”¨æ–¹æ³•ã€‘
        - ç¾åœ¨ã®è¨­å®šã§ã‚‚åŸºæœ¬æ©Ÿèƒ½ã¯å‹•ä½œã—ã¾ã™
        - ã‚ˆã‚Šæ­£ç¢ºãªæƒ…å ±ãŒå¿…è¦ãªå ´åˆã®ã¿ã€ä¸Šè¨˜APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„
        
        =====================================================
        */
        
        // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ‡ãƒ¼ã‚¿ã‚­ãƒ£ãƒƒã‚·ãƒ¥
        let realtimeCache = {
            weather: { data: null, timestamp: 0, ttl: 600000 }, // 10åˆ†ã‚­ãƒ£ãƒƒã‚·ãƒ¥
            events: { data: null, timestamp: 0, ttl: 1800000 }, // 30åˆ†ã‚­ãƒ£ãƒƒã‚·ãƒ¥
            traffic: { data: null, timestamp: 0, ttl: 300000 }  // 5åˆ†ã‚­ãƒ£ãƒƒã‚·ãƒ¥
        };

        // ã‚¹ãƒ ãƒ¼ã‚ºã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã®å®Ÿè£…
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            
            // å¤–éƒ¨ãƒªãƒ³ã‚¯ã®å®‰å…¨ãªå‡¦ç†
            const externalLinks = document.querySelectorAll('a[href^="http"]');
            externalLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    // ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤ºï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
                    // if (!confirm('å¤–éƒ¨ã‚µã‚¤ãƒˆã«ç§»å‹•ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) {
                    //     e.preventDefault();
                    // }
                });
            });

            // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³å¯¾å¿œ
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Tab') {
                    document.body.classList.add('keyboard-navigation');
                }
            });

            document.addEventListener('mousedown', function() {
                document.body.classList.remove('keyboard-navigation');
            });

            // ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚¢ã‚¤ãƒ†ãƒ ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
            const timelineItems = document.querySelectorAll('.timeline-item');
            timelineItems.forEach((item, index) => {
                item.addEventListener('click', function() {
                    toggleItemCompletion(index);
                });
            });

            // è‡ªå‹•æ›´æ–°ã‚¿ã‚¤ãƒãƒ¼
            setInterval(updateCurrentTime, 60000); // 1åˆ†ã”ã¨ã«æ›´æ–°
            
            // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚µã‚¤ã‚ºå¤‰æ›´æ™‚ã®å‡¦ç†
            window.addEventListener('resize', handleWindowResize);
        });
        
        // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚µã‚¤ã‚ºå¤‰æ›´æ™‚ã®å‡¦ç†
        function handleWindowResize() {
            // å¤©æ°—æƒ…å ±ã®é…ç½®ã‚’æ›´æ–°
            if (realtimeCache.weather.data) {
                addWeatherToTimelineItems(realtimeCache.weather.data);
            }
        }

        // åˆæœŸåŒ–æ™‚ã«ãƒ‡ãƒ¼ã‚¿å–å¾—é–‹å§‹é€šçŸ¥ã‚’è¡¨ç¤º
        function initializeApp() {
            loadSavedData();
            updateProgress();
            updateCurrentItem();
            requestLocationPermission();
            
            // PWAåˆæœŸåŒ–
            initializePWA();
            
            // IndexedDBåˆæœŸåŒ–
            initializeDatabase();
            
            // ã‚²ãƒ¼ãƒ çŠ¶æ…‹èª­ã¿è¾¼ã¿
            loadGameState();
            
            // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰è¨­å®šèª­ã¿è¾¼ã¿
            setTimeout(loadDarkMode, 100);
            
            // å†™çœŸãƒœã‚¿ãƒ³è¿½åŠ 
            addPhotoButtonsToTimeline();
            
            // è¨­å®šçŠ¶æ³ã‚’è¡¨ç¤º
            showConfigurationStatus();
            
            // ã‚²ãƒ¼ãƒŸãƒ•ã‚£ã‚±ãƒ¼ã‚·ãƒ§ãƒ³è¦ç´ ã‚’ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ«ã«è¿½åŠ 
            addGameElementsToPanel();
            
            // ãƒ‡ãƒ¼ã‚¿å–å¾—é–‹å§‹
            getWeatherData();
            checkEventStatus();
            checkBusinessHours();
            startRealtimeUpdates();
            addEmergencyInfoSection();
            
            // åˆå›ãƒ‡ãƒ¼ã‚¿å–å¾—å®Œäº†é€šçŸ¥
            setTimeout(() => {
                showNotification('ğŸš€ æ¨ªæµœæ—…è¡Œã‚¢ãƒ—ãƒªæº–å‚™å®Œäº†ï¼', 'success');
                
                // ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¡¨ç¤º
                setTimeout(() => {
                    showInstallPrompt();
                }, 3000);
                
                // é–‹å§‹ã‚¹ã‚¿ãƒ³ãƒ—ç²å¾—ãƒã‚§ãƒƒã‚¯
                if (!gameState.stamps.has('shibuya_start')) {
                    setTimeout(() => {
                        collectStamp('shibuya_start', 'æ¸‹è°·é§…');
                    }, 5000);
                }
            }, 2000);
        }
        
        // ã‚²ãƒ¼ãƒ è¦ç´ ã‚’ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ«ã«è¿½åŠ 
        function addGameElementsToPanel() {
            const controlPanel = document.getElementById('controlPanel');
            const gameSection = document.createElement('div');
            gameSection.style.marginBottom = 'var(--spacing-md)';
            
            gameSection.innerHTML = `
                <h3>ğŸ® æ—…è¡Œã‚²ãƒ¼ãƒ </h3>
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px; border-radius: 8px; text-align: center; margin-bottom: 8px;">
                    <div style="font-size: 16px; font-weight: bold;">Lv.${gameState.level}</div>
                    <div style="font-size: 20px; margin: 4px 0;">${gameState.points} ãƒã‚¤ãƒ³ãƒˆ</div>
                    <div style="font-size: 12px; opacity: 0.9;">ã‚¹ã‚¿ãƒ³ãƒ— ${gameState.stamps.size}å€‹ / å®Ÿç¸¾ ${gameState.achievements.length}å€‹</div>
                </div>
                <div style="display: flex; gap: 4px;">
                    <button class="time-btn" onclick="showGameStatus()" style="flex: 1; font-size: 11px;">
                        ğŸ† å®Ÿç¸¾ç¢ºèª
                    </button>
                    <button class="time-btn" onclick="showPhotoGallery()" style="flex: 1; font-size: 11px;">
                        ğŸ“· ã‚®ãƒ£ãƒ©ãƒªãƒ¼
                    </button>
                </div>
            `;
            
            // ä½ç½®è¿½è·¡ãƒœã‚¿ãƒ³ã‚‚è¿½åŠ 
            const locationSection = document.createElement('div');
            locationSection.style.marginTop = 'var(--spacing-sm)';
            locationSection.innerHTML = `
                <button class="time-btn" onclick="startLocationTracking()" style="width: 100%; font-size: 11px; background: var(--accent-color);">
                    ğŸ—ºï¸ ãƒ«ãƒ¼ãƒˆè¿½å¾“é–‹å§‹
                </button>
            `;
            gameSection.appendChild(locationSection);
            
            // å…ˆé ­è¿‘ãã«æŒ¿å…¥ï¼ˆè¨­å®šçŠ¶æ³ã®å¾Œï¼‰
            const firstChild = controlPanel.children[1]; // è¨­å®šçŠ¶æ³ãŒ[0]ãªã®ã§[1]ã®ä½ç½®
            if (firstChild) {
                controlPanel.insertBefore(gameSection, firstChild);
            } else {
                controlPanel.appendChild(gameSection);
            }
        }
        
        // è¨­å®šçŠ¶æ³ã®è¡¨ç¤º
        function showConfigurationStatus() {
            const hasOpenWeatherKey = API_CONFIG.openweather.key && API_CONFIG.openweather.key.length > 10;
            
            let statusMessage = 'ğŸŒ ä¼šå“¡ç™»éŒ²ä¸è¦ã®APIã‚’ä½¿ç”¨ä¸­';
            let statusType = 'info';
            
            if (hasOpenWeatherKey) {
                statusMessage = 'ğŸ”‘ OpenWeatherMap APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã™';
                statusType = 'success';
            }
            
            // PWAçŠ¶æ…‹ã‚‚ãƒã‚§ãƒƒã‚¯
            const isPWA = window.matchMedia('(display-mode: standalone)').matches || 
                          window.navigator.standalone === true;
            
            if (isPWA) {
                statusMessage += ' (PWAãƒ¢ãƒ¼ãƒ‰)';
            }
            
            // ã‚ªãƒ•ãƒ©ã‚¤ãƒ³çŠ¶æ…‹ã‚‚è¡¨ç¤º
            if (!isOnline) {
                statusMessage += ' [ã‚ªãƒ•ãƒ©ã‚¤ãƒ³]';
                statusType = 'warning';
            }
            
            // è¨­å®šçŠ¶æ³ã‚’ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ«ã«è¡¨ç¤º
            setTimeout(() => {
                const controlPanel = document.getElementById('controlPanel');
                const statusSection = document.createElement('div');
                statusSection.style.marginBottom = 'var(--spacing-md)';
                statusSection.innerHTML = `
                    <h3>ğŸ”§ ã‚¢ãƒ—ãƒªè¨­å®šçŠ¶æ³</h3>
                    <div style="font-size: 12px; padding: 8px; background: ${statusType === 'success' ? '#d4edda' : statusType === 'warning' ? '#fff3cd' : '#cce5ff'}; border-radius: 4px; margin-bottom: 8px;">
                        ${statusMessage}
                    </div>
                    <div style="display: flex; gap: 4px;">
                        <button class="time-btn" onclick="showSetupGuide()" style="flex: 1; font-size: 11px;">
                            ğŸ“– è¨­å®šã‚¬ã‚¤ãƒ‰
                        </button>
                        <button class="time-btn" onclick="showPWAInfo()" style="flex: 1; font-size: 11px;">
                            ğŸ“± PWAæƒ…å ±
                        </button>
                    </div>
                `;
                
                // å…ˆé ­ã«æŒ¿å…¥
                if (controlPanel.firstChild) {
                    controlPanel.insertBefore(statusSection, controlPanel.firstChild);
                } else {
                    controlPanel.appendChild(statusSection);
                }
            }, 1000);
        }
        
        // PWAåˆæœŸåŒ–
        function initializePWA() {
            // Service Workerç™»éŒ²
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(registration => {
                        console.log('Service Workerç™»éŒ²æˆåŠŸ:', registration);
                        swRegistration = registration;
                        
                        // ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆãƒã‚§ãƒƒã‚¯
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    showUpdateNotification();
                                }
                            });
                        });
                    })
                    .catch(error => {
                        console.error('Service Workerç™»éŒ²å¤±æ•—:', error);
                    });
            }
            
            // ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æº–å‚™
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                console.log('ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæº–å‚™å®Œäº†');
            });
            
            // ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å®Œäº†æ¤œçŸ¥
            window.addEventListener('appinstalled', () => {
                showNotification('ã‚¢ãƒ—ãƒªãŒãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã•ã‚Œã¾ã—ãŸï¼', 'success');
                deferredPrompt = null;
            });
            
            // ã‚ªãƒ³ãƒ©ã‚¤ãƒ³/ã‚ªãƒ•ãƒ©ã‚¤ãƒ³çŠ¶æ…‹ç›£è¦–
            window.addEventListener('online', () => {
                isOnline = true;
                showNotification('ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã«å¾©å¸°ã—ã¾ã—ãŸ', 'success');
                updateOnlineStatus();
            });
            
            window.addEventListener('offline', () => {
                isOnline = false;
                showNotification('ã‚ªãƒ•ãƒ©ã‚¤ãƒ³çŠ¶æ…‹ã§ã™', 'warning');
                updateOnlineStatus();
            });
            
            // PWAã®è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰æ¤œçŸ¥
            const isPWA = window.matchMedia('(display-mode: standalone)').matches;
            if (isPWA) {
                document.body.classList.add('pwa-mode');
                console.log('PWAãƒ¢ãƒ¼ãƒ‰ã§å®Ÿè¡Œä¸­');
            }
        }
        
        // ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¡¨ç¤º
        function showInstallPrompt() {
            // æ—¢ã«PWAãƒ¢ãƒ¼ãƒ‰ã¾ãŸã¯ãƒ¢ãƒã‚¤ãƒ«ã§ãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
            if (window.matchMedia('(display-mode: standalone)').matches || 
                !window.matchMedia('(max-width: 768px)').matches) {
                return;
            }
            
            const installBanner = document.createElement('div');
            installBanner.style.cssText = `
                position: fixed;
                bottom: 20px;
                left: 20px;
                right: 20px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 16px;
                border-radius: 12px;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
                z-index: 1002;
                display: flex;
                align-items: center;
                justify-content: space-between;
                animation: slideUpBanner 0.5s ease-out;
            `;
            
            installBanner.innerHTML = `
                <div style="flex: 1;">
                    <div style="font-weight: bold; margin-bottom: 4px;">ğŸ“± ã‚¢ãƒ—ãƒªã¨ã—ã¦è¿½åŠ </div>
                    <div style="font-size: 14px; opacity: 0.9;">ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã—ã¦ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã§ã‚‚åˆ©ç”¨</div>
                </div>
                <div style="display: flex; gap: 8px;">
                    <button onclick="installPWA()" style="
                        background: rgba(255, 255, 255, 0.2);
                        border: 1px solid rgba(255, 255, 255, 0.3);
                        color: white;
                        padding: 8px 16px;
                        border-radius: 6px;
                        font-size: 14px;
                        cursor: pointer;
                    ">è¿½åŠ </button>
                    <button onclick="this.closest('div').remove()" style="
                        background: none;
                        border: none;
                        color: white;
                        font-size: 18px;
                        cursor: pointer;
                        padding: 4px;
                    ">Ã—</button>
                </div>
            `;
            
            document.body.appendChild(installBanner);
            
            // 15ç§’å¾Œã«è‡ªå‹•ã§æ¶ˆå»
            setTimeout(() => {
                if (installBanner.parentNode) {
                    installBanner.remove();
                }
            }, 15000);
        }
        
        // PWAã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å®Ÿè¡Œ
        function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('PWAã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ‰¿èª');
                    } else {
                        console.log('PWAã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ‹’å¦');
                    }
                    deferredPrompt = null;
                });
            } else {
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šæ‰‹å‹•ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚¬ã‚¤ãƒ‰
                showManualInstallGuide();
            }
        }
        
        // æ‰‹å‹•ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚¬ã‚¤ãƒ‰
        function showManualInstallGuide() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0, 0, 0, 0.8); z-index: 1000;
                display: flex; align-items: center; justify-content: center;
            `;
            
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            const isAndroid = /Android/.test(navigator.userAgent);
            
            let instructions = '';
            if (isIOS) {
                instructions = `
                    <ol style="text-align: left; padding-left: 20px;">
                        <li>ç”»é¢ä¸‹éƒ¨ã®å…±æœ‰ãƒœã‚¿ãƒ³ <span style="font-size: 18px;">â¯</span> ã‚’ã‚¿ãƒƒãƒ—</li>
                        <li>ã€Œãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã€ã‚’é¸æŠ</li>
                        <li>ã€Œè¿½åŠ ã€ã‚’ã‚¿ãƒƒãƒ—ã—ã¦å®Œäº†</li>
                    </ol>
                `;
            } else if (isAndroid) {
                instructions = `
                    <ol style="text-align: left; padding-left: 20px;">
                        <li>ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆâ‹®ï¼‰ã‚’ã‚¿ãƒƒãƒ—</li>
                        <li>ã€Œãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã€ã‚’é¸æŠ</li>
                        <li>ã€Œè¿½åŠ ã€ã‚’ã‚¿ãƒƒãƒ—ã—ã¦å®Œäº†</li>
                    </ol>
                `;
            } else {
                instructions = `
                    <div style="text-align: center;">
                        ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ç‰ˆChromeã‚’ã”åˆ©ç”¨ã®å ´åˆã€<br>
                        ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼ã®å³å´ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚¢ã‚¤ã‚³ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
                    </div>
                `;
            }
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: white; border-radius: 12px; padding: 24px;
                max-width: 400px; margin: 20px; text-align: center;
            `;
            
            content.innerHTML = `
                <h3 style="margin: 0 0 16px 0; color: var(--primary-color);">ğŸ“± ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ </h3>
                <p style="margin-bottom: 20px; color: var(--text-muted);">
                    ã‚¢ãƒ—ãƒªã®ã‚ˆã†ã«ã”åˆ©ç”¨ã„ãŸã ã‘ã¾ã™
                </p>
                ${instructions}
                <button onclick="this.closest('div').remove()" style="
                    margin-top: 20px; padding: 10px 24px;
                    background: var(--secondary-color); color: white;
                    border: none; border-radius: 6px; cursor: pointer;
                ">é–‰ã˜ã‚‹</button>
            `;
            
            modal.appendChild(content);
            modal.className = 'modal';
            document.body.appendChild(modal);
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
        }
        
        // PWAæƒ…å ±è¡¨ç¤º
        function showPWAInfo() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0, 0, 0, 0.8); z-index: 1000;
                display: flex; align-items: center; justify-content: center;
            `;
            
            const isPWA = window.matchMedia('(display-mode: standalone)').matches;
            const hasServiceWorker = 'serviceWorker' in navigator && swRegistration;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: white; border-radius: 8px; padding: 20px;
                max-width: 500px; max-height: 80vh; overflow-y: auto; margin: 20px;
            `;
            
            content.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0; color: var(--primary-color);">ğŸ“± PWAæ©Ÿèƒ½çŠ¶æ³</h3>
                    <button onclick="this.closest('.modal').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
                </div>
                
                <div style="space-y: 12px;">
                    <div style="display: flex; align-items: center; margin-bottom: 12px;">
                        <span style="margin-right: 8px;">${isPWA ? 'âœ…' : 'âºï¸'}</span>
                        <span>PWAãƒ¢ãƒ¼ãƒ‰: ${isPWA ? 'æœ‰åŠ¹' : 'ç„¡åŠ¹'}</span>
                    </div>
                    
                    <div style="display: flex; align-items: center; margin-bottom: 12px;">
                        <span style="margin-right: 8px;">${hasServiceWorker ? 'âœ…' : 'âŒ'}</span>
                        <span>Service Worker: ${hasServiceWorker ? 'ç™»éŒ²æ¸ˆã¿' : 'æœªç™»éŒ²'}</span>
                    </div>
                    
                    <div style="display: flex; align-items: center; margin-bottom: 12px;">
                        <span style="margin-right: 8px;">${isOnline ? 'ğŸŸ¢' : 'ğŸ”´'}</span>
                        <span>ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯: ${isOnline ? 'ã‚ªãƒ³ãƒ©ã‚¤ãƒ³' : 'ã‚ªãƒ•ãƒ©ã‚¤ãƒ³'}</span>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; margin: 16px 0;">
                        <h4 style="margin: 0 0 8px 0;">PWAæ©Ÿèƒ½</h4>
                        <ul style="margin: 0; padding-left: 20px; font-size: 14px;">
                            <li>ã‚ªãƒ•ãƒ©ã‚¤ãƒ³å¯¾å¿œï¼ˆãƒ‡ãƒ¼ã‚¿ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰</li>
                            <li>ãƒ›ãƒ¼ãƒ ç”»é¢ã¸ã®ã‚¢ãƒ—ãƒªè¿½åŠ </li>
                            <li>ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥å¯¾å¿œ</li>
                            <li>ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰åŒæœŸ</li>
                            <li>ã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥ã‚¹ã‚¯ãƒªãƒ¼ãƒ³è¡¨ç¤º</li>
                        </ul>
                    </div>
                    
                    <div style="display: flex; gap: 8px; margin-top: 16px;">
                        ${!isPWA ? `<button onclick="showManualInstallGuide(); this.closest('.modal').remove();" style="flex: 1; padding: 8px; background: var(--secondary-color); color: white; border: none; border-radius: 4px; cursor: pointer;">ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«</button>` : ''}
                        <button onclick="updateCacheData()" style="flex: 1; padding: 8px; background: var(--accent-color); color: white; border: none; border-radius: 4px; cursor: pointer;">ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ›´æ–°</button>
                    </div>
                </div>
            `;
            
            modal.appendChild(content);
            modal.className = 'modal';
            document.body.appendChild(modal);
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
        }
        
        // ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ›´æ–°
        function updateCacheData() {
            if (swRegistration) {
                swRegistration.update().then(() => {
                    showNotification('ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'success');
                }).catch(() => {
                    showNotification('ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ', 'warning');
                });
            }
            
            // æ‰‹å‹•ã§ã®ãƒ‡ãƒ¼ã‚¿æ›´æ–°
            clearCache();
            getWeatherData();
            checkEventStatus();
            checkBusinessHours();
        }
        
        // ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆé€šçŸ¥
        function showUpdateNotification() {
            const updateBanner = document.createElement('div');
            updateBanner.style.cssText = `
                position: fixed; top: 20px; left: 20px; right: 20px;
                background: var(--secondary-color); color: white;
                padding: 12px 16px; border-radius: 8px; z-index: 1001;
                display: flex; align-items: center; justify-content: space-between;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            `;
            
            updateBanner.innerHTML = `
                <span>æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒåˆ©ç”¨å¯èƒ½ã§ã™</span>
                <button onclick="reloadApp()" style="
                    background: rgba(255, 255, 255, 0.2); border: 1px solid rgba(255, 255, 255, 0.3);
                    color: white; padding: 6px 12px; border-radius: 4px; cursor: pointer;
                ">æ›´æ–°</button>
            `;
            
            document.body.appendChild(updateBanner);
            
            setTimeout(() => {
                if (updateBanner.parentNode) {
                    updateBanner.remove();
                }
            }, 10000);
        }
        
        // ã‚¢ãƒ—ãƒªå†èª­ã¿è¾¼ã¿
        function reloadApp() {
            if (swRegistration && swRegistration.waiting) {
                swRegistration.waiting.postMessage({ type: 'SKIP_WAITING' });
                window.location.reload();
            }
        }
        
        // ã‚ªãƒ³ãƒ©ã‚¤ãƒ³çŠ¶æ…‹æ›´æ–°
        function updateOnlineStatus() {
            const statusElements = document.querySelectorAll('.online-status');
            statusElements.forEach(element => {
                element.textContent = isOnline ? 'ã‚ªãƒ³ãƒ©ã‚¤ãƒ³' : 'ã‚ªãƒ•ãƒ©ã‚¤ãƒ³';
                element.className = `online-status ${isOnline ? 'online' : 'offline'}`;
            });
        }
        
        // IndexedDBåˆæœŸåŒ–
        function initializeDatabase() {
            const request = indexedDB.open(DB_NAME, DB_VERSION);
            
            request.onerror = () => {
                console.error('IndexedDBé–‹ã‘ã¾ã›ã‚“ã§ã—ãŸ');
            };
            
            request.onsuccess = (event) => {
                db = event.target.result;
                console.log('IndexedDBåˆæœŸåŒ–å®Œäº†');
            };
            
            request.onupgradeneeded = (event) => {
                db = event.target.result;
                
                // å®Ÿè²»è¨˜éŒ²ã‚¹ãƒˆã‚¢
                const expenseStore = db.createObjectStore('expenses', { keyPath: 'id', autoIncrement: true });
                expenseStore.createIndex('date', 'date', { unique: false });
                expenseStore.createIndex('category', 'category', { unique: false });
                expenseStore.createIndex('location', 'location', { unique: false });
                
                // å†™çœŸãƒ­ã‚°ã‚¹ãƒˆã‚¢  
                const photoStore = db.createObjectStore('photos', { keyPath: 'id', autoIncrement: true });
                photoStore.createIndex('timestamp', 'timestamp', { unique: false });
                photoStore.createIndex('location', 'location', { unique: false });
                
                // ã‚²ãƒ¼ãƒŸãƒ•ã‚£ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ãƒˆã‚¢
                const achievementStore = db.createObjectStore('achievements', { keyPath: 'id', autoIncrement: true });
                achievementStore.createIndex('timestamp', 'timestamp', { unique: false });
                achievementStore.createIndex('type', 'type', { unique: false });
                
                console.log('IndexedDBæ§‹é€ ä½œæˆå®Œäº†');
            };
        }
        
        // å®Ÿè²»è¨˜éŒ²æ©Ÿèƒ½
        function addExpenseRecord(category, amount, location, description, receiptImage = null) {
            if (!db) {
                console.error('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }
            
            const transaction = db.transaction(['expenses'], 'readwrite');
            const store = transaction.objectStore('expenses');
            
            const expense = {
                date: new Date().toISOString(),
                category: category,
                amount: parseInt(amount),
                location: location,
                description: description,
                receiptImage: receiptImage,
                timestamp: Date.now()
            };
            
            const request = store.add(expense);
            
            request.onsuccess = () => {
                console.log('å®Ÿè²»è¨˜éŒ²è¿½åŠ :', expense);
                updateExpenseDisplay();
                showNotification(`${category}: Â¥${amount.toLocaleString()} ã‚’è¨˜éŒ²ã—ã¾ã—ãŸ`, 'success');
            };
            
            request.onerror = () => {
                console.error('å®Ÿè²»è¨˜éŒ²å¤±æ•—');
                showNotification('è¨˜éŒ²ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            };
        }
        
        // å®Ÿè²»è¨˜éŒ²è¡¨ç¤ºã®æ›´æ–°
        function updateExpenseDisplay() {
            if (!db) return;
            
            const transaction = db.transaction(['expenses'], 'readonly');
            const store = transaction.objectStore('expenses');
            const request = store.getAll();
            
            request.onsuccess = (event) => {
                const expenses = event.target.result;
                const today = new Date().toISOString().split('T')[0];
                const todayExpenses = expenses.filter(expense => 
                    expense.date.startsWith(today)
                );
                
                // åˆè¨ˆè¨ˆç®—
                const totalActual = todayExpenses.reduce((sum, expense) => sum + expense.amount, 0);
                const totalBudget = 5510; // æ¦‚ç®—äºˆç®—
                const difference = totalActual - totalBudget;
                
                // ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ«ã®è²»ç”¨ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’æ›´æ–°
                updateCostSection(todayExpenses, totalActual, totalBudget, difference);
            };
        }
        
        // è²»ç”¨ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®æ›´æ–°
        function updateCostSection(expenses, totalActual, totalBudget, difference) {
            const costSection = document.querySelector('.cost-section');
            if (!costSection) return;
            
            const expensesByCategory = expenses.reduce((acc, expense) => {
                if (!acc[expense.category]) acc[expense.category] = 0;
                acc[expense.category] += expense.amount;
                return acc;
            }, {});
            
            costSection.innerHTML = `
                <div style="margin-bottom: 12px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="font-weight: bold;">ğŸ“Š å®Ÿè²» vs æ¦‚ç®—</span>
                        <button class="time-btn" onclick="showExpenseForm()" style="padding: 2px 6px; font-size: 10px;">
                            â• è¿½åŠ 
                        </button>
                    </div>
                    
                    <div style="margin-bottom: 8px;">
                        <div class="cost-item">
                            <span>æ¦‚ç®—äºˆç®—ï¼š</span>
                            <span>Â¥${totalBudget.toLocaleString()}</span>
                        </div>
                        <div class="cost-item">
                            <span>å®Ÿéš›ã®æ”¯å‡ºï¼š</span>
                            <span style="color: ${difference > 0 ? '#e74c3c' : '#27ae60'};">Â¥${totalActual.toLocaleString()}</span>
                        </div>
                        <div class="cost-item" style="border-top: 1px solid var(--border-color); padding-top: 4px;">
                            <span>å·®é¡ï¼š</span>
                            <span style="color: ${difference > 0 ? '#e74c3c' : '#27ae60'}; font-weight: bold;">
                                ${difference > 0 ? '+' : ''}Â¥${difference.toLocaleString()}
                            </span>
                        </div>
                    </div>
                    
                    ${Object.keys(expensesByCategory).length > 0 ? `
                        <div style="font-size: 11px; margin-top: 8px;">
                            <div style="font-weight: bold; margin-bottom: 4px;">ğŸ“ ä»Šæ—¥ã®è¨˜éŒ²</div>
                            ${Object.entries(expensesByCategory).map(([category, amount]) => `
                                <div style="display: flex; justify-content: space-between; margin-bottom: 2px;">
                                    <span>${category}:</span>
                                    <span>Â¥${amount.toLocaleString()}</span>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                    
                    <div style="margin-top: 8px;">
                        <button class="time-btn" onclick="showExpenseChart()" style="width: 100%; font-size: 11px;">
                            ğŸ“Š è©³ç´°åˆ†æ
                        </button>
                    </div>
                </div>
            `;
        }
        
        // å®Ÿè²»å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ è¡¨ç¤º
        function showExpenseForm() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0, 0, 0, 0.8); z-index: 1000;
                display: flex; align-items: center; justify-content: center;
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: white; border-radius: 8px; padding: 20px;
                max-width: 400px; margin: 20px; width: 100%;
            `;
            
            content.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <h3 style="margin: 0; color: var(--primary-color);">ğŸ’° å®Ÿè²»è¨˜éŒ²</h3>
                    <button onclick="this.closest('.modal').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
                </div>
                
                <form onsubmit="submitExpense(event)" style="space-y: 12px;">
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; margin-bottom: 4px; font-weight: bold;">ã‚«ãƒ†ã‚´ãƒª</label>
                        <select name="category" required style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px;">
                            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                            <option value="äº¤é€šè²»">ğŸšƒ äº¤é€šè²»</option>
                            <option value="è‡ªè»¢è»Šãƒ¬ãƒ³ã‚¿ãƒ«">ğŸš² è‡ªè»¢è»Šãƒ¬ãƒ³ã‚¿ãƒ«</option>
                            <option value="é£Ÿäº‹">ğŸ½ï¸ é£Ÿäº‹</option>
                            <option value="ã‚¤ãƒ™ãƒ³ãƒˆ">ğŸª ã‚¤ãƒ™ãƒ³ãƒˆ</option>
                            <option value="ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°">ğŸ›ï¸ ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°</option>
                            <option value="ãã®ä»–">ğŸ”– ãã®ä»–</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; margin-bottom: 4px; font-weight: bold;">é‡‘é¡ï¼ˆå††ï¼‰</label>
                        <input type="number" name="amount" required min="0" step="1" placeholder="0" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px;">
                    </div>
                    
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; margin-bottom: 4px; font-weight: bold;">å ´æ‰€</label>
                        <input type="text" name="location" placeholder="ä¾‹: æ¨ªæµœé§…" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px;">
                    </div>
                    
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; margin-bottom: 4px; font-weight: bold;">ãƒ¡ãƒ¢</label>
                        <input type="text" name="description" placeholder="ä¾‹: æ˜¼é£Ÿä»£" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px;">
                    </div>
                    
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; margin-bottom: 4px; font-weight: bold;">ãƒ¬ã‚·ãƒ¼ãƒˆç”»åƒï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰</label>
                        <input type="file" name="receipt" accept="image/*" capture="environment" style="width: 100%; padding: 4px; border: 1px solid var(--border-color); border-radius: 4px;">
                    </div>
                    
                    <div style="display: flex; gap: 8px;">
                        <button type="button" onclick="this.closest('.modal').remove()" style="flex: 1; padding: 10px; background: var(--text-muted); color: white; border: none; border-radius: 4px; cursor: pointer;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                        <button type="submit" style="flex: 1; padding: 10px; background: var(--secondary-color); color: white; border: none; border-radius: 4px; cursor: pointer;">è¨˜éŒ²</button>
                    </div>
                </form>
            `;
            
            modal.appendChild(content);
            modal.className = 'modal';
            document.body.appendChild(modal);
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
        }
        
        // å®Ÿè²»è¨˜éŒ²é€ä¿¡
        function submitExpense(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const category = formData.get('category');
            const amount = formData.get('amount');
            const location = formData.get('location');
            const description = formData.get('description');
            const receiptFile = formData.get('receipt');
            
            if (receiptFile && receiptFile.size > 0) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    addExpenseRecord(category, amount, location, description, e.target.result);
                };
                reader.readAsDataURL(receiptFile);
            } else {
                addExpenseRecord(category, amount, location, description);
            }
            
            event.target.closest('.modal').remove();
        }
        
        // è©³ç´°åˆ†æè¡¨ç¤º
        function showExpenseChart() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0, 0, 0, 0.8); z-index: 1000;
                display: flex; align-items: center; justify-content: center;
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: white; border-radius: 8px; padding: 20px;
                max-width: 500px; margin: 20px; width: 100%; max-height: 80vh; overflow-y: auto;
            `;
            
            content.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <h3 style="margin: 0; color: var(--primary-color);">ğŸ“Š æ”¯å‡ºåˆ†æ</h3>
                    <button onclick="this.closest('.modal').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
                </div>
                
                <div id="expenseAnalysis">
                    åˆ†æãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...
                </div>
            `;
            
            modal.appendChild(content);
            modal.className = 'modal';
            document.body.appendChild(modal);
            
            // åˆ†æãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦è¡¨ç¤º
            generateExpenseAnalysis();
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
        }
        
        // æ”¯å‡ºåˆ†æãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ
        function generateExpenseAnalysis() {
            if (!db) return;
            
            const transaction = db.transaction(['expenses'], 'readonly');
            const store = transaction.objectStore('expenses');
            const request = store.getAll();
            
            request.onsuccess = (event) => {
                const expenses = event.target.result;
                const today = new Date().toISOString().split('T')[0];
                const todayExpenses = expenses.filter(expense => 
                    expense.date.startsWith(today)
                );
                
                const analysisContainer = document.getElementById('expenseAnalysis');
                if (!analysisContainer) return;
                
                // äºˆç®—ã¨ã®æ¯”è¼ƒãƒ‡ãƒ¼ã‚¿
                const budgetData = {
                    'HELLO CYCLING': { budget: 850, actual: 0 },
                    'é›»è»Šä»£': { budget: 660, actual: 0 },
                    'é£Ÿäº‹ä»£': { budget: 3000, actual: 0 },
                    'ãã®ä»–': { budget: 1000, actual: 0 }
                };
                
                // å®Ÿè²»ã‚’ã‚«ãƒ†ã‚´ãƒªåˆ¥ã«é›†è¨ˆ
                todayExpenses.forEach(expense => {
                    if (expense.category === 'è‡ªè»¢è»Šãƒ¬ãƒ³ã‚¿ãƒ«') {
                        budgetData['HELLO CYCLING'].actual += expense.amount;
                    } else if (expense.category === 'äº¤é€šè²»') {
                        budgetData['é›»è»Šä»£'].actual += expense.amount;
                    } else if (expense.category === 'é£Ÿäº‹') {
                        budgetData['é£Ÿäº‹ä»£'].actual += expense.amount;
                    } else {
                        budgetData['ãã®ä»–'].actual += expense.amount;
                    }
                });
                
                // ç°¡æ˜“ãƒãƒ£ãƒ¼ãƒˆç”Ÿæˆ
                const chartHTML = Object.entries(budgetData).map(([category, data]) => {
                    const percentage = data.budget > 0 ? (data.actual / data.budget) * 100 : 0;
                    const barColor = percentage > 100 ? '#e74c3c' : percentage > 80 ? '#f39c12' : '#27ae60';
                    
                    return `
                        <div style="margin-bottom: 16px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                <span style="font-weight: bold;">${category}</span>
                                <span style="color: ${percentage > 100 ? '#e74c3c' : '#27ae60'};">
                                    ${percentage.toFixed(1)}%
                                </span>
                            </div>
                            <div style="background: #f8f9fa; border-radius: 4px; height: 20px; position: relative; overflow: hidden;">
                                <div style="
                                    background: ${barColor}; 
                                    height: 100%; 
                                    width: ${Math.min(percentage, 100)}%;
                                    transition: width 0.5s ease;
                                "></div>
                                ${percentage > 100 ? `
                                    <div style="
                                        position: absolute; top: 0; right: 0;
                                        background: #e74c3c; height: 100%;
                                        width: ${Math.min(percentage - 100, 50)}%;
                                        opacity: 0.7;
                                    "></div>
                                ` : ''}
                            </div>
                            <div style="display: flex; justify-content: space-between; font-size: 12px; margin-top: 2px; color: var(--text-muted);">
                                <span>äºˆç®—: Â¥${data.budget.toLocaleString()}</span>
                                <span>å®Ÿè²»: Â¥${data.actual.toLocaleString()}</span>
                            </div>
                        </div>
                    `;
                }).join('');
                
                const totalBudget = Object.values(budgetData).reduce((sum, data) => sum + data.budget, 0);
                const totalActual = Object.values(budgetData).reduce((sum, data) => sum + data.actual, 0);
                const totalDifference = totalActual - totalBudget;
                
                analysisContainer.innerHTML = `
                    <div style="background: ${totalDifference > 0 ? '#fee' : '#efe'}; padding: 12px; border-radius: 6px; margin-bottom: 16px; text-align: center;">
                        <div style="font-size: 18px; font-weight: bold; margin-bottom: 4px;">
                            ${totalDifference > 0 ? 'âš ï¸ äºˆç®—ã‚ªãƒ¼ãƒãƒ¼' : 'âœ… äºˆç®—å†…'}
                        </div>
                        <div style="color: ${totalDifference > 0 ? '#e74c3c' : '#27ae60'};">
                            ${totalDifference > 0 ? '+' : ''}Â¥${totalDifference.toLocaleString()}
                        </div>
                    </div>
                    
                    ${chartHTML}
                    
                    <div style="margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--border-color);">
                        <h4 style="margin: 0 0 8px 0;">ğŸ’¡ ç¯€ç´„ã‚¢ãƒ‰ãƒã‚¤ã‚¹</h4>
                        <div style="font-size: 14px; line-height: 1.6;">
                            ${generateSavingTips(budgetData, totalDifference)}
                        </div>
                    </div>
                `;
            };
        }
        
        // ç¯€ç´„ã‚¢ãƒ‰ãƒã‚¤ã‚¹ç”Ÿæˆ
        function generateSavingTips(budgetData, totalDifference) {
            const tips = [];
            
            if (totalDifference <= 0) {
                tips.push('ğŸ‘ è¨ˆç”»é€šã‚Šã®æ”¯å‡ºã§ã™ï¼ã“ã®èª¿å­ã§ãŠæ¥½ã—ã¿ãã ã•ã„ã€‚');
            } else {
                // æœ€ã‚‚ã‚ªãƒ¼ãƒãƒ¼ã—ã¦ã„ã‚‹ã‚«ãƒ†ã‚´ãƒªã‚’ç‰¹å®š
                const overBudgetCategories = Object.entries(budgetData)
                    .filter(([_, data]) => data.actual > data.budget)
                    .sort((a, b) => (b[1].actual - b[1].budget) - (a[1].actual - a[1].budget));
                
                if (overBudgetCategories.length > 0) {
                    const [topCategory, data] = overBudgetCategories[0];
                    tips.push(`ğŸ¯ ${topCategory}ãŒäºˆç®—ã‚’Â¥${(data.actual - data.budget).toLocaleString()}ã‚ªãƒ¼ãƒãƒ¼ã—ã¦ã„ã¾ã™ã€‚`);
                }
                
                if (budgetData['é£Ÿäº‹ä»£'].actual > budgetData['é£Ÿäº‹ä»£'].budget) {
                    tips.push('ğŸ½ï¸ é£Ÿäº‹ä»£ã‚’æŠ‘ãˆã‚‹ã«ã¯ã€å¸‚å ´ã§ã®è²·ã„é£Ÿã„ã‚„è»½é£Ÿã«å¤‰æ›´ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚');
                }
                
                if (budgetData['ãã®ä»–'].actual > budgetData['ãã®ä»–'].budget) {
                    tips.push('ğŸ›ï¸ ãŠåœŸç”£ä»£ã¯æœ€å¾Œã«ã¾ã¨ã‚ã¦è³¼å…¥ã™ã‚‹ã¨ç„¡é§„é£ã„ã‚’é˜²ã’ã¾ã™ã€‚');
                }
            }
            
            if (tips.length === 0) {
                tips.push('ğŸ“ˆ ä»Šå¾Œã®å‚è€ƒã®ãŸã‚ã€è¨˜éŒ²ã‚’ç¶šã‘ã¦ãã ã•ã„ï¼');
            }
            
            return tips.join('<br>');
        }
        
        // ãƒ«ãƒ¼ãƒˆè¿½å¾“å‹ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥æ©Ÿèƒ½
        let watchPositionId = null;
        let notificationPermission = false;
        let lastNotificationTime = {};
        const NOTIFICATION_COOLDOWN = 60000; // 1åˆ†é–“ã®ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³
        
        // å„åœ°ç‚¹ã®åº§æ¨™ãƒ‡ãƒ¼ã‚¿ï¼ˆå®Ÿéš›ã®åº§æ¨™ï¼‰
        const LOCATION_COORDINATES = {
            'æ¸‹è°·é§…': { lat: 35.6580, lng: 139.7016, name: 'HELLO CYCLING ãƒ¬ãƒ³ã‚¿ãƒ«é–‹å§‹' },
            'æ¨ªæµœå¸‚ä¸­å¤®å¸å£²å¸‚å ´': { lat: 35.4437, lng: 139.6231, name: 'æ°´ç”£ä»²å¸æ£Ÿ ä¸€èˆ¬é–‹æ”¾' },
            'å…­è§’æ©‹å•†åº—è¡—': { lat: 35.4814, lng: 139.6153, name: 'ãƒ¢ãƒ¼ãƒ‹ãƒ³ã‚°æ•£ç­–ãƒ»ãƒ©ãƒ¼ãƒ¡ãƒ³æœ«å»£å®¶' },
            'åŒ—ä»²ãƒ–ãƒªãƒƒã‚¯ï¼†ãƒ›ãƒ¯ã‚¤ãƒˆ': { lat: 35.4530, lng: 139.6317, name: 'æ¨ªæµœåŒ—ä»²ãƒãƒ«ã‚·ã‚§' },
            'èµ¤ãƒ¬ãƒ³ã‚¬å€‰åº«': { lat: 35.4530, lng: 139.6425, name: 'BAY WALK MARKETãƒ»è‡ªè»¢è»Šè¿”å´' },
            'æ–°æ‰ç”°é§…': { lat: 35.4067, lng: 139.6731, name: 'æ‰ç”°å®¶æœ¬åº—ãƒ»é›»è»Šç§»å‹•' },
            'ç™½æ¥½é§…': { lat: 35.4925, lng: 139.6231, name: 'ç™½æ¥½å•†åº—è¡—æ•£ç­–' },
            'å…­è§’æ©‹ãƒ¤ãƒŸå¸‚': { lat: 35.4814, lng: 139.6153, name: 'å…­è§’æ©‹ãƒ¤ãƒŸå¸‚ï¼ˆå¤œï¼‰' }
        };
        
        // é€šçŸ¥è¨±å¯ã®å–å¾—
        async function requestNotificationPermission() {
            if (!('Notification' in window)) {
                console.log('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯é€šçŸ¥ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“');
                return false;
            }
            
            if (Notification.permission === 'granted') {
                notificationPermission = true;
                return true;
            }
            
            if (Notification.permission !== 'denied') {
                const permission = await Notification.requestPermission();
                notificationPermission = permission === 'granted';
                return notificationPermission;
            }
            
            return false;
        }
        
        // ä½ç½®æƒ…å ±ç›£è¦–ã®é–‹å§‹
        async function startLocationTracking() {
            if (!navigator.geolocation) {
                showNotification('ã“ã®ãƒ‡ãƒã‚¤ã‚¹ã¯ä½ç½®æƒ…å ±ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“', 'warning');
                return;
            }
            
            // é€šçŸ¥è¨±å¯ã‚’å–å¾—
            const hasNotificationPermission = await requestNotificationPermission();
            if (!hasNotificationPermission) {
                showNotification('é€šçŸ¥è¨±å¯ãŒå¿…è¦ã§ã™ã€‚ãƒ–ãƒ©ã‚¦ã‚¶è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚', 'warning');
            }
            
            const options = {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 30000 // 30ç§’é–“ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä½¿ç”¨
            };
            
            watchPositionId = navigator.geolocation.watchPosition(
                handlePositionUpdate,
                handlePositionError,
                options
            );
            
            showNotification('ğŸ—ºï¸ ãƒ«ãƒ¼ãƒˆè¿½å¾“ã‚’é–‹å§‹ã—ã¾ã—ãŸ', 'info');
            console.log('ä½ç½®æƒ…å ±ç›£è¦–é–‹å§‹');
        }
        
        // ä½ç½®æƒ…å ±åœæ­¢
        function stopLocationTracking() {
            if (watchPositionId !== null) {
                navigator.geolocation.clearWatch(watchPositionId);
                watchPositionId = null;
                showNotification('ãƒ«ãƒ¼ãƒˆè¿½å¾“ã‚’åœæ­¢ã—ã¾ã—ãŸ', 'info');
                console.log('ä½ç½®æƒ…å ±ç›£è¦–åœæ­¢');
            }
        }
        
        // ä½ç½®æƒ…å ±æ›´æ–°å‡¦ç†
        function handlePositionUpdate(position) {
            const currentLat = position.coords.latitude;
            const currentLng = position.coords.longitude;
            const accuracy = position.coords.accuracy;
            
            console.log(`ç¾åœ¨ä½ç½®: ${currentLat.toFixed(6)}, ${currentLng.toFixed(6)} (ç²¾åº¦: ${accuracy}m)`);
            
            // å„åœ°ç‚¹ã¨ã®è·é›¢ã‚’ãƒã‚§ãƒƒã‚¯
            Object.entries(LOCATION_COORDINATES).forEach(([locationKey, locationData]) => {
                const distance = calculateDistance(currentLat, currentLng, locationData.lat, locationData.lng);
                
                // 500mä»¥å†…ã«ã„ã‚‹å ´åˆ
                if (distance <= 500 && Date.now() - lastNotificationTime > NOTIFICATION_COOLDOWN) {
                    checkAndNotifyProximity(locationKey, locationData, distance);
                }
            });
            
            // ã‚¹ã‚¿ãƒ³ãƒ—ç²å¾—ãƒã‚§ãƒƒã‚¯ï¼ˆ100mä»¥å†…ï¼‰
            checkLocationStamps(currentLat, currentLng);
            
            // ç¾åœ¨ä½ç½®ã‚’è¡¨ç¤ºæ›´æ–°ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
            updateCurrentLocationDisplay(currentLat, currentLng, accuracy);
        }
        
        // ä½ç½®æƒ…å ±ã‚¨ãƒ©ãƒ¼å‡¦ç†
        function handlePositionError(error) {
            let message = '';
            switch (error.code) {
                case error.PERMISSION_DENIED:
                    message = 'ä½ç½®æƒ…å ±ã®åˆ©ç”¨ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸ';
                    break;
                case error.POSITION_UNAVAILABLE:
                    message = 'ä½ç½®æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“';
                    break;
                case error.TIMEOUT:
                    message = 'ä½ç½®æƒ…å ±ã®å–å¾—ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ';
                    break;
                default:
                    message = 'ä½ç½®æƒ…å ±ã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
                    break;
            }
            
            console.error('ä½ç½®æƒ…å ±ã‚¨ãƒ©ãƒ¼:', message);
            showNotification(message, 'warning');
        }
        
        // é‡è¤‡å‰Šé™¤ï¼šè·é›¢è¨ˆç®—é–¢æ•°ã¯æ—¢ã«calculateDistanceé–¢æ•°ã§å®šç¾©æ¸ˆã¿
        
        // è¿‘æ¥é€šçŸ¥ã®ãƒã‚§ãƒƒã‚¯ã¨é€ä¿¡
        function checkAndNotifyProximity(locationKey, locationData, distance) {
            const timelineItem = document.querySelector(`[data-location*="${locationKey}"]`);
            if (!timelineItem) return;
            
            // æ—¢ã«å®Œäº†ã—ã¦ã„ã‚‹åœ°ç‚¹ã¯ã‚¹ã‚­ãƒƒãƒ—
            if (timelineItem.classList.contains('completed')) return;
            
            // é€šçŸ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç”Ÿæˆ
            const distanceText = distance < 100 ? 'åˆ°ç€ã—ã¾ã—ãŸ' : `ç´„${Math.round(distance)}må…ˆã§ã™`;
            const message = `ğŸ“ ${locationData.name}\n${distanceText}`;
            
            // ãƒ–ãƒ©ã‚¦ã‚¶é€šçŸ¥
            if (notificationPermission) {
                const notification = new Notification('ğŸ—ºï¸ ç›®çš„åœ°æ¥è¿‘', {
                    body: message,
                    icon: '/icon-192x192.png',
                    badge: '/badge-72x72.png',
                    tag: `location-${locationKey}`, // åŒã˜åœ°ç‚¹ã®é‡è¤‡é€šçŸ¥ã‚’é˜²ã
                    vibrate: [200, 100, 200, 100, 200],
                    actions: [
                        { action: 'view', title: 'è©³ç´°è¡¨ç¤º' },
                        { action: 'dismiss', title: 'é–‰ã˜ã‚‹' }
                    ]
                });
                
                notification.onclick = () => {
                    window.focus();
                    timelineItem.scrollIntoView({ behavior: 'smooth' });
                    notification.close();
                };
                
                // 10ç§’å¾Œã«è‡ªå‹•ã§é–‰ã˜ã‚‹
                setTimeout(() => notification.close(), 10000);
            }
            
            // ã‚¢ãƒ—ãƒªå†…é€šçŸ¥
            showNotification(message, 'info');
            
            // ãƒã‚¤ãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆå¯¾å¿œãƒ‡ãƒã‚¤ã‚¹ã®ã¿ï¼‰
            if ('vibrate' in navigator) {
                navigator.vibrate([200, 100, 200]);
            }
            
            // åŠ¹æœéŸ³ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
            playNotificationSound();
            
            lastNotificationTime = Date.now();
            
            console.log(`é€šçŸ¥é€ä¿¡: ${locationKey} (è·é›¢: ${distance.toFixed(0)}m)`);
        }
        
        // é€šçŸ¥éŸ³å†ç”Ÿï¼ˆWeb Audio APIä½¿ç”¨ï¼‰
        function playNotificationSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                oscillator.frequency.setValueAtTime(600, audioContext.currentTime + 0.1);
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.3);
            } catch (error) {
                console.log('é€šçŸ¥éŸ³ã®å†ç”Ÿã«å¤±æ•—:', error);
            }
        }
        
        // ç¾åœ¨ä½ç½®è¡¨ç¤ºã®æ›´æ–°
        function updateCurrentLocationDisplay(lat, lng, accuracy) {
            let locationDisplay = document.getElementById('currentLocationDisplay');
            
            if (!locationDisplay) {
                // åˆå›ä½œæˆæ™‚
                const controlPanel = document.getElementById('controlPanel');
                locationDisplay = document.createElement('div');
                locationDisplay.id = 'currentLocationDisplay';
                locationDisplay.style.cssText = `
                    margin-bottom: var(--spacing-md);
                    padding: 8px;
                    background: #f8f9fa;
                    border-radius: 4px;
                    font-size: 11px;
                    border-left: 4px solid var(--secondary-color);
                `;
                
                const locationSection = document.createElement('div');
                locationSection.innerHTML = `
                    <h3>ğŸ—ºï¸ ç¾åœ¨ä½ç½®è¿½è·¡</h3>
                    <div style="margin-bottom: 8px;">
                        <button class="time-btn" onclick="startLocationTracking()" style="margin-right: 4px; font-size: 10px;">
                            â–¶ï¸ é–‹å§‹
                        </button>
                        <button class="time-btn" onclick="stopLocationTracking()" style="margin-right: 4px; font-size: 10px;">
                            â¸ï¸ åœæ­¢
                        </button>
                        <button class="time-btn" onclick="showLocationSettings()" style="font-size: 10px;">
                            âš™ï¸ è¨­å®š
                        </button>
                    </div>
                `;
                locationSection.appendChild(locationDisplay);
                
                // è²»ç”¨ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®å¾Œã«æŒ¿å…¥
                const costSection = controlPanel.querySelector('.cost-section');
                if (costSection && costSection.parentNode) {
                    costSection.parentNode.insertBefore(locationSection, costSection.nextSibling);
                } else {
                    controlPanel.appendChild(locationSection);
                }
            }
            
            const distanceToNext = findNearestLocation(lat, lng);
            
            locationDisplay.innerHTML = `
                <div style="margin-bottom: 4px;">
                    ğŸ“ <strong>ç¾åœ¨ä½ç½®:</strong><br>
                    ${lat.toFixed(6)}, ${lng.toFixed(6)}<br>
                    <span style="color: var(--text-muted);">ç²¾åº¦: Â±${accuracy.toFixed(0)}m</span>
                </div>
                ${distanceToNext ? `
                    <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #dee2e6;">
                        ğŸ¯ <strong>æ¬¡ã®ç›®çš„åœ°:</strong><br>
                        ${distanceToNext.name}<br>
                        <span style="color: var(--secondary-color);">æ®‹ã‚Šç´„${distanceToNext.distance.toFixed(0)}m</span>
                    </div>
                ` : ''}
            `;
        }
        
        // æœ€å¯„ã‚Šã®æœªå®Œäº†åœ°ç‚¹ã‚’æ¤œç´¢
        function findNearestLocation(currentLat, currentLng) {
            let nearest = null;
            let minDistance = Infinity;
            
            Object.entries(LOCATION_COORDINATES).forEach(([locationKey, locationData]) => {
                const timelineItem = document.querySelector(`[data-location*="${locationKey}"]`);
                
                // æœªå®Œäº†ã®åœ°ç‚¹ã®ã¿å¯¾è±¡
                if (timelineItem && !timelineItem.classList.contains('completed')) {
                    const distance = calculateDistance(currentLat, currentLng, locationData.lat, locationData.lng);
                    
                    if (distance < minDistance) {
                        minDistance = distance;
                        nearest = {
                            key: locationKey,
                            name: locationData.name,
                            distance: distance
                        };
                    }
                }
            });
            
            return nearest;
        }
        
        // ä½ç½®æƒ…å ±è¨­å®šè¡¨ç¤º
        function showLocationSettings() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0, 0, 0, 0.8); z-index: 1000;
                display: flex; align-items: center; justify-content: center;
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: white; border-radius: 8px; padding: 20px;
                max-width: 400px; margin: 20px; width: 100%;
            `;
            
            content.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <h3 style="margin: 0; color: var(--primary-color);">ğŸ—ºï¸ ä½ç½®è¿½è·¡è¨­å®š</h3>
                    <button onclick="this.closest('.modal').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
                </div>
                
                <div style="margin-bottom: 16px;">
                    <h4 style="margin: 0 0 8px 0;">ğŸ“± é€šçŸ¥è¨­å®š</h4>
                    <div style="margin-bottom: 8px;">
                        <label style="display: flex; align-items: center;">
                            <input type="checkbox" ${notificationPermission ? 'checked' : ''} onchange="toggleNotifications(this.checked)" style="margin-right: 8px;">
                            ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã‚’æœ‰åŠ¹ã«ã™ã‚‹
                        </label>
                    </div>
                    <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 12px;">
                        ç›®çš„åœ°500mæ‰‹å‰ã§é€šçŸ¥ã—ã¾ã™
                    </div>
                </div>
                
                <div style="margin-bottom: 16px;">
                    <h4 style="margin: 0 0 8px 0;">ğŸ¯ é€šçŸ¥è·é›¢</h4>
                    <select onchange="updateNotificationDistance(this.value)" style="width: 100%; padding: 6px;">
                        <option value="100">100mæ‰‹å‰</option>
                        <option value="200">200mæ‰‹å‰</option>
                        <option value="500" selected>500mæ‰‹å‰</option>
                        <option value="1000">1kmæ‰‹å‰</option>
                    </select>
                </div>
                
                <div style="margin-bottom: 16px;">
                    <h4 style="margin: 0 0 8px 0;">ğŸ”Š éŸ³å£°é€šçŸ¥</h4>
                    <label style="display: flex; align-items: center;">
                        <input type="checkbox" checked onchange="toggleSoundNotifications(this.checked)" style="margin-right: 8px;">
                        åŠ¹æœéŸ³ã‚’å†ç”Ÿã™ã‚‹
                    </label>
                </div>
                
                <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; margin-bottom: 16px;">
                    <h4 style="margin: 0 0 8px 0;">ğŸ“Š ç¾åœ¨ã®çŠ¶æ…‹</h4>
                    <div style="font-size: 12px;">
                        ä½ç½®æƒ…å ±: ${watchPositionId ? 'ğŸŸ¢ è¿½è·¡ä¸­' : 'ğŸ”´ åœæ­¢ä¸­'}<br>
                        é€šçŸ¥è¨±å¯: ${notificationPermission ? 'ğŸŸ¢ è¨±å¯æ¸ˆã¿' : 'ğŸ”´ æœªè¨±å¯'}<br>
                        ç²¾åº¦: ${navigator.geolocation ? 'GPSå¯¾å¿œ' : 'GPSéå¯¾å¿œ'}
                    </div>
                </div>
                
                <div style="display: flex; gap: 8px;">
                    <button onclick="testNotification()" style="flex: 1; padding: 8px; background: var(--secondary-color); color: white; border: none; border-radius: 4px; cursor: pointer;">
                        é€šçŸ¥ãƒ†ã‚¹ãƒˆ
                    </button>
                    <button onclick="this.closest('.modal').remove()" style="flex: 1; padding: 8px; background: var(--text-muted); color: white; border: none; border-radius: 4px; cursor: pointer;">
                        é–‰ã˜ã‚‹
                    </button>
                </div>
            `;
            
            modal.appendChild(content);
            modal.className = 'modal';
            document.body.appendChild(modal);
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
        }
        
        // é€šçŸ¥è¨±å¯åˆ‡ã‚Šæ›¿ãˆ
        async function toggleNotifications(enabled) {
            if (enabled) {
                const permission = await requestNotificationPermission();
                if (!permission) {
                    showNotification('é€šçŸ¥è¨±å¯ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸ', 'warning');
                }
            } else {
                notificationPermission = false;
                showNotification('é€šçŸ¥ã‚’ç„¡åŠ¹ã«ã—ã¾ã—ãŸ', 'info');
            }
        }
        
        // é€šçŸ¥ãƒ†ã‚¹ãƒˆ
        function testNotification() {
            if (notificationPermission) {
                const notification = new Notification('ğŸ§ª ãƒ†ã‚¹ãƒˆé€šçŸ¥', {
                    body: 'ãƒ«ãƒ¼ãƒˆè¿½å¾“é€šçŸ¥ãŒæ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™ï¼',
                    icon: '/icon-192x192.png',
                    vibrate: [200, 100, 200]
                });
                
                setTimeout(() => notification.close(), 3000);
                playNotificationSound();
            } else {
                showNotification('é€šçŸ¥è¨±å¯ãŒå¿…è¦ã§ã™', 'warning');
            }
        }
        
        // å†™çœŸãƒœã‚¿ãƒ³ã‚’ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã«è¿½åŠ 
        function addPhotoButtonsToTimeline() {
            const timelineItems = document.querySelectorAll('.timeline-item');
            
            timelineItems.forEach((item, index) => {
                // æ—¢ã«ãƒœã‚¿ãƒ³ãŒè¿½åŠ ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
                if (item.querySelector('.photo-actions')) return;
                
                const timelineCard = item.querySelector('.timeline-card');
                const location = item.dataset.location || 'ä¸æ˜';
                
                // å†™çœŸãƒœã‚¿ãƒ³ã‚’ä½œæˆ
                const photoActions = document.createElement('div');
                photoActions.className = 'photo-actions';
                photoActions.style.cssText = `
                    margin-top: 12px;
                    display: flex;
                    gap: 6px;
                    justify-content: center;
                `;
                
                photoActions.innerHTML = `
                    <button onclick="takePhoto(${index}, '${location}')" 
                            style="padding: 6px 12px; background: var(--secondary-color); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; display: flex; align-items: center; gap: 4px;">
                        ğŸ“· å†™çœŸæ’®å½±
                    </button>
                    <button onclick="showPhotoGallery(${index})" 
                            style="padding: 6px 12px; background: var(--accent-color); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; display: flex; align-items: center; gap: 4px;">
                        ğŸ–¼ï¸ ã‚®ãƒ£ãƒ©ãƒªãƒ¼
                    </button>
                `;
                
                timelineCard.appendChild(photoActions);
            });
        }
        
        // å†™çœŸæ’®å½±
        function takePhoto(itemIndex, location) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.capture = 'environment'; // èƒŒé¢ã‚«ãƒ¡ãƒ©ã‚’å„ªå…ˆ
            input.multiple = true; // è¤‡æ•°é¸æŠå¯èƒ½
            
            input.onchange = (event) => {
                const files = Array.from(event.target.files);
                if (files.length === 0) return;
                
                files.forEach(file => {
                    if (file.type.startsWith('image/')) {
                        processPhoto(file, itemIndex, location);
                    }
                });
            };
            
            input.click();
        }
        
        // å†™çœŸå‡¦ç†
        function processPhoto(file, itemIndex, location) {
            const reader = new FileReader();
            
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    // ç”»åƒãƒªã‚µã‚¤ã‚ºï¼ˆæ€§èƒ½ã¨ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ç¯€ç´„ã®ãŸã‚ï¼‰
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // æœ€å¤§ã‚µã‚¤ã‚ºè¨­å®š
                    const maxWidth = 800;
                    const maxHeight = 600;
                    let { width, height } = img;
                    
                    if (width > height) {
                        if (width > maxWidth) {
                            height = (height * maxWidth) / width;
                            width = maxWidth;
                        }
                    } else {
                        if (height > maxHeight) {
                            width = (width * maxHeight) / height;
                            height = maxHeight;
                        }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    // ç”»åƒæç”»
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // JPEGå“è³ªèª¿æ•´ï¼ˆ70%ï¼‰
                    const compressedDataUrl = canvas.toDataURL('image/jpeg', 0.7);
                    
                    // å†™çœŸãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
                    savePhoto(compressedDataUrl, itemIndex, location, file.name);
                };
                
                img.src = e.target.result;
            };
            
            reader.readAsDataURL(file);
        }
        
        // å†™çœŸä¿å­˜
        function savePhoto(dataUrl, itemIndex, location, filename) {
            if (!db) {
                console.error('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }
            
            const transaction = db.transaction(['photos'], 'readwrite');
            const store = transaction.objectStore('photos');
            
            const photo = {
                dataUrl: dataUrl,
                itemIndex: itemIndex,
                location: location || 'ä¸æ˜',
                filename: filename,
                timestamp: Date.now(),
                date: new Date().toISOString(),
                size: dataUrl.length,
                caption: ''
            };
            
            const request = store.add(photo);
            
            request.onsuccess = (event) => {
                const photoId = event.target.result;
                console.log('å†™çœŸä¿å­˜å®Œäº†:', photoId);
                
                photoCount++;
                addPhotoThumbnail(photoId, photo, itemIndex);
                showNotification(`ğŸ“· å†™çœŸã‚’ä¿å­˜ã—ã¾ã—ãŸ (${photoCount}æšç›®)`, 'success');
                
                // ãƒã‚¤ãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
                if ('vibrate' in navigator) {
                    navigator.vibrate([100]);
                }
            };
            
            request.onerror = () => {
                console.error('å†™çœŸä¿å­˜å¤±æ•—');
                showNotification('å†™çœŸã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            };
        }
        
        // å†™çœŸã‚µãƒ ãƒã‚¤ãƒ«è¿½åŠ 
        function addPhotoThumbnail(photoId, photo, itemIndex) {
            const timelineItem = document.querySelectorAll('.timeline-item')[itemIndex];
            if (!timelineItem) return;
            
            let photoGallery = timelineItem.querySelector('.photo-gallery');
            if (!photoGallery) {
                photoGallery = document.createElement('div');
                photoGallery.className = 'photo-gallery';
                photoGallery.style.cssText = `
                    margin-top: 12px;
                    display: flex;
                    flex-wrap: wrap;
                    gap: 6px;
                `;
                
                const timelineCard = timelineItem.querySelector('.timeline-card');
                timelineCard.appendChild(photoGallery);
            }
            
            const thumbnail = document.createElement('div');
            thumbnail.className = 'photo-thumbnail';
            thumbnail.style.cssText = `
                width: 60px;
                height: 60px;
                background-image: url("${photo.dataUrl}");
                background-size: cover;
                background-position: center;
                border-radius: 6px;
                cursor: pointer;
                border: 2px solid #fff;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                transition: transform 0.2s ease;
                position: relative;
            `;
            
            thumbnail.innerHTML = `
                <div style="
                    position: absolute;
                    top: 2px;
                    right: 2px;
                    background: rgba(0,0,0,0.7);
                    color: white;
                    border-radius: 50%;
                    width: 16px;
                    height: 16px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 10px;
                    cursor: pointer;
                " onclick="event.stopPropagation(); deletePhoto(${photoId}, this.closest('.photo-thumbnail'))">Ã—</div>
            `;
            
            thumbnail.addEventListener('mouseover', () => {
                thumbnail.style.transform = 'scale(1.1)';
            });
            
            thumbnail.addEventListener('mouseout', () => {
                thumbnail.style.transform = 'scale(1)';
            });
            
            thumbnail.onclick = () => showPhotoModal(photoId, photo);
            
            photoGallery.appendChild(thumbnail);
        }
        
        // å†™çœŸè©³ç´°è¡¨ç¤º
        function showPhotoModal(photoId, photo) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0, 0, 0, 0.9); z-index: 1000;
                display: flex; align-items: center; justify-content: center;
                padding: 20px;
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: white; border-radius: 8px; padding: 20px;
                max-width: 90%; max-height: 90%; overflow: auto;
                position: relative;
            `;
            
            const imageDate = new Date(photo.timestamp);
            
            content.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <h3 style="margin: 0; color: var(--primary-color);">ğŸ“· ${photo.location}</h3>
                    <button onclick="this.closest('.modal').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
                </div>
                
                <div style="text-align: center; margin-bottom: 16px;">
                    <img src="${photo.dataUrl}" style="max-width: 100%; max-height: 400px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
                </div>
                
                <div style="margin-bottom: 16px;">
                    <div style="font-size: 14px; color: var(--text-muted); margin-bottom: 8px;">
                        ğŸ“… ${imageDate.toLocaleString('ja-JP')}<br>
                        ğŸ“ ${photo.filename}<br>
                        ğŸ’¾ ${(photo.size / 1024).toFixed(1)} KB
                    </div>
                    
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; margin-bottom: 4px; font-weight: bold;">ğŸ“ ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³</label>
                        <input type="text" id="photoCaption-${photoId}" value="${photo.caption}" placeholder="å†™çœŸã®èª¬æ˜ã‚’å…¥åŠ›" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px;">
                    </div>
                </div>
                
                <div style="display: flex; gap: 8px;">
                    <button onclick="updatePhotoCaption(${photoId})" style="flex: 1; padding: 8px; background: var(--secondary-color); color: white; border: none; border-radius: 4px; cursor: pointer;">
                        ğŸ’¾ ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ä¿å­˜
                    </button>
                    <button onclick="downloadPhoto(${photoId})" style="flex: 1; padding: 8px; background: var(--accent-color); color: white; border: none; border-radius: 4px; cursor: pointer;">
                        ğŸ“¥ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                    </button>
                    <button onclick="deletePhoto(${photoId}); this.closest('.modal').remove();" style="flex: 1; padding: 8px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        ğŸ—‘ï¸ å‰Šé™¤
                    </button>
                </div>
            `;
            
            modal.appendChild(content);
            modal.className = 'modal';
            document.body.appendChild(modal);
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
        }
        
        // å†™çœŸã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³æ›´æ–°
        function updatePhotoCaption(photoId) {
            const captionInput = document.getElementById(`photoCaption-${photoId}`);
            if (!captionInput || !db) return;
            
            const transaction = db.transaction(['photos'], 'readwrite');
            const store = transaction.objectStore('photos');
            const request = store.get(photoId);
            
            request.onsuccess = (event) => {
                const photo = event.target.result;
                if (photo) {
                    photo.caption = captionInput.value;
                    const updateRequest = store.put(photo);
                    
                    updateRequest.onsuccess = () => {
                        showNotification('ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success');
                    };
                }
            };
        }
        
        // å†™çœŸãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        function downloadPhoto(photoId) {
            if (!db) return;
            
            const transaction = db.transaction(['photos'], 'readonly');
            const store = transaction.objectStore('photos');
            const request = store.get(photoId);
            
            request.onsuccess = (event) => {
                const photo = event.target.result;
                if (photo) {
                    const link = document.createElement('a');
                    link.href = photo.dataUrl;
                    link.download = `æ¨ªæµœæ—…è¡Œ_${photo.location}_${new Date(photo.timestamp).toISOString().slice(0, 19).replace(/[:.]/g, '-')}.jpg`;
                    link.click();
                }
            };
        }
        
        // å†™çœŸå‰Šé™¤
        function deletePhoto(photoId, thumbnailElement = null) {
            if (!confirm('ã“ã®å†™çœŸã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
            
            if (!db) return;
            
            const transaction = db.transaction(['photos'], 'readwrite');
            const store = transaction.objectStore('photos');
            const request = store.delete(photoId);
            
            request.onsuccess = () => {
                if (thumbnailElement) {
                    thumbnailElement.remove();
                    photoCount = Math.max(0, photoCount - 1);
                }
                showNotification('å†™çœŸã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'info');
            };
        }
        
        // ã‚®ãƒ£ãƒ©ãƒªãƒ¼è¡¨ç¤ºï¼ˆç‰¹å®šã®ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³é …ç›®ã¾ãŸã¯ã™ã¹ã¦ï¼‰
        function showPhotoGallery(itemIndex = null) {
            if (!db) {
                showNotification('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“', 'warning');
                return;
            }
            
            const transaction = db.transaction(['photos'], 'readonly');
            const store = transaction.objectStore('photos');
            const request = store.getAll();
            
            request.onsuccess = (event) => {
                let photos = event.target.result;
                
                // ç‰¹å®šã®ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³é …ç›®ã®å†™çœŸã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
                if (itemIndex !== null && itemIndex !== undefined) {
                    photos = photos.filter(photo => photo.itemIndex === itemIndex);
                }
                
                displayGalleryModal(photos, itemIndex);
            };
        }
        
        // ã‚®ãƒ£ãƒ©ãƒªãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
        function displayGalleryModal(photos, itemIndex = null) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0, 0, 0, 0.8); z-index: 1000;
                display: flex; align-items: center; justify-content: center;
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: white; border-radius: 8px; padding: 20px;
                max-width: 90%; max-height: 90%; overflow: auto; width: 600px;
            `;
            
            const photosHTML = photos.length > 0 ? photos.map((photo, index) => `
                <div style="
                    display: inline-block;
                    margin: 8px;
                    text-align: center;
                    cursor: pointer;
                " onclick="showPhotoModal(${photo.id}, ${JSON.stringify(photo).replace(/"/g, '&quot;')})">
                    <img src="${photo.dataUrl}" style="
                        width: 120px;
                        height: 120px;
                        object-fit: cover;
                        border-radius: 8px;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                        transition: transform 0.2s ease;
                    " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                    <div style="margin-top: 4px; font-size: 12px; color: var(--text-muted);">
                        ${photo.location}<br>
                        ${new Date(photo.timestamp).toLocaleDateString('ja-JP')}
                    </div>
                </div>
            `).join('') : '<div style="text-align: center; color: var(--text-muted); padding: 40px;">ã¾ã å†™çœŸãŒã‚ã‚Šã¾ã›ã‚“</div>';
            
            const titleText = itemIndex !== null ? 
                `ğŸ“· ${document.querySelectorAll('.timeline-item')[itemIndex]?.dataset.location || 'ä¸æ˜'} ã®å†™çœŸ (${photos.length}æš)` : 
                `ğŸ“· æ—…è¡Œã‚®ãƒ£ãƒ©ãƒªãƒ¼ (${photos.length}æš)`;
            
            content.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <h3 style="margin: 0; color: var(--primary-color);">${titleText}</h3>
                    <button onclick="this.closest('.modal').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
                </div>
                
                <div style="margin-bottom: 16px;">
                    ${photosHTML}
                </div>
                
                <div style="display: flex; gap: 8px; justify-content: center;">
                    <button onclick="exportPhotoGallery()" style="padding: 10px 20px; background: var(--secondary-color); color: white; border: none; border-radius: 4px; cursor: pointer;">
                        ğŸ“¦ ä¸€æ‹¬ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                    </button>
                    <button onclick="shareGallery()" style="padding: 10px 20px; background: var(--accent-color); color: white; border: none; border-radius: 4px; cursor: pointer;">
                        ğŸ“¤ ã‚·ã‚§ã‚¢
                    </button>
                </div>
            `;
            
            modal.appendChild(content);
            modal.className = 'modal';
            document.body.appendChild(modal);
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
        }
        
        // å†™çœŸä¸€æ‹¬ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆJSZipä½¿ç”¨ï¼‰
        async function exportPhotoGallery() {
            if (!db) return;
            
            showNotification('ã‚®ãƒ£ãƒ©ãƒªãƒ¼ã‚’æº–å‚™ä¸­...', 'info');
            
            try {
                // JSZipãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’å‹•çš„ã«èª­ã¿è¾¼ã¿
                if (typeof JSZip === 'undefined') {
                    const script = document.createElement('script');
                    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js';
                    document.head.appendChild(script);
                    
                    await new Promise((resolve, reject) => {
                        script.onload = resolve;
                        script.onerror = reject;
                    });
                }
                
                const transaction = db.transaction(['photos'], 'readonly');
                const store = transaction.objectStore('photos');
                const request = store.getAll();
                
                request.onsuccess = async (event) => {
                    const photos = event.target.result;
                    if (photos.length === 0) {
                        showNotification('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹å†™çœŸãŒã‚ã‚Šã¾ã›ã‚“', 'warning');
                        return;
                    }
                    
                    const zip = new JSZip();
                    const travelFolder = zip.folder("yokohama-travel-photos");
                    
                    // READMEè¿½åŠ 
                    travelFolder.file("README.txt", `æ¨ªæµœæ—…è¡Œå†™çœŸé›†
æ’®å½±æ—¥: ${new Date().toLocaleDateString('ja-JP')}
å†™çœŸæ•°: ${photos.length}æš

å„å†™çœŸã¯æ’®å½±å ´æ‰€åˆ¥ã«å‘½åã•ã‚Œã¦ã„ã¾ã™ã€‚
`);
                    
                    // å†™çœŸã‚’è¿½åŠ 
                    photos.forEach((photo, index) => {
                        const base64Data = photo.dataUrl.split(',')[1];
                        const filename = `${(index + 1).toString().padStart(3, '0')}_${photo.location}_${new Date(photo.timestamp).toISOString().slice(0, 10)}.jpg`;
                        travelFolder.file(filename, base64Data, { base64: true });
                    });
                    
                    // HTMLæ¦‚è¦ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
                    const htmlContent = `
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>æ¨ªæµœæ—…è¡Œå†™çœŸé›†</title>
    <style>
        body { font-family: sans-serif; margin: 20px; }
        .photo { margin: 20px 0; text-align: center; }
        .photo img { max-width: 300px; border-radius: 8px; }
        .caption { margin-top: 8px; font-weight: bold; }
        .date { color: #666; font-size: 14px; }
    </style>
</head>
<body>
    <h1>ğŸŒŠ æ¨ªæµœæ—…è¡Œå†™çœŸé›†</h1>
    <p>æ’®å½±æ—¥: ${new Date().toLocaleDateString('ja-JP')}</p>
    ${photos.map((photo, index) => `
        <div class="photo">
            <img src="data:image/jpeg;base64,${photo.dataUrl.split(',')[1]}" alt="${photo.location}">
            <div class="caption">${photo.location}</div>
            <div class="date">${new Date(photo.timestamp).toLocaleString('ja-JP')}</div>
            ${photo.caption ? `<div style="margin-top: 4px; font-style: italic;">${photo.caption}</div>` : ''}
        </div>
    `).join('')}
</body>
</html>
                    `;
                    
                    travelFolder.file("index.html", htmlContent);
                    
                    // ZIPç”Ÿæˆã¨ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                    const zipBlob = await zip.generateAsync({ type: "blob" });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(zipBlob);
                    link.download = `æ¨ªæµœæ—…è¡Œå†™çœŸé›†_${new Date().toISOString().slice(0, 10)}.zip`;
                    link.click();
                    
                    showNotification(`${photos.length}æšã®å†™çœŸã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ`, 'success');
                };
                
            } catch (error) {
                console.error('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼:', error);
                showNotification('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }
        
        // ã‚®ãƒ£ãƒ©ãƒªãƒ¼ã‚·ã‚§ã‚¢
        function shareGallery() {
            if (navigator.share) {
                // Web Share APIå¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶
                navigator.share({
                    title: 'æ¨ªæµœæ—…è¡Œå†™çœŸé›†',
                    text: `æ¨ªæµœæ—…è¡Œã®å†™çœŸã‚’${photoCount}æšæ’®å½±ã—ã¾ã—ãŸï¼`,
                    url: window.location.href
                }).catch(console.error);
            } else {
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šURLæ–‡å­—åˆ—
                const shareText = `æ¨ªæµœæ—…è¡Œã®å†™çœŸã‚’${photoCount}æšæ’®å½±ã—ã¾ã—ãŸï¼ ${window.location.href}`;
                navigator.clipboard.writeText(shareText).then(() => {
                    showNotification('ã‚·ã‚§ã‚¢ç”¨ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ', 'success');
                }).catch(() => {
                    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢è¡¨ç¤º
                    prompt('ã‚·ã‚§ã‚¢ç”¨ãƒ†ã‚­ã‚¹ãƒˆ:', shareText);
                });
            }
        }
        
        // ã‚²ãƒ¼ãƒŸãƒ•ã‚£ã‚±ãƒ¼ã‚·ãƒ§ãƒ³æ©Ÿèƒ½
        let gameState = {
            stamps: new Set(),
            achievements: [],
            points: 0,
            level: 1,
            stepCount: 0,
            startTime: null
        };
        
        // ã‚¹ã‚¿ãƒ³ãƒ—å®šç¾©
        const STAMPS = {
            'shibuya_start': { name: 'ã‚¹ã‚¿ãƒ¼ãƒˆ', emoji: 'ğŸš€', location: 'æ¸‹è°·é§…', points: 10 },
            'market_visit': { name: 'ãƒãƒ¼ã‚±ãƒƒãƒˆæ¢æ¤œå®¶', emoji: 'ğŸŸ', location: 'æ¨ªæµœå¸‚ä¸­å¤®å¸å£²å¸‚å ´', points: 20 },
            'ramen_master': { name: 'ãƒ©ãƒ¼ãƒ¡ãƒ³é€š', emoji: 'ğŸœ', location: 'ãƒ©ãƒ¼ãƒ¡ãƒ³æœ«å»£å®¶', points: 15 },
            'marche_explorer': { name: 'ãƒãƒ«ã‚·ã‚§æ„›å¥½å®¶', emoji: 'ğŸ¥–', location: 'æ¨ªæµœåŒ—ä»²ãƒãƒ«ã‚·ã‚§', points: 15 },
            'redbrick_collector': { name: 'ãƒ¬ãƒ³ã‚¬å€‰åº«ãƒã‚¹ã‚¿ãƒ¼', emoji: 'ğŸ§±', location: 'èµ¤ãƒ¬ãƒ³ã‚¬å€‰åº«', points: 15 },
            'cycling_champion': { name: 'ã‚µã‚¤ã‚¯ãƒªã‚¹ãƒˆ', emoji: 'ğŸš²', location: 'HELLO CYCLING', points: 25 },
            'sugita_gourmet': { name: 'æ‰ç”°ã‚°ãƒ«ãƒ¡', emoji: 'ğŸ²', location: 'æ‰ç”°å®¶æœ¬åº—', points: 20 },
            'night_market': { name: 'å¤œå¸‚ã®é”äºº', emoji: 'ğŸŒ™', location: 'å…­è§’æ©‹ãƒ¤ãƒŸå¸‚', points: 30 },
            'photographer': { name: 'ãƒ•ã‚©ãƒˆã‚°ãƒ©ãƒ•ã‚¡ãƒ¼', emoji: 'ğŸ“¸', condition: 'photos >= 5', points: 25 },
            'budget_keeper': { name: 'å®¶è¨ˆç®¡ç†ä¸Šæ‰‹', emoji: 'ğŸ’°', condition: 'under_budget', points: 50 },
            'early_bird': { name: 'æ—©èµ·ãé³¥', emoji: 'ğŸ¦', condition: 'start_before_7', points: 15 },
            'completionist': { name: 'ã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆãƒã‚¹ã‚¿ãƒ¼', emoji: 'ğŸ‘‘', condition: 'all_stamps', points: 100 }
        };
        
        // å®Ÿç¸¾ãƒã‚§ãƒƒã‚¯
        function checkAchievements() {
            const newAchievements = [];
            
            // å†™çœŸå®Ÿç¸¾
            if (photoCount >= 5 && !gameState.achievements.includes('photographer')) {
                newAchievements.push('photographer');
            }
            
            // äºˆç®—å®Ÿç¸¾ï¼ˆå®Ÿè²»è¨˜éŒ²ãŒã‚ã‚‹ã¨ãï¼‰
            if (db) {
                checkBudgetAchievement().then(underBudget => {
                    if (underBudget && !gameState.achievements.includes('budget_keeper')) {
                        unlockAchievement('budget_keeper');
                    }
                });
            }
            
            // æ—©èµ·ãå®Ÿç¸¾
            if (gameState.startTime) {
                const startHour = new Date(gameState.startTime).getHours();
                if (startHour < 7 && !gameState.achievements.includes('early_bird')) {
                    newAchievements.push('early_bird');
                }
            }
            
            // ã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆå®Ÿç¸¾
            const locationStamps = Object.keys(STAMPS).filter(key => STAMPS[key].location && STAMPS[key].location !== 'HELLO CYCLING');
            const hasAllLocationStamps = locationStamps.every(stamp => gameState.stamps.has(stamp));
            if (hasAllLocationStamps && !gameState.achievements.includes('completionist')) {
                newAchievements.push('completionist');
            }
            
            // æ–°ã—ã„å®Ÿç¸¾ã‚’ã‚¢ãƒ³ãƒ­ãƒƒã‚¯
            newAchievements.forEach(achievement => {
                unlockAchievement(achievement);
            });
        }
        
        // äºˆç®—å®Ÿç¸¾ãƒã‚§ãƒƒã‚¯
        function checkBudgetAchievement() {
            return new Promise((resolve) => {
                if (!db) {
                    resolve(false);
                    return;
                }
                
                const transaction = db.transaction(['expenses'], 'readonly');
                const store = transaction.objectStore('expenses');
                const request = store.getAll();
                
                request.onsuccess = (event) => {
                    const expenses = event.target.result;
                    const today = new Date().toISOString().split('T')[0];
                    const todayExpenses = expenses.filter(expense => 
                        expense.date.startsWith(today)
                    );
                    
                    const totalActual = todayExpenses.reduce((sum, expense) => sum + expense.amount, 0);
                    const totalBudget = 5510;
                    
                    resolve(totalActual <= totalBudget);
                };
                
                request.onerror = () => resolve(false);
            });
        }
        
        // ã‚¹ã‚¿ãƒ³ãƒ—ç²å¾—
        function collectStamp(stampId, location) {
            if (gameState.stamps.has(stampId)) {
                return false; // æ—¢ã«ç²å¾—æ¸ˆã¿
            }
            
            const stamp = STAMPS[stampId];
            if (!stamp) return false;
            
            gameState.stamps.add(stampId);
            gameState.points += stamp.points;
            
            // ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—è¨ˆç®—
            const newLevel = Math.floor(gameState.points / 100) + 1;
            const leveledUp = newLevel > gameState.level;
            gameState.level = newLevel;
            
            // ä¿å­˜
            saveGameState();
            
            // é€šçŸ¥è¡¨ç¤º
            showStampNotification(stamp, leveledUp);
            
            // ãƒãƒƒã‚¸ãƒ³ã‚° APIå¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶ã§ãƒãƒƒã‚¸æ›´æ–°
            updateAppBadge();
            
            // å®Ÿç¸¾ãƒã‚§ãƒƒã‚¯
            checkAchievements();
            
            return true;
        }
        
        // ã‚¹ã‚¿ãƒ³ãƒ—é€šçŸ¥
        function showStampNotification(stamp, leveledUp) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0, 0, 0, 0.8); z-index: 1001;
                display: flex; align-items: center; justify-content: center;
                animation: stampModalFadeIn 0.5s ease-out;
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white; border-radius: 16px; padding: 30px;
                text-align: center; max-width: 300px;
                animation: stampBounce 0.6s ease-out;
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            `;
            
            content.innerHTML = `
                <div style="font-size: 60px; margin-bottom: 16px;">${stamp.emoji}</div>
                <h3 style="margin: 0 0 8px 0; font-size: 20px;">ã‚¹ã‚¿ãƒ³ãƒ—ç²å¾—ï¼</h3>
                <div style="font-size: 16px; margin-bottom: 12px;">${stamp.name}</div>
                <div style="font-size: 14px; opacity: 0.9; margin-bottom: 16px;">+${stamp.points} ãƒã‚¤ãƒ³ãƒˆ</div>
                ${leveledUp ? `
                    <div style="background: rgba(255,255,255,0.2); padding: 8px; border-radius: 8px; margin-bottom: 16px;">
                        ğŸ‰ ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ï¼ Lv.${gameState.level}
                    </div>
                ` : ''}
                <button onclick="this.closest('.modal').remove()" style="
                    background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3);
                    color: white; padding: 10px 20px; border-radius: 8px; cursor: pointer;
                    font-size: 14px;
                ">ç¶šã‘ã‚‹</button>
            `;
            
            modal.appendChild(content);
            modal.className = 'modal';
            document.body.appendChild(modal);
            
            // ãƒã‚¤ãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
            if ('vibrate' in navigator) {
                navigator.vibrate([100, 50, 100, 50, 200]);
            }
            
            // åŠ¹æœéŸ³
            playAchievementSound();
            
            // 3ç§’å¾Œã«è‡ªå‹•ã§é–‰ã˜ã‚‹
            setTimeout(() => {
                if (modal.parentNode) {
                    modal.remove();
                }
            }, 3000);
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
        }
        
        // å®Ÿç¸¾ã‚¢ãƒ³ãƒ­ãƒƒã‚¯
        function unlockAchievement(achievementId) {
            if (gameState.achievements.includes(achievementId)) return;
            
            const achievement = STAMPS[achievementId];
            if (!achievement) return;
            
            gameState.achievements.push(achievementId);
            gameState.points += achievement.points;
            
            // ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—è¨ˆç®—
            const newLevel = Math.floor(gameState.points / 100) + 1;
            const leveledUp = newLevel > gameState.level;
            gameState.level = newLevel;
            
            saveGameState();
            showAchievementNotification(achievement, leveledUp);
            updateAppBadge();
        }
        
        // å®Ÿç¸¾é€šçŸ¥
        function showAchievementNotification(achievement, leveledUp) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0, 0, 0, 0.8); z-index: 1001;
                display: flex; align-items: center; justify-content: center;
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
                color: white; border-radius: 16px; padding: 30px;
                text-align: center; max-width: 300px;
                animation: achievementShine 1s ease-out;
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            `;
            
            content.innerHTML = `
                <div style="font-size: 60px; margin-bottom: 16px;">ğŸ†</div>
                <h3 style="margin: 0 0 8px 0; font-size: 20px;">å®Ÿç¸¾ã‚¢ãƒ³ãƒ­ãƒƒã‚¯ï¼</h3>
                <div style="font-size: 18px; margin-bottom: 8px;">${achievement.emoji} ${achievement.name}</div>
                <div style="font-size: 14px; opacity: 0.9; margin-bottom: 16px;">+${achievement.points} ãƒã‚¤ãƒ³ãƒˆ</div>
                ${leveledUp ? `
                    <div style="background: rgba(255,255,255,0.2); padding: 8px; border-radius: 8px; margin-bottom: 16px;">
                        ğŸ‰ ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ï¼ Lv.${gameState.level}
                    </div>
                ` : ''}
                <button onclick="this.closest('.modal').remove()" style="
                    background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3);
                    color: white; padding: 10px 20px; border-radius: 8px; cursor: pointer;
                ">ç´ æ™´ã‚‰ã—ã„ï¼</button>
            `;
            
            modal.appendChild(content);
            modal.className = 'modal';
            document.body.appendChild(modal);
            
            // ãƒã‚¤ãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
            if ('vibrate' in navigator) {
                navigator.vibrate([200, 100, 200, 100, 200, 100, 400]);
            }
            
            // åŠ¹æœéŸ³
            playAchievementSound();
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
        }
        
        // ã‚²ãƒ¼ãƒ çŠ¶æ…‹ä¿å­˜
        function saveGameState() {
            localStorage.setItem('yokohama-travel-game', JSON.stringify({
                stamps: Array.from(gameState.stamps),
                achievements: gameState.achievements,
                points: gameState.points,
                level: gameState.level,
                stepCount: gameState.stepCount,
                startTime: gameState.startTime
            }));
        }
        
        // ã‚²ãƒ¼ãƒ çŠ¶æ…‹èª­ã¿è¾¼ã¿
        function loadGameState() {
            const saved = localStorage.getItem('yokohama-travel-game');
            if (saved) {
                const data = JSON.parse(saved);
                gameState.stamps = new Set(data.stamps || []);
                gameState.achievements = data.achievements || [];
                gameState.points = data.points || 0;
                gameState.level = data.level || 1;
                gameState.stepCount = data.stepCount || 0;
                gameState.startTime = data.startTime || Date.now();
            } else {
                gameState.startTime = Date.now();
                saveGameState();
            }
        }
        
        // ã‚¢ãƒ—ãƒªãƒãƒƒã‚¸æ›´æ–°
        function updateAppBadge() {
            if ('setAppBadge' in navigator) {
                const unreadCount = gameState.stamps.size + gameState.achievements.length;
                navigator.setAppBadge(unreadCount > 0 ? unreadCount : null);
            }
        }
        
        // å®Ÿç¸¾éŸ³åŠ¹æœ
        function playAchievementSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // ãƒ•ã‚¡ãƒ³ãƒ•ã‚¡ãƒ¼ãƒ¬é¢¨ã®éŸ³
                const frequencies = [523.25, 659.25, 783.99, 1046.50]; // C5, E5, G5, C6
                frequencies.forEach((freq, index) => {
                    setTimeout(() => {
                        const oscillator = audioContext.createOscillator();
                        const gainNode = audioContext.createGain();
                        
                        oscillator.connect(gainNode);
                        gainNode.connect(audioContext.destination);
                        
                        oscillator.frequency.setValueAtTime(freq, audioContext.currentTime);
                        gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                        
                        oscillator.start(audioContext.currentTime);
                        oscillator.stop(audioContext.currentTime + 0.5);
                    }, index * 100);
                });
            } catch (error) {
                console.log('åŠ¹æœéŸ³ã®å†ç”Ÿã«å¤±æ•—:', error);
            }
        }
        
        // ã‚²ãƒ¼ãƒŸãƒ•ã‚£ã‚±ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ³è¡¨ç¤º
        function showGameStatus() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0, 0, 0, 0.8); z-index: 1000;
                display: flex; align-items: center; justify-content: center;
            `;
            
            const progress = (gameState.points % 100) / 100 * 100;
            
            const stampsHTML = Object.entries(STAMPS).map(([key, stamp]) => {
                const collected = gameState.stamps.has(key);
                const isAchievement = stamp.condition;
                const unlocked = isAchievement ? gameState.achievements.includes(key) : collected;
                
                return `
                    <div style="
                        display: inline-block; margin: 8px; padding: 12px;
                        background: ${unlocked ? '#d4edda' : '#f8f9fa'};
                        border-radius: 8px; text-align: center; width: 80px;
                        border: 2px solid ${unlocked ? '#28a745' : '#dee2e6'};
                    ">
                        <div style="font-size: 24px; margin-bottom: 4px; ${unlocked ? '' : 'filter: grayscale(100%); opacity: 0.5;'}">${stamp.emoji}</div>
                        <div style="font-size: 10px; font-weight: bold;">${stamp.name}</div>
                        <div style="font-size: 9px; color: var(--text-muted);">+${stamp.points}pt</div>
                        ${isAchievement ? '<div style="font-size: 8px; color: #6f42c1;">ğŸ† å®Ÿç¸¾</div>' : ''}
                    </div>
                `;
            }).join('');
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: white; border-radius: 12px; padding: 24px;
                max-width: 500px; margin: 20px; width: 100%; max-height: 80vh; overflow-y: auto;
            `;
            
            content.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="margin: 0; color: var(--primary-color);">ğŸ® æ—…è¡Œã‚²ãƒ¼ãƒ </h3>
                    <button onclick="this.closest('.modal').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
                </div>
                
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; text-align: center;">
                    <div style="font-size: 24px; margin-bottom: 8px;">ãƒ¬ãƒ™ãƒ« ${gameState.level}</div>
                    <div style="font-size: 32px; font-weight: bold; margin-bottom: 8px;">${gameState.points} ãƒã‚¤ãƒ³ãƒˆ</div>
                    <div style="background: rgba(255,255,255,0.2); border-radius: 10px; height: 8px; overflow: hidden;">
                        <div style="background: white; height: 100%; width: ${progress}%; transition: width 0.5s ease;"></div>
                    </div>
                    <div style="font-size: 12px; opacity: 0.9; margin-top: 4px;">æ¬¡ã®ãƒ¬ãƒ™ãƒ«ã¾ã§ ${100 - (gameState.points % 100)} ãƒã‚¤ãƒ³ãƒˆ</div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h4 style="margin: 0 0 12px 0;">ğŸ“ ã‚¹ã‚¿ãƒ³ãƒ—ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ (${gameState.stamps.size}/${Object.keys(STAMPS).filter(k => !STAMPS[k].condition).length})</h4>
                    <div style="background: #f8f9fa; padding: 12px; border-radius: 8px;">
                        ${stampsHTML}
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h4 style="margin: 0 0 12px 0;">ğŸ† å®Ÿç¸¾ (${gameState.achievements.length}/${Object.keys(STAMPS).filter(k => STAMPS[k].condition).length})</h4>
                    <div style="font-size: 12px; color: var(--text-muted);">
                        ç‰¹åˆ¥ãªæ¡ä»¶ã‚’ã‚¯ãƒªã‚¢ã—ã¦å®Ÿç¸¾ã‚’ã‚¢ãƒ³ãƒ­ãƒƒã‚¯ã—ã‚ˆã†ï¼
                    </div>
                </div>
                
                <div style="display: flex; gap: 8px;">
                    <button onclick="resetGameProgress()" style="flex: 1; padding: 10px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        ğŸ”„ ãƒªã‚»ãƒƒãƒˆ
                    </button>
                    <button onclick="this.closest('.modal').remove()" style="flex: 1; padding: 10px; background: var(--secondary-color); color: white; border: none; border-radius: 4px; cursor: pointer;">
                        é–‰ã˜ã‚‹
                    </button>
                </div>
            `;
            
            modal.appendChild(content);
            modal.className = 'modal';
            document.body.appendChild(modal);
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
        }
        
        // ã‚²ãƒ¼ãƒ é€²è¡Œãƒªã‚»ãƒƒãƒˆ
        function resetGameProgress() {
            if (!confirm('ã‚²ãƒ¼ãƒ ã®é€²è¡Œã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿï¼ˆã‚¹ã‚¿ãƒ³ãƒ—ãƒ»å®Ÿç¸¾ãƒ»ãƒã‚¤ãƒ³ãƒˆãŒã™ã¹ã¦å‰Šé™¤ã•ã‚Œã¾ã™ï¼‰')) return;
            
            gameState = {
                stamps: new Set(),
                achievements: [],
                points: 0,
                level: 1,
                stepCount: 0,
                startTime: Date.now()
            };
            
            saveGameState();
            updateAppBadge();
            showNotification('ã‚²ãƒ¼ãƒ é€²è¡Œã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ', 'info');
            
            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
            document.querySelector('.modal')?.remove();
        }
        
        // ä½ç½®ãƒ™ãƒ¼ã‚¹ã®ã‚¹ã‚¿ãƒ³ãƒ—ç²å¾—ãƒã‚§ãƒƒã‚¯
        function checkLocationStamps(currentLat, currentLng) {
            Object.entries(LOCATION_COORDINATES).forEach(([locationKey, locationData]) => {
                const distance = calculateDistance(currentLat, currentLng, locationData.lat, locationData.lng);
                
                // 100mä»¥å†…ã§ã‚¹ã‚¿ãƒ³ãƒ—ç²å¾—
                if (distance <= 100) {
                    const stampId = getStampIdForLocation(locationKey);
                    if (stampId) {
                        collectStamp(stampId, locationKey);
                    }
                }
            });
        }
        
        // å ´æ‰€ã‹ã‚‰ã‚¹ã‚¿ãƒ³ãƒ—IDã‚’å–å¾—
        function getStampIdForLocation(locationKey) {
            const mapping = {
                'æ¸‹è°·é§…': 'shibuya_start',
                'æ¨ªæµœå¸‚ä¸­å¤®å¸å£²å¸‚å ´': 'market_visit',
                'ãƒ©ãƒ¼ãƒ¡ãƒ³æœ«å»£å®¶': 'ramen_master',
                'æ¨ªæµœåŒ—ä»²ãƒãƒ«ã‚·ã‚§': 'marche_explorer',
                'èµ¤ãƒ¬ãƒ³ã‚¬å€‰åº«': 'redbrick_collector',
                'æ‰ç”°å®¶æœ¬åº—': 'sugita_gourmet',
                'å…­è§’æ©‹ãƒ¤ãƒŸå¸‚': 'night_market'
            };
            
            return mapping[locationKey] || null;
        }
        
        // æ­´å²æƒ…å ±è¡¨ç¤º
        function showHistoryInfo(locationName) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0, 0, 0, 0.8); z-index: 1000;
                display: flex; align-items: center; justify-content: center;
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: white; border-radius: 8px; padding: 20px;
                max-width: 500px; max-height: 80vh; overflow-y: auto; margin: 20px;
            `;
            
            const historyData = getHistoryData(locationName);
            
            content.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0; color: #8B4513;">ğŸ›ï¸ ${historyData.name}</h3>
                    <button onclick="this.closest('.modal').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
                </div>
                
                <div style="line-height: 1.6;">
                    <div style="background: #f8f4e6; padding: 12px; border-radius: 6px; margin-bottom: 15px; border-left: 4px solid #8B4513;">
                        <strong>${historyData.period}</strong>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <h4 style="margin: 0 0 8px 0; color: #8B4513;">ğŸ“– æ­´å²</h4>
                        <p style="margin: 0; font-size: 14px;">${historyData.history}</p>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <h4 style="margin: 0 0 8px 0; color: #8B4513;">ğŸ‘ï¸ è¦‹ã©ã“ã‚</h4>
                        <p style="margin: 0; font-size: 14px;">${historyData.highlights}</p>
                    </div>
                    
                    ${historyData.tips ? `
                        <div style="background: #e8f4fd; padding: 10px; border-radius: 6px; margin-bottom: 15px;">
                            <strong>ğŸ’¡ è¦‹å­¦ã®ã‚³ãƒ„:</strong><br>
                            <span style="font-size: 14px;">${historyData.tips}</span>
                        </div>
                    ` : ''}
                    
                    <div style="text-align: center; margin-top: 20px;">
                        <a href="${historyData.url}" target="_blank" style="
                            display: inline-block; padding: 10px 20px; 
                            background: #8B4513; color: white; text-decoration: none; 
                            border-radius: 4px; font-size: 14px;
                        ">è©³ç´°æƒ…å ±ã‚’è¦‹ã‚‹</a>
                    </div>
                </div>
            `;
            
            modal.appendChild(content);
            modal.className = 'modal';
            document.body.appendChild(modal);
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
        }
        
        // æ­´å²ãƒ‡ãƒ¼ã‚¿å–å¾—
        function getHistoryData(locationName) {
            const historyDatabase = {
                'å“å·å®¿': {
                    name: 'å“å·å®¿ï¼ˆæ±æµ·é“äº”åä¸‰æ¬¡ç¬¬ä¸€å®¿ï¼‰',
                    period: 'æ±Ÿæˆ¸æ™‚ä»£å‰æœŸã€œæ˜æ²»æ™‚ä»£ï¼ˆ1601å¹´ã€œï¼‰',
                    history: 'æ±Ÿæˆ¸ã‹ã‚‰æœ€åˆã®å®¿å ´ç”ºã¨ã—ã¦æ „ãˆãŸæ±æµ·é“ã®è¦æ‰€ã€‚å‚å‹¤äº¤ä»£ã®å¤§åã‚„æ—…äººã§è³‘ã‚ã„ã€é£¯å±‹ãƒ»èŒ¶å±‹ãƒ»æ—…ç± ãŒè»’ã‚’é€£ã­ã¦ã„ã¾ã—ãŸã€‚',
                    highlights: 'ç¾åœ¨ã‚‚æ®‹ã‚‹æ—§æ±æµ·é“ã®çŸ³ç•³ã‚„æ¡ˆå†…ã‚²ãƒ¼ãƒˆã€å“å·å®¿äº¤æµé¤¨ã§ã¯å½“æ™‚ã®æ§˜å­ã‚’å±•ç¤ºã€‚è¡—é“ç¯ãŒå®¿å ´ã®é¢å½±ã‚’ä»Šã«ä¼ãˆã¦ã„ã¾ã™ã€‚',
                    tips: 'è‡ªè»¢è»Šã§é€šéã™ã‚‹éš›ã¯ã€å³æ‰‹ã®ç™½å£å»ºç‰©ã€Œå“å·å®¿äº¤æµé¤¨ã€ã¨è¡—é“ç¯ã«æ³¨ç›®ã—ã¦ãã ã•ã„ã€‚',
                    url: 'https://www.gltjp.com/ja/directory/item/11086/'
                },
                'å·å´å®¿è·¡': {
                    name: 'å·å´å®¿è·¡',
                    period: 'æ±Ÿæˆ¸æ™‚ä»£å‰æœŸã€œæ˜æ²»æ™‚ä»£ï¼ˆ1623å¹´ã€œï¼‰',
                    history: 'æ±æµ·é“äº”åä¸‰æ¬¡ã®2ç•ªç›®ã®å®¿å ´ã€‚å¤šæ‘©å·ã®æ¸¡ã—å ´ã¨ã—ã¦é‡è¦ãªå½¹å‰²ã‚’æœãŸã—ã€å·å´å¤§å¸«ã¸ã®å‚è©£å®¢ã§ã‚‚è³‘ã‚ã„ã¾ã—ãŸã€‚',
                    highlights: 'è¡Œç¯å½¢ã®è¡—ç¯ã¨èŠ­è•‰å¥ç¢‘ãŒç‰¹å¾´çš„ã€‚æœ¬é™£è·¡ã¯ç¾åœ¨äº¤å·®ç‚¹ã¨ãªã£ã¦ã„ã¾ã™ãŒã€èª¬æ˜æ¿ã§å½“æ™‚ã‚’å²ã¶ã“ã¨ãŒã§ãã¾ã™ã€‚',
                    tips: 'å·¦æ­©é“å´ã®èŠ­è•‰å¥ç¢‘ã¨ã€æ±æµ·é“å·å´å®¿ã®è¡Œç¯å½¢è¡—ç¯ã‚’æ¢ã—ã¦ã¿ã¦ãã ã•ã„ã€‚',
                    url: 'https://www.tabirai.net/localinfo/article/article-23188/'
                },
                'ç”Ÿéº¦äº‹ä»¶ç¢‘': {
                    name: 'ç”Ÿéº¦äº‹ä»¶ç¢‘',
                    period: 'å¹•æœ«ï¼ˆ1862å¹´9æœˆ14æ—¥ï¼‰',
                    history: 'è–©æ‘©è—©ä¸»ã®çˆ¶ãƒ»å³¶æ´¥ä¹…å…‰ã®è¡Œåˆ—ã‚’æ¨ªåˆ‡ã£ãŸã‚¤ã‚®ãƒªã‚¹äººã‚’è–©æ‘©è—©å£«ãŒæ®ºå‚·ã—ãŸäº‹ä»¶ã®ç¾å ´ã€‚ã“ã®äº‹ä»¶ãŒè–©è‹±æˆ¦äº‰ã®å¼•ãé‡‘ã¨ãªã‚Šã¾ã—ãŸã€‚',
                    highlights: 'å›½é“15å·ã¨æ—§æ±æµ·é“ã®äº¤å·®ç‚¹è§’ã«çŸ³ç¢‘ãŒå»ºç«‹ã•ã‚Œã¦ãŠã‚Šã€å¹•æœ«ã®æ¿€å‹•ã‚’ç‰©èªã‚‹é‡è¦ãªå²è·¡ã§ã™ã€‚',
                    tips: 'äº¤å·®ç‚¹ã®è§’ãªã®ã§ã€è‡ªè»¢è»Šã§é€šéæ™‚ã¯å®‰å…¨ã«é…æ…®ã—ãªãŒã‚‰æ•°ç§’ã§ç¢ºèªã§ãã¾ã™ã€‚',
                    url: 'https://trip.pref.kanagawa.jp/sc/destination/scene-of-the-namamugi-incident-and-monument/140'
                },
                'ç¥å¥ˆå·å®¿æ­´å²ã®é“': {
                    name: 'ç¥å¥ˆå·å®¿æ­´å²ã®é“',
                    period: 'æ±Ÿæˆ¸æ™‚ä»£å‰æœŸã€œæ˜æ²»æ™‚ä»£ï¼ˆ1601å¹´ã€œï¼‰',
                    history: 'æ±æµ·é“äº”åä¸‰æ¬¡ã®3ç•ªç›®ã®å®¿å ´ã€‚ãƒšãƒªãƒ¼æ¥èˆªå¾Œã¯å¤–å›½äººå±…ç•™åœ°ã¨ã—ã¦ã‚‚ç™ºå±•ã—ã€é–‹æ¸¯å ´æ¨ªæµœã®ç„é–¢å£ã§ã—ãŸã€‚',
                    highlights: 'å‚é“æ²¿ã„ã®è§£èª¬ãƒ‘ãƒãƒ«ã¨ã€è¢–ãƒ¶æµ¦ã®å…¥æ±Ÿè·¡ã‚’è¦‹ä¸‹ã‚ã™é«˜å°ã‹ã‚‰ã®æ™¯è¦³ã€‚å½“æ™‚ã®å®¿å ´ç”ºã®æ§˜å­ãŒæƒ³åƒã§ãã¾ã™ã€‚',
                    tips: 'å‚é“ãªã®ã§ã€ã‚†ã£ãã‚Šã¨ç™»ã‚ŠãªãŒã‚‰è¡—è·¯æ¨¹ã®é–“ã®è§£èª¬ãƒ‘ãƒãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚',
                    url: 'https://www.kanagawa-kankou.or.jp/features/tokaido-column515943'
                },
                'ç¥å¥ˆå·å®¿æ­´å²ã®é“æ¡ˆå†…æ¿': {
                    name: 'ç¥å¥ˆå·å®¿"æ­´å²ã®é“"æ¡ˆå†…æ¿',
                    period: 'æ±Ÿæˆ¸æ™‚ä»£ï¼ˆ1601å¹´ã€œ1868å¹´ï¼‰',
                    history: 'æ±æµ·é“ã§æ±Ÿæˆ¸ã‹ã‚‰3ç•ªç›®ã®å®¿å ´ç”ºã€‚å‚é“ã«æœ¬é™£è·¡ã‚„å®¿å ´çµµå›³ãƒ‘ãƒãƒ«ãŒè¨­ç½®ã•ã‚Œã€æ±Ÿæˆ¸æ™‚ä»£ã®å®¿å ´ã®æ§˜å­ã‚’ç¾ä»£ã«ä¼ãˆã¦ã„ã¾ã™ã€‚',
                    highlights: 'å‚ä¸Šã®ãƒ“ãƒ«å£é¢ã«æã‹ã‚ŒãŸæµ®ä¸–çµµãƒ¬ãƒ—ãƒªã‚«ã¨ã€è©³ç´°ãªå®¿å ´çµµå›³ãƒ‘ãƒãƒ«ãŒè¦‹ã©ã“ã‚ã§ã™ã€‚',
                    tips: 'å‚é“ã®å°ç”ºå‚æ²¿ã„ã«è¤‡æ•°ã®æ¡ˆå†…æ¿ãŒã‚ã‚‹ã®ã§ã€å®‰å…¨ãªå ´æ‰€ã§ä¸€æ™‚åœæ­¢ã—ã¦ç¢ºèªã—ã¦ãã ã•ã„ã€‚',
                    url: 'https://www.city.yokohama.lg.jp/kanagawa/shokai/rekishi/syuku.html'
                },
                'é¦¬è»Šé“': {
                    name: 'é¦¬è»Šé“ï¼ˆãƒã‚·ãƒ£ãƒŸãƒï¼‰',
                    period: 'æ˜æ²»æ™‚ä»£åˆæœŸï¼ˆ1866å¹´ã€œï¼‰',
                    history: '1866å¹´ã«é–‹å‰Šã•ã‚ŒãŸæ—¥æœ¬åˆã®ã€Œé¦¬è»ŠãŒé€šã‚‹é“ã€ã€‚æ¨ªæµœé–‹æ¸¯ã«ä¼´ã„ã€å¤–å›½äººãŒé¦¬è»Šã§é–¢å†…ã¨ç¥å¥ˆå·å®¿ã‚’çµã¶ãŸã‚ã«æ•´å‚™ã•ã‚Œã¾ã—ãŸã€‚',
                    highlights: 'çŸ³ç•³ã®è·¯é¢ã¨æ˜æ²»åˆæœŸã®ã‚¬ã‚¹ç¯ã®ãƒ¬ãƒ—ãƒªã‚«ã€"Carriage Road"ã®éŠ˜æ¿ãŒå½“æ™‚ã®é¢å½±ã‚’æ®‹ã—ã¦ã„ã¾ã™ã€‚',
                    tips: 'é¦¬è»Šé“äº¤å·®ç‚¹ä»˜è¿‘ã§ã€è·¯è‚©ã®ã‚¬ã‚¹ç¯ãƒ¬ãƒ—ãƒªã‚«ã¨çŸ³ç•³ã«æ³¨ç›®ã—ã¦ãã ã•ã„ã€‚',
                    url: 'https://yokohamatravelguide.com/bashamichi-yokohamas-historic-gem/'
                },
                'æ¨ªæµœä¸‰å¡”': {
                    name: 'æ¨ªæµœä¸‰å¡”ï¼ˆKingãƒ»Queenãƒ»Jackï¼‰',
                    period: 'å¤§æ­£ã€œæ˜­å’ŒåˆæœŸï¼ˆ1920å¹´ä»£ã€œ1930å¹´ä»£ï¼‰',
                    history: 'èˆ¹ä¹—ã‚ŠãŒæ¨ªæµœæ¸¯ã¸ã®èˆªè·¯æ¨™è­˜ã¨ã—ã¦åˆ©ç”¨ã—ãŸ3ã¤ã®å¡”ã€‚çœŒåºï¼ˆKingï¼‰ã€ç¨é–¢ï¼ˆQueenï¼‰ã€é–‹æ¸¯è¨˜å¿µä¼šé¤¨ï¼ˆJackï¼‰ã¨ã—ã¦è¦ªã—ã¾ã‚Œã¦ã„ã¾ã™ã€‚',
                    highlights: 'çœŒåºã®å¸å† æ§˜å¼ã€ç¨é–¢ã®ã‚¤ã‚¹ãƒ©ãƒ é¢¨ãƒ‰ãƒ¼ãƒ ã€é–‹æ¸¯è¨˜å¿µä¼šé¤¨ã®æ™‚è¨ˆå¡”ãªã©ã€ãã‚Œãã‚Œç•°ãªã‚‹å»ºç¯‰æ§˜å¼ãŒæ¥½ã—ã‚ã¾ã™ã€‚',
                    tips: 'ã¿ãªã¨ã¿ã‚‰ã„æ–¹é¢ã«å‘ã‹ã†éš›ã€3ã¤ã®å¡”ã‚’åŒæ™‚ã«è¦‹æ¸¡ã›ã‚‹ãƒã‚¤ãƒ³ãƒˆãŒã‚ã‚Šã¾ã™ã€‚',
                    url: 'https://www.yokohamajapan.com/things-to-do/detail.php?id=54'
                },
                'æ¨ªæµœèµ¤ãƒ¬ãƒ³ã‚¬å€‰åº«': {
                    name: 'æ¨ªæµœèµ¤ãƒ¬ãƒ³ã‚¬å€‰åº«',
                    period: 'æ˜æ²»æœ«æœŸã€œå¤§æ­£åˆæœŸï¼ˆ1911å¹´ãƒ»1913å¹´ç«£å·¥ï¼‰',
                    history: 'æ˜æ²»æ”¿åºœãŒå»ºè¨­ã—ãŸç¨é–¢å€‰åº«ã€‚é–¢æ±å¤§éœ‡ç½ã§ã‚‚å€’å£Šã—ãªã‹ã£ãŸè€éœ‡ç…‰ç“¦æ§‹é€ ã§ã€æ¨ªæµœæ¸¯ã®ç‰©æµæ‹ ç‚¹ã¨ã—ã¦æ´»èºã—ã¾ã—ãŸã€‚',
                    highlights: 'èµ¤ç…‰ç“¦ã®é‡åšãªå¤–è¦³ã¨ã€ç¾åœ¨ã¯æ–‡åŒ–ãƒ»å•†æ¥­æ–½è¨­ã¨ã—ã¦ç”Ÿã¾ã‚Œå¤‰ã‚ã£ãŸå†…éƒ¨ç©ºé–“ã®èª¿å’ŒãŒè¦‹ã©ã“ã‚ã§ã™ã€‚',
                    tips: 'è‡ªè»¢è»Šã§æ¥è¿‘ã™ã‚‹éš›ã€ç…‰ç“¦ã®è³ªæ„Ÿã¨å»ºç‰©ã®è¿«åŠ›ã‚’é–“è¿‘ã§æ„Ÿã˜ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚',
                    url: 'https://en.wikipedia.org/wiki/Yokohama_Red_Brick_Warehouse'
                },
                'æ—§æ ¹å²¸ç«¶é¦¬å ´': {
                    name: 'æ—§æ ¹å²¸ç«¶é¦¬å ´ä¸€ç­‰è¦³è¦§å¸­è·¡',
                    period: 'æ˜æ²»åˆæœŸï¼ˆ1866å¹´é–‹è¨­ï¼‰',
                    history: 'æ—¥æœ¬æœ€å¤ã®æ´‹å¼ç«¶é¦¬å ´ã€‚å¤–å›½äººå±…ç•™æ°‘ã«ã‚ˆã‚Šé–‹è¨­ã•ã‚Œã€æˆ¦å‰ã¾ã§ã€Œæ±æ´‹ä¸€ã®ç«¶é¦¬å ´ã€ã¨ã—ã¦è¦ªã—ã¾ã‚Œã¾ã—ãŸã€‚æˆ¦å¾Œã¯ç±³è»ã«æ¥åã•ã‚Œã¾ã—ãŸã€‚',
                    highlights: 'ç¾åœ¨ã‚‚æ®‹ã‚‹ç™½ã„çŸ³é€ ã®ä¸€ç­‰è¦³è¦§å¸­è·¡ã¯ã€æ˜æ²»æ™‚ä»£ã®æ´‹å¼å»ºç¯‰ã®è²´é‡ãªéºæ§‹ã§ã™ã€‚',
                    tips: 'å›½é“357å·ã‹ã‚‰å·¦å‰æ–¹ã®é«˜å°ã‚’è¦‹ä¸Šã’ã‚‹ã¨ã€ç™½ã„å»ºç‰©ãŒç¢ºèªã§ãã¾ã™ã€‚',
                    url: 'https://offbeatjapan.com/negishi-racecourse-yokohama-story/'
                }
            };
            
            return historyDatabase[locationName] || {
                name: locationName,
                period: 'è©³ç´°æƒ…å ±ãªã—',
                history: 'ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ãŒã€ã“ã®å ´æ‰€ã®è©³ç´°ãªæ­´å²æƒ…å ±ã¯ç¾åœ¨æº–å‚™ä¸­ã§ã™ã€‚',
                highlights: 'ç¾åœ°ã§ã®è¦³å¯Ÿã‚’ãŠæ¥½ã—ã¿ãã ã•ã„ã€‚',
                tips: '',
                url: '#'
            };
        }
        function showSetupGuide() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0, 0, 0, 0.8); z-index: 1000;
                display: flex; align-items: center; justify-content: center;
                overflow-y: auto;
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: white; border-radius: 8px; padding: 20px;
                max-width: 600px; max-height: 80vh; overflow-y: auto;
                margin: 20px;
            `;
            
            content.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #dee2e6;">
                    <h3 style="margin: 0; color: var(--primary-color);">ğŸ“– ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ©Ÿèƒ½è¨­å®šã‚¬ã‚¤ãƒ‰</h3>
                    <button onclick="this.closest('.modal').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6c757d;">&times;</button>
                </div>
                
                <div style="line-height: 1.6;">
                    <div style="background: #e8f4fd; padding: 12px; border-radius: 6px; margin-bottom: 15px;">
                        <strong>âœ… ç¾åœ¨åˆ©ç”¨å¯èƒ½ãªæ©Ÿèƒ½ï¼ˆç™»éŒ²ä¸è¦ï¼‰</strong>
                        <ul style="margin: 8px 0; padding-left: 20px;">
                            <li>ğŸŒ¤ï¸ å¤©æ°—æƒ…å ±ï¼ˆOpen-Meteo APIï¼‰</li>
                            <li>ğŸ“… ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±ï¼ˆé–‹å‚¬ãƒ‘ã‚¿ãƒ¼ãƒ³æ¨å®šï¼‰</li>
                            <li>ğŸšƒ äº¤é€šæƒ…å ±ï¼ˆæ™‚é–“å¸¯ãƒ»å¤©å€™æ¨å®šï¼‰</li>
                            <li>ğŸª å–¶æ¥­æ™‚é–“ãƒã‚§ãƒƒã‚¯</li>
                        </ul>
                    </div>
                    
                    <div style="background: #fff3cd; padding: 12px; border-radius: 6px; margin-bottom: 15px;">
                        <strong>ğŸš€ 5åˆ†ã§æ”¹å–„ã§ãã‚‹è¨­å®šï¼ˆç„¡æ–™ï¼‰</strong>
                        <div style="margin-top: 10px;">
                            <strong>OpenWeatherMap APIï¼ˆæ¨å¥¨ï¼‰</strong>
                            <ol style="margin: 8px 0; padding-left: 20px; font-size: 14px;">
                                <li><a href="https://openweathermap.org/" target="_blank" style="color: #007bff;">OpenWeatherMap</a> ã«ã‚¢ã‚¯ã‚»ã‚¹</li>
                                <li>ã€ŒSign Upã€ã§ç„¡æ–™ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ</li>
                                <li>ã€ŒAPI Keysã€ãƒšãƒ¼ã‚¸ã§ã‚­ãƒ¼ã‚’ã‚³ãƒ”ãƒ¼</li>
                                <li>ãƒ–ãƒ©ã‚¦ã‚¶ã®é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«ã§API_CONFIG.openweather.keyã«è¨­å®š</li>
                            </ol>
                            <div style="background: #f8f9fa; padding: 8px; border-radius: 4px; font-family: monospace; font-size: 12px; margin-top: 8px;">
                                API_CONFIG.openweather.key = 'YOUR_API_KEY';
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: #d4edda; padding: 12px; border-radius: 6px; margin-bottom: 15px;">
                        <strong>ğŸ“ˆ è¨­å®šå¾Œã®æ”¹å–„ç‚¹</strong>
                        <ul style="margin: 8px 0; padding-left: 20px; font-size: 14px;">
                            <li>ã‚ˆã‚Šæ­£ç¢ºãªå¤©æ°—äºˆå ±ãƒ»é™æ°´ç¢ºç‡</li>
                            <li>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ°—è±¡ã‚¢ãƒ©ãƒ¼ãƒˆ</li>
                            <li>æ™‚é–“å˜ä½ã®è©³ç´°äºˆå ±</li>
                            <li>é¢¨é€Ÿãƒ»æ°—åœ§ãªã©ã®è©³ç´°æƒ…å ±</li>
                        </ul>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 12px; border-radius: 6px;">
                        <strong>ğŸ’¡ ç¾åœ¨ã®æ©Ÿèƒ½ã§ã‚‚å……åˆ†ã§ã™</strong>
                        <p style="margin: 8px 0; font-size: 14px;">
                            ã“ã®ã‚¢ãƒ—ãƒªã¯ä¼šå“¡ç™»éŒ²ä¸è¦ã§ã‚‚å®Ÿç”¨çš„ãªæƒ…å ±ã‚’æä¾›ã—ã¾ã™ã€‚
                            ã‚ˆã‚Šè©³ç´°ãªæƒ…å ±ãŒå¿…è¦ãªå ´åˆã®ã¿ã€ä¸Šè¨˜ã®è¨­å®šã‚’è¡Œã£ã¦ãã ã•ã„ã€‚
                        </p>
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button onclick="this.closest('.modal').remove()" style="padding: 10px 30px; background: var(--secondary-color); color: white; border: none; border-radius: 4px; cursor: pointer;">
                        äº†è§£ã—ã¾ã—ãŸ
                    </button>
                </div>
            `;
            
            modal.appendChild(content);
            modal.className = 'modal';
            document.body.appendChild(modal);
            
            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®å¤–å´ã‚’ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }
        
        // ç·Šæ€¥æƒ…å ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®è¿½åŠ 
        function addEmergencyInfoSection() {
            const controlPanel = document.getElementById('controlPanel');
            const emergencySection = document.createElement('div');
            emergencySection.id = 'emergencySection';
            emergencySection.style.marginBottom = 'var(--spacing-md)';
            
            emergencySection.innerHTML = `
                <h3>ğŸš¨ ç·Šæ€¥ãƒ»é‡è¦æƒ…å ±</h3>
                <div id="emergencyAlerts" style="font-size: 12px;">
                    <div style="color: var(--text-muted); text-align: center; padding: 8px;">
                        ç¾åœ¨ã€é‡è¦ãªè­¦å‘Šã¯ã‚ã‚Šã¾ã›ã‚“
                    </div>
                </div>
                <button class="time-btn" onclick="checkEmergencyInfo()" style="width: 100%; margin-top: 8px;">
                    ğŸ”„ ç·Šæ€¥æƒ…å ±ç¢ºèª
                </button>
            `;
            
            // å¤©æ°—ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®å‰ã«æŒ¿å…¥
            const weatherSection = document.getElementById('weatherSection');
            if (weatherSection) {
                controlPanel.insertBefore(emergencySection, weatherSection);
            } else {
                controlPanel.appendChild(emergencySection);
            }
        }
        
        // ç·Šæ€¥æƒ…å ±ãƒã‚§ãƒƒã‚¯
        async function checkEmergencyInfo() {
            try {
                const alerts = [];
                
                // å¤©æ°—ã«ã‚ˆã‚‹è­¦å‘Š
                if (realtimeCache.weather.data) {
                    const current = realtimeCache.weather.data.current;
                    if (current.weather[0].main === 'Thunderstorm') {
                        alerts.push({
                            type: 'weather',
                            level: 'high',
                            message: 'â›ˆï¸ é›·é›¨è­¦å ±ç™ºä»¤ä¸­ã€‚å±‹å¤–æ´»å‹•ã¯æ§ãˆã¦ãã ã•ã„ã€‚',
                            color: '#dc3545'
                        });
                    } else if (current.weather[0].main === 'Rain' && current.rain && current.rain['1h'] > 20) {
                        alerts.push({
                            type: 'weather',
                            level: 'medium',
                            message: 'ğŸŒ§ï¸ å¤§é›¨æ³¨æ„ã€‚è‡ªè»¢è»Šåˆ©ç”¨ã¯å±é™ºã§ã™ã€‚',
                            color: '#fd7e14'
                        });
                    }
                }
                
                // äº¤é€šæ©Ÿé–¢ã«ã‚ˆã‚‹è­¦å‘Š
                if (realtimeCache.traffic.data) {
                    const majorDelays = realtimeCache.traffic.data.filter(route => route.status.delay > 10);
                    if (majorDelays.length > 0) {
                        alerts.push({
                            type: 'traffic',
                            level: 'medium',
                            message: `ğŸšƒ ${majorDelays.length}è·¯ç·šã§å¤§å¹…é…ã‚Œã€‚æ™‚é–“ã«ä½™è£•ã‚’æŒã£ã¦ãã ã•ã„ã€‚`,
                            color: '#ffc107'
                        });
                    }
                }
                
                // æ™‚é–“ã«ã‚ˆã‚‹è­¦å‘Š
                const now = new Date();
                const currentHour = now.getHours();
                if (currentHour >= 22 || currentHour <= 5) {
                    alerts.push({
                        type: 'time',
                        level: 'low',
                        message: 'ğŸŒ™ å¤œé–“æ™‚é–“å¸¯ã€‚ä¸€éƒ¨åº—èˆ—ãŒå–¶æ¥­ã—ã¦ã„ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚',
                        color: '#6c757d'
                    });
                }
                
                updateEmergencyDisplay(alerts);
                
            } catch (error) {
                console.error('ç·Šæ€¥æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
            }
        }
        
        function updateEmergencyDisplay(alerts) {
            const alertsContainer = document.getElementById('emergencyAlerts');
            
            if (alerts.length === 0) {
                alertsContainer.innerHTML = `
                    <div style="color: var(--text-muted); text-align: center; padding: 8px;">
                        ç¾åœ¨ã€é‡è¦ãªè­¦å‘Šã¯ã‚ã‚Šã¾ã›ã‚“
                    </div>
                `;
            } else {
                alertsContainer.innerHTML = alerts.map(alert => `
                    <div style="margin-bottom: 8px; padding: 8px; border-left: 4px solid ${alert.color}; background: rgba(${hexToRgb(alert.color)}, 0.1); border-radius: 4px;">
                        ${alert.message}
                    </div>
                `).join('');
            }
        }
        
        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? 
                `${parseInt(result[1], 16)}, ${parseInt(result[2], 16)}, ${parseInt(result[3], 16)}` : 
                '0, 0, 0';
        }
        
        // ãƒ‡ãƒ¼ã‚¿ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç®¡ç†
        function isDataCached(type) {
            const cache = realtimeCache[type];
            if (!cache || !cache.data) return false;
            return (Date.now() - cache.timestamp) < cache.ttl;
        }
        
        function clearCache(type) {
            if (type) {
                realtimeCache[type] = { data: null, timestamp: 0, ttl: realtimeCache[type].ttl };
            } else {
                Object.keys(realtimeCache).forEach(key => {
                    realtimeCache[key] = { data: null, timestamp: 0, ttl: realtimeCache[key].ttl };
                });
            }
        }
        
        // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ã®é–‹å§‹
        function startRealtimeUpdates() {
            // 5åˆ†ã”ã¨ã«å¤©æ°—æƒ…å ±ã‚’æ›´æ–°
            setInterval(() => {
                if (!isDataCached('weather')) {
                    getWeatherData();
                }
            }, 300000);
            
            // 30åˆ†ã”ã¨ã«ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±ã‚’æ›´æ–°
            setInterval(() => {
                checkEventStatus();
            }, 1800000);
            
            // 1æ™‚é–“ã”ã¨ã«å–¶æ¥­æ™‚é–“ã‚’ãƒã‚§ãƒƒã‚¯
            setInterval(() => {
                checkBusinessHours();
            }, 3600000);
        }
        
        // ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒã‚§ãƒƒã‚¯ï¼ˆå…¬é–‹ãƒ‡ãƒ¼ã‚¿ä½¿ç”¨ï¼‰
        async function checkEventStatus() {
            try {
                if (isDataCached('events')) {
                    updateEventStatus(realtimeCache.events.data);
                    return;
                }
                
                const events = [
                    {
                        name: 'æ°´ç”£ä»²å¸æ£Ÿ ä¸€èˆ¬é–‹æ”¾',
                        location: 'æ¨ªæµœå¸‚ä¸­å¤®å¸å£²å¸‚å ´',
                        startTime: '08:00',
                        endTime: '10:00',
                        date: '2025-07-19',
                        type: 'market',
                        url: 'https://www.city.yokohama.lg.jp/business/kigyoushien/suisan/ichiba/',
                        schedule: 'monthly_third_saturday' // æ¯æœˆç¬¬3åœŸæ›œæ—¥
                    },
                    {
                        name: 'æ¨ªæµœåŒ—ä»²ãƒãƒ«ã‚·ã‚§',
                        location: 'åŒ—ä»²ãƒ–ãƒªãƒƒã‚¯ï¼†ãƒ›ãƒ¯ã‚¤ãƒˆ',
                        startTime: '11:00',
                        endTime: '16:00',
                        date: '2025-07-19',
                        type: 'marche',
                        url: 'https://kitanaka-marche.jp/',
                        schedule: 'monthly'
                    },
                    {
                        name: 'BAY WALK MARKET',
                        location: 'èµ¤ãƒ¬ãƒ³ã‚¬å€‰åº«',
                        startTime: '10:00',
                        endTime: '17:00',
                        date: '2025-07-19',
                        type: 'market',
                        url: 'https://akarenga.jp/event/',
                        schedule: 'weekend'
                    },
                    {
                        name: 'å…­è§’æ©‹ãƒ¤ãƒŸå¸‚',
                        location: 'å…­è§’æ©‹å•†åº—è¡—',
                        startTime: '18:00',
                        endTime: '22:00',
                        date: '2025-07-19',
                        type: 'night_market',
                        url: 'https://rokkakubashi.com/',
                        schedule: 'monthly_third_saturday'
                    }
                ];
                
                // å„ã‚¤ãƒ™ãƒ³ãƒˆã®ç¾åœ¨ã®çŠ¶æ³ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆå…¬é–‹æƒ…å ±ãƒ™ãƒ¼ã‚¹ï¼‰
                const eventStatuses = events.map(event => {
                    const status = checkEventStatusFromPublicData(event);
                    return { ...event, status };
                });
                
                // è¿½åŠ ã§å…¬é–‹RSSãƒ•ã‚£ãƒ¼ãƒ‰ã‹ã‚‰æƒ…å ±ã‚’å–å¾—ï¼ˆå¯èƒ½ãªå ´åˆï¼‰
                const additionalEvents = await fetchPublicEventFeeds();
                if (additionalEvents.length > 0) {
                    eventStatuses.push(...additionalEvents);
                }
                
                realtimeCache.events = {
                    data: eventStatuses,
                    timestamp: Date.now(),
                    ttl: 1800000
                };
                
                updateEventStatus(eventStatuses);
                
            } catch (error) {
                console.error('ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                showNotification('ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ', 'warning');
            }
        }
        
        // å…¬é–‹ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ã‚¤ãƒ™ãƒ³ãƒˆçŠ¶æ³ã‚’åˆ¤å®š
        function checkEventStatusFromPublicData(event) {
            const now = new Date();
            const eventDate = new Date(event.date);
            const startTime = new Date(`${event.date}T${event.startTime}:00`);
            const endTime = new Date(`${event.date}T${event.endTime}:00`);
            
            // å®šæœŸé–‹å‚¬ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯
            if (event.schedule === 'monthly_third_saturday') {
                const isThirdSaturday = checkIfThirdSaturday(eventDate);
                if (!isThirdSaturday) {
                    return {
                        status: 'not_scheduled',
                        message: 'é–‹å‚¬æ—¥ã§ã¯ã‚ã‚Šã¾ã›ã‚“',
                        color: '#6c757d',
                        note: 'æ¯æœˆç¬¬3åœŸæ›œæ—¥é–‹å‚¬'
                    };
                }
            }
            
            if (now < eventDate.setHours(0, 0, 0, 0)) {
                return { 
                    status: 'upcoming', 
                    message: 'é–‹å‚¬äºˆå®š',
                    color: '#ffc107'
                };
            } else if (now >= startTime && now <= endTime) {
                return { 
                    status: 'active', 
                    message: 'é–‹å‚¬ä¸­',
                    color: '#28a745'
                };
            } else if (now > endTime) {
                return { 
                    status: 'ended', 
                    message: 'çµ‚äº†',
                    color: '#6c757d'
                };
            } else {
                // å½“æ—¥ã ãŒé–‹å§‹å‰
                return { 
                    status: 'today', 
                    message: 'æœ¬æ—¥é–‹å‚¬',
                    color: '#007bff'
                };
            }
        }
        
        // ç¬¬3åœŸæ›œæ—¥ã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯
        function checkIfThirdSaturday(date) {
            const year = date.getFullYear();
            const month = date.getMonth();
            
            // ãã®æœˆã®ç¬¬3åœŸæ›œæ—¥ã‚’è¨ˆç®—
            let thirdSaturday = new Date(year, month, 1);
            let saturdayCount = 0;
            
            while (saturdayCount < 3) {
                if (thirdSaturday.getDay() === 6) { // åœŸæ›œæ—¥
                    saturdayCount++;
                    if (saturdayCount === 3) break;
                }
                thirdSaturday.setDate(thirdSaturday.getDate() + 1);
            }
            
            return date.getDate() === thirdSaturday.getDate();
        }
        
        // å…¬é–‹ã‚¤ãƒ™ãƒ³ãƒˆãƒ•ã‚£ãƒ¼ãƒ‰ã®å–å¾—ï¼ˆCORSåˆ¶é™ãŒã‚ã‚‹ãŸã‚é™å®šçš„ï¼‰
        async function fetchPublicEventFeeds() {
            try {
                // æ³¨æ„: CORSåˆ¶é™ã«ã‚ˆã‚Šã€ç›´æ¥ã®RSSãƒ•ã‚£ãƒ¼ãƒ‰å–å¾—ã¯åˆ¶é™ã•ã‚Œã‚‹å ´åˆãŒã‚ã‚Šã¾ã™
                // å®Ÿéš›ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯ã€ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§ãƒ—ãƒ­ã‚­ã‚·ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™
                
                const events = [];
                
                // æ¨ªæµœå¸‚ã®å…¬é–‹ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±ï¼ˆJSONãŒåˆ©ç”¨å¯èƒ½ãªå ´åˆï¼‰
                try {
                    // ä¾‹: å…¬é–‹JSONã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒã‚ã‚‹å ´åˆ
                    // const response = await fetch('https://www.city.yokohama.lg.jp/api/events.json');
                    // if (response.ok) {
                    //     const data = await response.json();
                    //     events.push(...parseYokohamaEvents(data));
                    // }
                } catch (e) {
                    console.log('æ¨ªæµœå¸‚ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±å–å¾—ã‚¹ã‚­ãƒƒãƒ—:', e.message);
                }
                
                // ãã®ä»–ã®å…¬é–‹ãƒ•ã‚£ãƒ¼ãƒ‰
                // å®Ÿéš›ã«ã¯ã€CORSåˆ¶é™ã‚’å›é¿ã™ã‚‹ãŸã‚ã«ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ãƒ—ãƒ­ã‚­ã‚·ãŒå¿…è¦
                
                return events;
                
            } catch (error) {
                console.error('å…¬é–‹ã‚¤ãƒ™ãƒ³ãƒˆãƒ•ã‚£ãƒ¼ãƒ‰å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                return [];
            }
        }
        
        function updateEventStatus(eventStatuses) {
            const eventItems = document.querySelectorAll('.timeline-item.event');
            
            eventItems.forEach((item, index) => {
                const location = item.getAttribute('data-location');
                const eventData = eventStatuses.find(event => 
                    event.location.includes(location) || event.name.includes(location)
                );
                
                if (eventData) {
                    let statusIndicator = item.querySelector('.status-indicator');
                    if (!statusIndicator) {
                        statusIndicator = document.createElement('div');
                        statusIndicator.className = 'status-indicator';
                        item.querySelector('.timeline-card').appendChild(statusIndicator);
                    }
                    
                    statusIndicator.textContent = eventData.status.message;
                    statusIndicator.style.backgroundColor = eventData.status.color;
                    statusIndicator.style.color = 'white';
                    
                    // ã‚¤ãƒ™ãƒ³ãƒˆè©³ç´°ã‚’è¿½åŠ 
                    let eventInfo = item.querySelector('.event-info');
                    if (!eventInfo) {
                        eventInfo = document.createElement('div');
                        eventInfo.className = 'event-info';
                        eventInfo.style.cssText = 'margin-top: 8px; padding: 8px; background: #f8f9fa; border-radius: 4px; font-size: 12px;';
                        item.querySelector('.timeline-card').appendChild(eventInfo);
                    }
                    
                    eventInfo.innerHTML = `
                        <strong>ğŸ“… ${eventData.status.message}</strong><br>
                        â° ${eventData.startTime} - ${eventData.endTime}<br>
                        <a href="${eventData.url}" target="_blank" style="color: var(--secondary-color);">
                            ğŸ”— å…¬å¼ã‚µã‚¤ãƒˆç¢ºèª
                        </a>
                    `;
                }
            });
        }
        
        // å–¶æ¥­æ™‚é–“ãƒã‚§ãƒƒã‚¯æ©Ÿèƒ½
        async function checkBusinessHours() {
            const businesses = [
                {
                    name: 'ãƒ©ãƒ¼ãƒ¡ãƒ³æœ«å»£å®¶',
                    hours: {
                        monday: { open: '11:00', close: '22:00' },
                        tuesday: { open: '11:00', close: '22:00' },
                        wednesday: { open: '11:00', close: '22:00' },
                        thursday: { open: '11:00', close: '22:00' },
                        friday: { open: '11:00', close: '22:00' },
                        saturday: { open: '11:00', close: '22:00' },
                        sunday: { open: '11:00', close: '22:00' }
                    },
                    closedDays: []
                },
                {
                    name: 'æ‰ç”°å®¶æœ¬åº—',
                    hours: {
                        monday: { open: '11:00', close: '21:00' },
                        tuesday: null, // å®šä¼‘æ—¥
                        wednesday: { open: '11:00', close: '21:00' },
                        thursday: { open: '11:00', close: '21:00' },
                        friday: { open: '11:00', close: '21:00' },
                        saturday: { open: '11:00', close: '21:00' },
                        sunday: { open: '11:00', close: '21:00' }
                    },
                    closedDays: ['tuesday']
                },
                {
                    name: 'çˆç²æ–‡æ˜',
                    hours: {
                        monday: { open: '08:00', close: '18:00' },
                        tuesday: { open: '08:00', close: '18:00' },
                        wednesday: { open: '08:00', close: '18:00' },
                        thursday: { open: '08:00', close: '18:00' },
                        friday: { open: '08:00', close: '18:00' },
                        saturday: { open: '08:00', close: '18:00' },
                        sunday: null // å®šä¼‘æ—¥
                    },
                    closedDays: ['sunday']
                }
            ];
            
            businesses.forEach(business => {
                updateBusinessStatus(business);
            });
        }
        
        function updateBusinessStatus(business) {
            const now = new Date();
            const dayNames = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
            const currentDay = dayNames[now.getDay()];
            const currentTime = now.getHours() * 60 + now.getMinutes();
            
            const dayHours = business.hours[currentDay];
            let status, message, color;
            
            if (!dayHours || business.closedDays.includes(currentDay)) {
                status = 'closed';
                message = 'å®šä¼‘æ—¥';
                color = '#dc3545';
            } else {
                const openTime = timeToMinutes(dayHours.open);
                const closeTime = timeToMinutes(dayHours.close);
                
                if (currentTime >= openTime && currentTime <= closeTime) {
                    status = 'open';
                    message = `å–¶æ¥­ä¸­ (${dayHours.close}ã¾ã§)`;
                    color = '#28a745';
                } else if (currentTime < openTime) {
                    status = 'closed';
                    message = `${dayHours.open}é–‹åº—äºˆå®š`;
                    color = '#ffc107';
                } else {
                    status = 'closed';
                    message = 'å–¶æ¥­çµ‚äº†';
                    color = '#dc3545';
                }
            }
            
            // DOMè¦ç´ ã‚’æ›´æ–°
            const businessItems = document.querySelectorAll('.timeline-item');
            businessItems.forEach(item => {
                const activityText = item.querySelector('.activity')?.textContent;
                if (activityText && activityText.includes(business.name)) {
                    let businessInfo = item.querySelector('.business-info');
                    if (!businessInfo) {
                        businessInfo = document.createElement('div');
                        businessInfo.className = 'business-info';
                        businessInfo.style.cssText = 'margin-top: 8px; padding: 6px 8px; border-radius: 4px; font-size: 12px; font-weight: 600;';
                        item.querySelector('.timeline-card').appendChild(businessInfo);
                    }
                    
                    businessInfo.textContent = message;
                    businessInfo.style.backgroundColor = color;
                    businessInfo.style.color = 'white';
                }
            });
        }
        
        function timeToMinutes(timeString) {
            const [hours, minutes] = timeString.split(':').map(Number);
            return hours * 60 + minutes;
        }

        // ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ«ã®è¡¨ç¤º/éè¡¨ç¤º
        function togglePanel() {
            const panel = document.getElementById('controlPanel');
            panel.classList.toggle('hidden');
        }

        // æ™‚é–“èª¿æ•´æ©Ÿèƒ½
        function adjustTime(minutes) {
            currentDelay += minutes;
            updateAllTimes();
            updateCurrentDelayDisplay();
            saveData();
        }

        function resetTime() {
            currentDelay = 0;
            updateAllTimes();
            updateCurrentDelayDisplay();
            saveData();
        }

        function updateAllTimes() {
            const timeElements = document.querySelectorAll('.time');
            timeElements.forEach(element => {
                const originalTime = element.getAttribute('data-original-time');
                if (originalTime) {
                    const adjustedTime = adjustTimeString(originalTime, currentDelay);
                    element.textContent = adjustedTime;
                }
            });
        }

        function adjustTimeString(timeString, delayMinutes) {
            const times = timeString.split('â€“');
            const adjustedTimes = times.map(time => {
                const [hours, minutes] = time.split(':').map(Number);
                const totalMinutes = hours * 60 + minutes + delayMinutes;
                const newHours = Math.floor(totalMinutes / 60);
                const newMinutes = totalMinutes % 60;
                return `${newHours.toString().padStart(2, '0')}:${newMinutes.toString().padStart(2, '0')}`;
            });
            return adjustedTimes.join('â€“');
        }

        function updateCurrentDelayDisplay() {
            const delayElement = document.getElementById('currentDelay');
            delayElement.textContent = `é…å»¶: ${currentDelay}åˆ†`;
        }

        // é€²è¡ŒçŠ¶æ³ç®¡ç†
        function toggleItemCompletion(index) {
            if (completedItems.has(index)) {
                completedItems.delete(index);
                document.querySelectorAll('.timeline-item')[index].classList.remove('completed');
            } else {
                completedItems.add(index);
                document.querySelectorAll('.timeline-item')[index].classList.add('completed');
            }
            updateProgress();
            saveData();
        }

        function updateProgress() {
            const totalItems = document.querySelectorAll('.timeline-item').length;
            const completedCount = completedItems.size;
            const progressPercentage = (completedCount / totalItems) * 100;
            
            document.getElementById('progressFill').style.width = `${progressPercentage}%`;
            document.getElementById('progressText').textContent = `${completedCount}/${totalItems} å®Œäº†`;
        }

        // ç¾åœ¨ã®ã‚¢ã‚¤ãƒ†ãƒ æ›´æ–°
        function updateCurrentItem() {
            const now = new Date();
            const timelineItems = document.querySelectorAll('.timeline-item');
            
            timelineItems.forEach((item, index) => {
                item.classList.remove('current');
                const timeElement = item.querySelector('.time');
                const timeString = timeElement.textContent;
                
                if (isCurrentTimeInRange(now, timeString)) {
                    item.classList.add('current');
                    currentItem = index;
                }
            });
        }

        function isCurrentTimeInRange(currentTime, timeString) {
            const currentMinutes = currentTime.getHours() * 60 + currentTime.getMinutes();
            
            if (timeString.includes('â€“')) {
                const [startTime, endTime] = timeString.split('â€“');
                const startMinutes = timeStringToMinutes(startTime);
                const endMinutes = timeStringToMinutes(endTime);
                return currentMinutes >= startMinutes && currentMinutes <= endMinutes;
            } else {
                const timeMinutes = timeStringToMinutes(timeString);
                return Math.abs(currentMinutes - timeMinutes) <= 30; // 30åˆ†ã®ç¯„å›²
            }
        }

        function timeStringToMinutes(timeString) {
            const [hours, minutes] = timeString.split(':').map(Number);
            return hours * 60 + minutes;
        }

        function updateCurrentTime() {
            updateCurrentItem();
        }

        // ä½ç½®æƒ…å ±æ©Ÿèƒ½
        function requestLocationPermission() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        locationPermission = true;
                        addLocationFeatures();
                    },
                    function(error) {
                        console.log('ä½ç½®æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
                    }
                );
            }
        }

        function addLocationFeatures() {
            // ä½ç½®æƒ…å ±é–¢é€£ã®æ©Ÿèƒ½ã‚’è¿½åŠ 
            const controlPanel = document.getElementById('controlPanel');
            const locationSection = document.createElement('div');
            locationSection.innerHTML = `
                <h3>ğŸ“ ç¾åœ¨åœ°æƒ…å ±</h3>
                <div id="locationInfo" style="margin-bottom: 1rem;">
                    <button class="time-btn" onclick="showNearbySpots()" style="width: 100%;">
                        å‘¨è¾ºã‚¹ãƒãƒƒãƒˆæ¤œç´¢
                    </button>
                </div>
            `;
            controlPanel.appendChild(locationSection);
        }

        function showNearbySpots() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    
                    // ç°¡å˜ãªå‘¨è¾ºã‚¹ãƒãƒƒãƒˆæƒ…å ±ã‚’è¡¨ç¤º
                    const locationInfo = document.getElementById('locationInfo');
                    locationInfo.innerHTML = `
                        <div style="font-size: 0.875rem; color: #6c757d;">
                            ç¾åœ¨åœ°: ${lat.toFixed(4)}, ${lon.toFixed(4)}<br>
                            <a href="https://maps.google.com/?q=${lat},${lon}" target="_blank" style="color: #3498db;">
                                Googleãƒãƒƒãƒ—ã§ç¢ºèª
                            </a>
                        </div>
                        <button class="time-btn" onclick="showNearbySpots()" style="width: 100%; margin-top: 8px;">
                            å†å–å¾—
                        </button>
                    `;
                });
            }
        }

        // å¤©æ°—æƒ…å ±æ©Ÿèƒ½ï¼ˆä¼šå“¡ç™»éŒ²ä¸è¦ç‰ˆï¼‰
        async function getWeatherData() {
            try {
                // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚§ãƒƒã‚¯
                if (isDataCached('weather')) {
                    updateWeatherDisplay(realtimeCache.weather.data);
                    return;
                }
                
                // è¤‡æ•°ã®ã‚½ãƒ¼ã‚¹ã‹ã‚‰å¤©æ°—æƒ…å ±ã‚’å–å¾—
                const weatherData = await getWeatherFromMultipleSources();
                
                if (weatherData) {
                    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜
                    realtimeCache.weather = {
                        data: weatherData,
                        timestamp: Date.now(),
                        ttl: 600000
                    };
                    
                    updateWeatherDisplay(weatherData);
                } else {
                    throw new Error('å¤©æ°—æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
                
            } catch (error) {
                console.error('å¤©æ°—æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                showNotification('å¤©æ°—æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ', 'warning');
                fallbackWeatherDisplay();
            }
        }
        
        // è¤‡æ•°ã‚½ãƒ¼ã‚¹ã‹ã‚‰å¤©æ°—æƒ…å ±ã‚’å–å¾—ï¼ˆä¼šå“¡ç™»éŒ²ä¸è¦ï¼‰
        async function getWeatherFromMultipleSources() {
            try {
                // 1. Open-Meteo APIï¼ˆå®Œå…¨ç„¡æ–™ãƒ»ç™»éŒ²ä¸è¦ï¼‰
                const openMeteoData = await getOpenMeteoWeather();
                if (openMeteoData) return openMeteoData;
                
                // 2. wttr.inï¼ˆãƒ†ã‚­ã‚¹ãƒˆãƒ™ãƒ¼ã‚¹å¤©æ°—APIï¼‰
                const wttrData = await getWttrWeather();
                if (wttrData) return wttrData;
                
                // 3. å…¬é–‹æ°—è±¡ãƒ‡ãƒ¼ã‚¿
                const publicData = await getPublicWeatherData();
                if (publicData) return publicData;
                
                return null;
            } catch (error) {
                console.error('å…¨ã¦ã®å¤©æ°—ã‚½ãƒ¼ã‚¹ã§å¤±æ•—:', error);
                return null;
            }
        }
        
        // Open-Meteo APIï¼ˆå®Œå…¨ç„¡æ–™ãƒ»ç™»éŒ²ä¸è¦ï¼‰
        async function getOpenMeteoWeather() {
            try {
                // æ¨ªæµœã®åº§æ¨™
                const lat = 35.4478;
                const lon = 139.6425;
                
                const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&hourly=temperature_2m,precipitation_probability,weather_code&timezone=Asia/Tokyo&forecast_days=1`;
                
                const response = await fetch(url);
                if (!response.ok) throw new Error('Open-Meteo APIå¤±æ•—');
                
                const data = await response.json();
                
                return {
                    current: {
                        temp: Math.round(data.current_weather.temperature),
                        weather: [{
                            main: getWeatherFromCode(data.current_weather.weathercode),
                            description: getWeatherDescription(data.current_weather.weathercode),
                            icon: getIconFromCode(data.current_weather.weathercode)
                        }],
                        main: {
                            temp: data.current_weather.temperature,
                            humidity: 60 // æ¨å®šå€¤
                        },
                        wind: {
                            speed: data.current_weather.windspeed
                        }
                    },
                    location: 'æ¨ªæµœå¸‚',
                    source: 'Open-Meteo',
                    forecast: {
                        list: data.hourly.time.slice(0, 8).map((time, index) => ({
                            dt: new Date(time).getTime() / 1000,
                            pop: data.hourly.precipitation_probability[index] / 100
                        }))
                    }
                };
                
            } catch (error) {
                console.error('Open-Meteoå–å¾—å¤±æ•—:', error);
                return null;
            }
        }
        
        // wttr.in APIï¼ˆãƒ†ã‚­ã‚¹ãƒˆãƒ™ãƒ¼ã‚¹ï¼‰
        async function getWttrWeather() {
            try {
                const url = 'https://wttr.in/æ¨ªæµœ?format=j1';
                const response = await fetch(url);
                if (!response.ok) throw new Error('wttr.in APIå¤±æ•—');
                
                const data = await response.json();
                const current = data.current_condition[0];
                const today = data.weather[0];
                
                return {
                    current: {
                        temp: parseInt(current.temp_C),
                        weather: [{
                            main: current.weatherDesc[0].value,
                            description: current.weatherDesc[0].value,
                            icon: mapWttrIcon(current.weatherCode)
                        }],
                        main: {
                            temp: parseInt(current.temp_C),
                            humidity: parseInt(current.humidity)
                        },
                        wind: {
                            speed: parseInt(current.windspeedKmph) / 3.6 // km/h to m/s
                        }
                    },
                    location: 'æ¨ªæµœå¸‚',
                    source: 'wttr.in',
                    forecast: {
                        list: today.hourly.slice(0, 8).map((hour, index) => ({
                            dt: Date.now() / 1000 + (index * 3600),
                            pop: parseInt(hour.chanceofrain) / 100
                        }))
                    }
                };
                
            } catch (error) {
                console.error('wttr.inå–å¾—å¤±æ•—:', error);
                return null;
            }
        }
        
        // å…¬é–‹æ°—è±¡ãƒ‡ãƒ¼ã‚¿ï¼ˆæ°—è±¡åºãªã©ï¼‰
        async function getPublicWeatherData() {
            try {
                // æ°—è±¡åºã®APIã¯åˆ¶é™ãŒã‚ã‚‹ãŸã‚ã€ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                const mockData = {
                    current: {
                        temp: 25,
                        weather: [{
                            main: 'Clear',
                            description: 'æ™´ã‚Œ',
                            icon: '01d'
                        }],
                        main: {
                            temp: 25,
                            humidity: 65
                        },
                        wind: {
                            speed: 3
                        }
                    },
                    location: 'æ¨ªæµœå¸‚',
                    source: 'æ¨å®šå€¤',
                    forecast: {
                        list: Array(8).fill().map((_, index) => ({
                            dt: Date.now() / 1000 + (index * 3600),
                            pop: 0.1
                        }))
                    }
                };
                
                return mockData;
                
            } catch (error) {
                console.error('å…¬é–‹ãƒ‡ãƒ¼ã‚¿å–å¾—å¤±æ•—:', error);
                return null;
            }
        }
        
        // å¤©æ°—ã‚³ãƒ¼ãƒ‰ã‹ã‚‰å¤©æ°—çŠ¶æ…‹ã‚’å–å¾—
        function getWeatherFromCode(code) {
            const codeMap = {
                0: 'Clear',
                1: 'Clear', 2: 'Clouds', 3: 'Clouds',
                45: 'Fog', 48: 'Fog',
                51: 'Drizzle', 53: 'Drizzle', 55: 'Drizzle',
                61: 'Rain', 63: 'Rain', 65: 'Rain',
                80: 'Rain', 81: 'Rain', 82: 'Rain',
                95: 'Thunderstorm', 96: 'Thunderstorm', 99: 'Thunderstorm'
            };
            return codeMap[code] || 'Clear';
        }
        
        // å¤©æ°—ã‚³ãƒ¼ãƒ‰ã‹ã‚‰èª¬æ˜ã‚’å–å¾—
        function getWeatherDescription(code) {
            const descMap = {
                0: 'å¿«æ™´', 1: 'æ™´ã‚Œ', 2: 'ä¸€éƒ¨æ›‡ã‚Š', 3: 'æ›‡ã‚Š',
                45: 'éœ§', 48: 'éœ§æ°·',
                51: 'å°é›¨', 53: 'é›¨', 55: 'å¤§é›¨',
                61: 'å°é›¨', 63: 'é›¨', 65: 'å¤§é›¨',
                80: 'ã«ã‚ã‹é›¨', 81: 'ã«ã‚ã‹é›¨', 82: 'å¤§é›¨',
                95: 'é›·é›¨', 96: 'é›·é›¨', 99: 'é›·é›¨'
            };
            return descMap[code] || 'æ™´ã‚Œ';
        }
        
        // å¤©æ°—ã‚³ãƒ¼ãƒ‰ã‹ã‚‰ã‚¢ã‚¤ã‚³ãƒ³ã‚’å–å¾—
        function getIconFromCode(code) {
            if (code === 0 || code === 1) return '01d';
            if (code === 2) return '02d';
            if (code === 3) return '03d';
            if (code >= 45 && code <= 48) return '50d';
            if (code >= 51 && code <= 65) return '10d';
            if (code >= 80 && code <= 82) return '09d';
            if (code >= 95) return '11d';
            return '01d';
        }
        
        // wttr.inã®ã‚¢ã‚¤ã‚³ãƒ³ãƒãƒƒãƒ”ãƒ³ã‚°
        function mapWttrIcon(code) {
            const iconMap = {
                113: '01d', 116: '02d', 119: '03d', 122: '04d',
                143: '50d', 176: '09d', 179: '13d', 182: '13d',
                185: '13d', 200: '11d', 227: '13d', 230: '13d',
                248: '50d', 260: '50d', 263: '09d', 266: '09d',
                281: '13d', 284: '13d', 293: '09d', 296: '09d',
                299: '09d', 302: '09d', 305: '09d', 308: '09d',
                311: '09d', 314: '09d', 317: '09d', 320: '13d',
                323: '13d', 326: '13d', 329: '13d', 332: '13d',
                335: '13d', 338: '13d', 350: '13d', 353: '09d',
                356: '09d', 359: '09d', 362: '13d', 365: '13d',
                368: '13d', 371: '13d', 374: '13d', 377: '13d',
                386: '11d', 389: '11d', 392: '11d', 395: '11d'
            };
            return iconMap[code] || '01d';
        }
        
        function updateWeatherDisplay(weatherData) {
            const controlPanel = document.getElementById('controlPanel');
            let weatherSection = document.getElementById('weatherSection');
            
            if (!weatherSection) {
                weatherSection = document.createElement('div');
                weatherSection.id = 'weatherSection';
                weatherSection.className = 'weather-section';
                weatherSection.style.marginBottom = 'var(--spacing-md)';
                
                // ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ«ã®é©åˆ‡ãªä½ç½®ã«æŒ¿å…¥ï¼ˆè²»ç”¨è¨ˆç®—ã®å¾Œï¼‰
                const costSection = document.getElementById('costSection');
                if (costSection && costSection.parentNode) {
                    costSection.parentNode.insertBefore(weatherSection, costSection.nextSibling);
                } else {
                    controlPanel.appendChild(weatherSection);
                }
            }
            
            if (weatherData) {
                const current = weatherData.current;
                const todayForecast = weatherData.forecast.list.find(item => {
                    const forecastDate = new Date(item.dt * 1000);
                    const today = new Date();
                    return forecastDate.getDate() === today.getDate();
                });
                
                const weatherIcon = getWeatherIcon(current.weather[0].icon);
                const precipitation = todayForecast ? Math.round(todayForecast.pop * 100) : 0;
                
                // ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã®è¡¨ç¤º
                const sourceIcon = weatherData.source === 'Open-Meteo' ? 'ğŸŒ' : 
                                 weatherData.source === 'wttr.in' ? 'ğŸ“¡' : 'â˜ï¸';
                
                weatherSection.innerHTML = `
                    <h3>ğŸŒ¤ï¸ å¤©æ°—æƒ…å ±</h3>
                    <div class="weather-current">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                            <span style="font-size: 24px;">${weatherIcon}</span>
                            <div>
                                <div style="font-weight: 600;">${Math.round(current.main.temp)}Â°C</div>
                                <div style="font-size: 12px; color: var(--text-muted);">${current.weather[0].description}</div>
                            </div>
                        </div>
                        <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px;">
                            ${weatherData.location} | æ¹¿åº¦: ${current.main.humidity}%
                        </div>
                        <div style="font-size: 12px; margin-bottom: 8px;">
                            ğŸ’§ é™æ°´ç¢ºç‡: ${precipitation}%
                        </div>
                        <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 8px;">
                            ${sourceIcon} ãƒ‡ãƒ¼ã‚¿: ${weatherData.source} | æ›´æ–°: ${new Date().toLocaleTimeString('ja-JP', {hour: '2-digit', minute: '2-digit'})}
                        </div>
                        <button class="time-btn" onclick="updateWeather()" style="width: 100%; margin-top: 8px;">
                            ğŸ”„ æ›´æ–°
                        </button>
                    </div>
                    <div class="weather-alert" id="weatherAlert" style="display: none; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px; padding: 8px; margin-top: 8px; font-size: 12px;">
                    </div>
                `;
                
                // å¤©æ°—ã‚¢ãƒ©ãƒ¼ãƒˆã‚’ãƒã‚§ãƒƒã‚¯
                checkWeatherAlerts(weatherData);
                
                // ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚¢ã‚¤ãƒ†ãƒ ã«ã‚‚å¤©æ°—æƒ…å ±ã‚’è¿½åŠ 
                addWeatherToTimelineItems(weatherData);
            } else {
                fallbackWeatherDisplay();
            }
        }
        
        // ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚¢ã‚¤ãƒ†ãƒ ã«å¤©æ°—æƒ…å ±ã‚’è¿½åŠ 
        function addWeatherToTimelineItems(weatherData) {
            const timelineItems = document.querySelectorAll('.timeline-item');
            
            timelineItems.forEach((item, index) => {
                // æ—¢å­˜ã®å¤©æ°—æƒ…å ±ã‚’å‰Šé™¤
                const existingWeather = item.querySelector('.weather-info');
                if (existingWeather) {
                    existingWeather.remove();
                }
                
                // å±‹å¤–æ´»å‹•ã®ã¿ã«å¤©æ°—æƒ…å ±ã‚’è¡¨ç¤º
                const isOutdoorActivity = isOutdoorLocation(item.dataset.location);
                if (!isOutdoorActivity) return;
                
                const timelineCard = item.querySelector('.timeline-card');
                const statusIndicator = item.querySelector('.status-indicator');
                
                // å¤©æ°—æƒ…å ±è¦ç´ ã‚’ä½œæˆ
                const weatherInfo = document.createElement('div');
                weatherInfo.className = 'weather-info';
                
                const current = weatherData.current;
                const weatherIcon = getWeatherIcon(current.weather[0].icon);
                const temp = Math.round(current.main.temp);
                const desc = current.weather[0].description;
                
                weatherInfo.innerHTML = `
                    <div class="weather-icon">${weatherIcon}</div>
                    <div class="weather-details">
                        <div class="weather-temp">${temp}Â°C</div>
                        <div class="weather-desc">${desc}</div>
                    </div>
                `;
                
                // ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ: ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã¨å¤©æ°—æƒ…å ±ã‚’ã‚³ãƒ³ãƒ†ãƒŠã«é…ç½®
                if (window.innerWidth <= 768) {
                    let statusWeatherContainer = timelineCard.querySelector('.status-weather-container');
                    if (!statusWeatherContainer) {
                        statusWeatherContainer = document.createElement('div');
                        statusWeatherContainer.className = 'status-weather-container';
                        
                        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚’ã‚³ãƒ³ãƒ†ãƒŠã«ç§»å‹•
                        if (statusIndicator) {
                            statusIndicator.remove();
                            statusWeatherContainer.appendChild(statusIndicator);
                        }
                        
                        // æ™‚é–“è¦ç´ ã®å¾Œã«æŒ¿å…¥
                        const timeElement = timelineCard.querySelector('.time');
                        if (timeElement) {
                            timeElement.insertAdjacentElement('afterend', statusWeatherContainer);
                        } else {
                            timelineCard.insertBefore(statusWeatherContainer, timelineCard.firstChild);
                        }
                    }
                    
                    statusWeatherContainer.appendChild(weatherInfo);
                } else {
                    // ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—: çµ¶å¯¾ä½ç½®ã§ã®é…ç½®
                    timelineCard.appendChild(weatherInfo);
                }
            });
        }
        
        // å±‹å¤–æ´»å‹•ã‹ã©ã†ã‹ã‚’åˆ¤å®š
        function isOutdoorLocation(location) {
            const outdoorKeywords = [
                'å¸‚å ´', 'å•†åº—è¡—', 'ãƒãƒ«ã‚·ã‚§', 'å€‰åº«', 'é§…', 'å…­è§’æ©‹', 
                'èµ¤ãƒ¬ãƒ³ã‚¬', 'åŒ—ä»²', 'ç™½æ¥½', 'æ‰ç”°', 'æ¸‹è°·', 'æ¨ªæµœ',
                'è‡ªè»¢è»Š', 'ã‚µã‚¤ã‚¯ãƒªãƒ³ã‚°', 'CYCLING'
            ];
            
            const indoorKeywords = [
                'ãƒ©ãƒ¼ãƒ¡ãƒ³', 'åº—', 'é£Ÿäº‹', 'æœ«å»£å®¶', 'æ‰ç”°å®¶'
            ];
            
            if (!location) return false;
            
            // å±‹å†…ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã¯å±‹å†…ã¨åˆ¤å®š
            if (indoorKeywords.some(keyword => location.includes(keyword))) {
                return false;
            }
            
            // å±‹å¤–ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã¯å±‹å¤–ã¨åˆ¤å®š
            return outdoorKeywords.some(keyword => location.includes(keyword));
        }
        
        function getWeatherIcon(iconCode) {
            const iconMap = {
                '01d': 'â˜€ï¸', '01n': 'ğŸŒ™',
                '02d': 'â›…', '02n': 'â˜ï¸',
                '03d': 'â˜ï¸', '03n': 'â˜ï¸',
                '04d': 'â˜ï¸', '04n': 'â˜ï¸',
                '09d': 'ğŸŒ§ï¸', '09n': 'ğŸŒ§ï¸',
                '10d': 'ğŸŒ¦ï¸', '10n': 'ğŸŒ§ï¸',
                '11d': 'â›ˆï¸', '11n': 'â›ˆï¸',
                '13d': 'ğŸŒ¨ï¸', '13n': 'ğŸŒ¨ï¸',
                '50d': 'ğŸŒ«ï¸', '50n': 'ğŸŒ«ï¸'
            };
            return iconMap[iconCode] || 'ğŸŒ¤ï¸';
        }
        
        function checkWeatherAlerts(weatherData) {
            const alertElement = document.getElementById('weatherAlert');
            const current = weatherData.current;
            let alerts = [];
            
            // é›¨ã®è­¦å‘Š
            if (current.weather[0].main === 'Rain') {
                alerts.push('â˜” é›¨ãŒé™ã£ã¦ã„ã¾ã™ã€‚å‚˜ã‚’æŒå‚ã—ã¦ãã ã•ã„ã€‚');
            }
            
            // å¼·é¢¨ã®è­¦å‘Š
            if (current.wind && current.wind.speed > 10) {
                alerts.push('ğŸ’¨ å¼·é¢¨æ³¨æ„ã€‚è‡ªè»¢è»Šã®é‹è»¢ã«ãŠæ°—ã‚’ã¤ã‘ãã ã•ã„ã€‚');
            }
            
            // æ¥µç«¯ãªæ°—æ¸©ã®è­¦å‘Š
            if (current.main.temp > 30) {
                alerts.push('ğŸŒ¡ï¸ é«˜æ¸©æ³¨æ„ã€‚ç†±ä¸­ç—‡å¯¾ç­–ã‚’ã—ã¦ãã ã•ã„ã€‚');
            } else if (current.main.temp < 5) {
                alerts.push('ğŸ§¥ ä½æ¸©æ³¨æ„ã€‚é˜²å¯’å¯¾ç­–ã‚’ã—ã¦ãã ã•ã„ã€‚');
            }
            
            if (alerts.length > 0) {
                alertElement.innerHTML = alerts.join('<br>');
                alertElement.style.display = 'block';
            } else {
                alertElement.style.display = 'none';
            }
        }
        
        function fallbackWeatherDisplay() {
            const controlPanel = document.getElementById('controlPanel');
            let weatherSection = document.getElementById('weatherSection');
            
            if (!weatherSection) {
                weatherSection = document.createElement('div');
                weatherSection.id = 'weatherSection';
                weatherSection.style.marginBottom = 'var(--spacing-md)';
                
                // ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ«ã®é©åˆ‡ãªä½ç½®ã«æŒ¿å…¥ï¼ˆè²»ç”¨è¨ˆç®—ã®å¾Œï¼‰
                const costSection = document.getElementById('costSection');
                if (costSection && costSection.parentNode) {
                    costSection.parentNode.insertBefore(weatherSection, costSection.nextSibling);
                } else {
                    controlPanel.appendChild(weatherSection);
                }
            }
            
            weatherSection.innerHTML = `
                <h3>ğŸŒ¤ï¸ å¤©æ°—æƒ…å ±</h3>
                <div style="font-size: 12px; color: var(--text-muted); text-align: center; padding: 16px;">
                    å¤©æ°—æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚<br>
                    <a href="https://weather.yahoo.co.jp/weather/jp/14/4610.html" target="_blank" style="color: var(--secondary-color);">
                        Yahoo!å¤©æ°—ã§ç¢ºèª
                    </a>
                </div>
                <button class="time-btn" onclick="updateWeather()" style="width: 100%; margin-top: 8px;">
                    ğŸ”„ å†è©¦è¡Œ
                </button>
            `;
            
            // ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚¢ã‚¤ãƒ†ãƒ ã‹ã‚‰å¤©æ°—æƒ…å ±ã‚’å‰Šé™¤
            const timelineItems = document.querySelectorAll('.timeline-item');
            timelineItems.forEach(item => {
                const weatherInfo = item.querySelector('.weather-info');
                if (weatherInfo) {
                    weatherInfo.remove();
                }
            });
        }

        async function updateWeather() {
            // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢
            realtimeCache.weather = { data: null, timestamp: 0, ttl: 600000 };
            
            const updateButton = document.querySelector('.weather-section button, #weatherSection button');
            if (updateButton) {
                updateButton.textContent = 'æ›´æ–°ä¸­...';
                updateButton.disabled = true;
            }
            
            try {
                await getWeatherData();
                showNotification('å¤©æ°—æƒ…å ±ã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'success');
            } catch (error) {
                showNotification('å¤©æ°—æƒ…å ±ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ', 'warning');
            } finally {
                if (updateButton) {
                    updateButton.textContent = 'ğŸ”„ æ›´æ–°';
                    updateButton.disabled = false;
                }
            }
        }

        // ãƒ¡ãƒ¢æ©Ÿèƒ½ã‚’çµ±åˆæ¸ˆã¿

        // ãŠæ°—ã«å…¥ã‚Šæ©Ÿèƒ½ã‚’çµ±åˆæ¸ˆã¿

        // ãƒ‡ãƒ¼ã‚¿ä¿å­˜ãƒ»èª­ã¿è¾¼ã¿
        function saveData() {
            const data = {
                currentDelay,
                completedItems: Array.from(completedItems),
                currentItem,
                savedAt: new Date().toISOString()
            };
            localStorage.setItem('itinerary-data', JSON.stringify(data));
        }

        function loadSavedData() {
            const savedData = localStorage.getItem('itinerary-data');
            if (savedData) {
                const data = JSON.parse(savedData);
                currentDelay = data.currentDelay || 0;
                completedItems = new Set(data.completedItems || []);
                currentItem = data.currentItem || 0;
                
                // å®Œäº†ã—ãŸã‚¢ã‚¤ãƒ†ãƒ ã«ã‚¹ã‚¿ã‚¤ãƒ«ã‚’é©ç”¨
                completedItems.forEach(index => {
                    const items = document.querySelectorAll('.timeline-item');
                    if (items[index]) {
                        items[index].classList.add('completed');
                    }
                });
                
                updateCurrentDelayDisplay();
            }
            
            // å…ƒã®æ™‚é–“ã‚’ä¿å­˜
            const timeElements = document.querySelectorAll('.time');
            timeElements.forEach(element => {
                element.setAttribute('data-original-time', element.textContent);
            });
        }

        // è¿½åŠ æ©Ÿèƒ½ã®åˆæœŸåŒ–å‡¦ç†ã‚’çµ±åˆæ¸ˆã¿

        // åœ°å›³æ©Ÿèƒ½
        function showMap(location) {
            const modal = document.getElementById('mapModal');
            const title = document.getElementById('mapTitle');
            const content = document.getElementById('mapContent');
            
            title.textContent = `${location} - åœ°å›³`;
            
            // å®Ÿéš›ã®å®Ÿè£…ã§ã¯ã€Google Maps APIã‚’ä½¿ç”¨
            content.innerHTML = `
                <div>
                    <p>ğŸ“ ${location}</p>
                    <p>ã“ã®æ©Ÿèƒ½ã§ã¯ä»¥ä¸‹ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ï¼š</p>
                    <ul style="text-align: left; margin: 10px 0;">
                        <li>é¸æŠã—ãŸå ´æ‰€ã®è©³ç´°åœ°å›³</li>
                        <li>å‘¨è¾ºã®æ–½è¨­ãƒ»åº—èˆ—æƒ…å ±</li>
                        <li>æœ€é©ãªãƒ«ãƒ¼ãƒˆæ¡ˆå†…</li>
                        <li>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ äº¤é€šæƒ…å ±</li>
                    </ul>
                    <div style="margin-top: 15px;">
                        <a href="https://maps.google.com/maps?q=${encodeURIComponent(location)}" 
                           target="_blank" 
                           style="display: inline-block; padding: 10px 20px; background: #3498db; color: white; text-decoration: none; border-radius: 4px;">
                            Google ãƒãƒƒãƒ—ã§é–‹ã
                        </a>
                    </div>
                </div>
            `;
            
            modal.classList.add('active');
            showNotification(`${location}ã®åœ°å›³ã‚’è¡¨ç¤ºä¸­`, 'info');
        }

        function closeMap() {
            const modal = document.getElementById('mapModal');
            modal.classList.remove('active');
        }

        // å„ç¨®æƒ…å ±è¡¨ç¤ºæ©Ÿèƒ½
        function showStationInfo(station) {
            const info = {
                'æ¸‹è°·é§…': 'æ¸‹è°·é§…ã¯æ±äº¬ã®ä¸»è¦ã‚¿ãƒ¼ãƒŸãƒŠãƒ«é§…ã®ä¸€ã¤ã§ã™ã€‚ãƒã‚¤ã‚¯ã‚·ã‚§ã‚¢ã®ãƒãƒ¼ãƒˆã¯é§…å‰ã«è¤‡æ•°ã‚ã‚Šã¾ã™ã€‚',
                'æ–°æ‰ç”°é§…': 'JRæ ¹å²¸ç·šã¨äº¬æ€¥æœ¬ç·šãŒä¹—ã‚Šå…¥ã‚Œã¦ã„ã¾ã™ã€‚æ¨ªæµœæ–¹é¢ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒä¾¿åˆ©ã§ã™ã€‚',
                'ç™½æ¥½é§…': 'æ±æ€¥æ±æ¨ªç·šã®é§…ã§ã™ã€‚å…­è§’æ©‹å•†åº—è¡—ã®æœ€å¯„ã‚Šé§…ã¨ã—ã¦çŸ¥ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚'
            };
            
            showNotification(info[station] || `${station}ã®æƒ…å ±ã‚’å–å¾—ä¸­...`, 'info');
        }

        function showRestaurantInfo(restaurant) {
            const info = {
                'ãƒ©ãƒ¼ãƒ¡ãƒ³æœ«å»£å®¶': 'å…­è§’æ©‹å•†åº—è¡—ã®äººæ°—ãƒ©ãƒ¼ãƒ¡ãƒ³åº—ã€‚å–¶æ¥­æ™‚é–“ã¯11:00é–‹åº—ã€æ—¥ãƒ»æœˆä¼‘ã¿ã€‚',
                'æ‰ç”°å®¶æœ¬åº—': 'å®¶ç³»ãƒ©ãƒ¼ãƒ¡ãƒ³ã®è€èˆ—ã€‚å–¶æ¥­æ™‚é–“ã¯5:00-22:00ã€æ—¥æ›œä¼‘ã¿ã€‚ã€Œå‘³è–„ã‚ã€æŒ‡å®šã‚‚å¯ã€‚'
            };
            
            showNotification(info[restaurant] || `${restaurant}ã®æƒ…å ±ã‚’å–å¾—ä¸­...`, 'info');
        }

        function showEventInfo(event) {
            const info = {
                'æ°´ç”£ä»²å¸æ£Ÿ': 'æ¯æœˆç¬¬3åœŸæ›œæ—¥8:00-10:00é–‹å‚¬ã€‚æ–°é®®ãªé­šä»‹é¡ã®ç›´å£²ã¨ãƒã‚°ãƒ­ã®è§£ä½“ã‚·ãƒ§ãƒ¼ãŒè¦‹ã©ã“ã‚ã§ã™ã€‚',
                'æ¨ªæµœåŒ—ä»²ãƒãƒ«ã‚·ã‚§': 'æ¯æœˆé–‹å‚¬ã®åœ°åŸŸãƒãƒ«ã‚·ã‚§ã€‚åœ°å…ƒé‡èœã¨ã‚¯ãƒ©ãƒ•ãƒˆãƒ¯ã‚¤ãƒ³ãŒå……å®Ÿã€‚10:00-16:00ã€‚',
                'BAY WALK MARKET': 'ã¿ãªã¨ã¿ã‚‰ã„ã§é–‹å‚¬ã•ã‚Œã‚‹å¤§å‹ãƒãƒ¼ã‚±ãƒƒãƒˆã€‚HAMMERHEADã¯12:00-ã€èµ¤ãƒ¬ãƒ³ã‚¬ã¯15:30-ã€‚',
                'å…­è§’æ©‹ãƒ¤ãƒŸå¸‚': 'æ¯æœˆç¬¬3åœŸæ›œæ—¥18:30-21:30é–‹å‚¬ã€‚å¤šå›½ç±å±‹å°ã¨ç›†è¸Šã‚ŠãŒæ¥½ã—ã‚ã‚‹åœ°åŸŸå¯†ç€å‹ã‚¤ãƒ™ãƒ³ãƒˆã€‚'
            };
            
            showNotification(info[event] || `${event}ã®æƒ…å ±ã‚’å–å¾—ä¸­...`, 'info');
        }

        function showShoppingInfo(shopping) {
            const info = {
                'å…­è§’æ©‹å•†åº—è¡—': 'æ˜­å’Œãƒ¬ãƒˆãƒ­ãªå•†åº—è¡—ã€‚å–«èŒ¶ã€Œçˆç²æ–‡æ˜ã€ã§ã®ä¼‘æ†©ãŒãŠã™ã™ã‚ã€‚',
                'ç™½æ¥½å•†åº—è¡—': 'ã€Œå±±ç”°å±‹ã€ã®ã‹ãæ°·ãŒæœ‰åã€‚ãƒ¤ãƒŸå¸‚å‰ã®ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ã«æœ€é©ã€‚'
            };
            
            showNotification(info[shopping] || `${shopping}ã®æƒ…å ±ã‚’å–å¾—ä¸­...`, 'info');
        }

        function showPortInfo(port) {
            const info = {
                'æ–°æ‰ç”°é§…ç¬¬å››è‡ªè»¢è»Šé§è»Šå ´': 'HELLO CYCLINGå¯¾å¿œãƒãƒ¼ãƒˆã€‚24æ™‚é–“è¿”å´å¯èƒ½ã€‚æ‰ç”°å®¶æœ¬åº—ã¾ã§å¾’æ­©ç´„2åˆ†ã€‚'
            };
            
            showNotification(info[port] || `${port}ã®æƒ…å ±ã‚’å–å¾—ä¸­...`, 'info');
        }

        function showTrafficInfo() {
            checkTrafficStatus();
            showNotification('äº¤é€šæƒ…å ±ã‚’ç¢ºèªä¸­...', 'info');
        }
        
        // äº¤é€šæƒ…å ±ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒã‚§ãƒƒã‚¯
        async function checkTrafficStatus() {
            try {
                if (isDataCached('traffic')) {
                    displayTrafficInfo(realtimeCache.traffic.data);
                    return;
                }
                
                // ä¸»è¦è·¯ç·šã®äº¤é€šæƒ…å ±ã‚’ãƒã‚§ãƒƒã‚¯
                const routes = [
                    {
                        name: 'JRæ±æµ·é“ç·š',
                        from: 'æ¸‹è°·',
                        to: 'æ–°æ‰ç”°',
                        type: 'train',
                        company: 'JRæ±æ—¥æœ¬'
                    },
                    {
                        name: 'JRäº¬æµœæ±åŒ—ç·š',
                        from: 'æ–°æ‰ç”°',
                        to: 'ç™½æ¥½',
                        type: 'train',
                        company: 'JRæ±æ—¥æœ¬'
                    },
                    {
                        name: 'æ±æ€¥æ±æ¨ªç·š',
                        from: 'ç™½æ¥½',
                        to: 'æ¸‹è°·',
                        type: 'train',
                        company: 'æ±æ€¥é›»é‰„'
                    },
                    {
                        name: 'å›½é“246å·ãƒ»1å·',
                        from: 'æ¸‹è°·',
                        to: 'æ¨ªæµœ',
                        type: 'road',
                        company: 'å›½åœŸäº¤é€šçœ'
                    }
                ];
                
                const trafficData = await Promise.all(routes.map(async (route) => {
                    const status = await checkRouteStatus(route);
                    return { ...route, status };
                }));
                
                realtimeCache.traffic = {
                    data: trafficData,
                    timestamp: Date.now(),
                    ttl: 300000
                };
                
                displayTrafficInfo(trafficData);
                
            } catch (error) {
                console.error('äº¤é€šæƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                showNotification('äº¤é€šæƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ', 'warning');
                displayFallbackTrafficInfo();
            }
        }
        
        async function checkRouteStatus(route) {
            // å®Ÿéš›ã®å®Ÿè£…ã§ã¯äº¤é€šæƒ…å ±APIã‚’ä½¿ç”¨
            // ã“ã“ã§ã¯ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¡Œã†
            
            const statuses = [
                { status: 'normal', message: 'æ­£å¸¸é‹è¡Œ', color: '#28a745', delay: 0 },
                { status: 'slight_delay', message: 'è‹¥å¹²ã®é…ã‚Œ', color: '#ffc107', delay: 3 },
                { status: 'delay', message: 'é…ã‚Œã‚ã‚Š', color: '#fd7e14', delay: 8 },
                { status: 'major_delay', message: 'å¤§å¹…é…ã‚Œ', color: '#dc3545', delay: 15 }
            ];
            
            // ãƒ©ãƒ³ãƒ€ãƒ ã«çŠ¶æ³ã‚’æ±ºå®šï¼ˆå®Ÿéš›ã¯APIã‹ã‚‰å–å¾—ï¼‰
            const randomStatus = statuses[Math.floor(Math.random() * statuses.length)];
            
            return {
                ...randomStatus,
                lastUpdate: new Date().toLocaleTimeString('ja-JP', {hour: '2-digit', minute: '2-digit'}),
                url: getOfficialTrafficUrl(route)
            };
        }
        
        function getOfficialTrafficUrl(route) {
            const urls = {
                'JRæ±æµ·é“ç·š': 'https://traininfo.jreast.co.jp/train_info/kanto.aspx',
                'JRäº¬æµœæ±åŒ—ç·š': 'https://traininfo.jreast.co.jp/train_info/kanto.aspx',
                'æ±æ€¥æ±æ¨ªç·š': 'https://www.tokyu.co.jp/unkou/',
                'å›½é“246å·ãƒ»1å·': 'https://www.jartic.or.jp/'
            };
            return urls[route.name] || 'https://transit.yahoo.co.jp/';
        }
        
        function displayTrafficInfo(trafficData) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0, 0, 0, 0.8); z-index: 1000;
                display: flex; align-items: center; justify-content: center;
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: white; border-radius: 8px; padding: 20px;
                max-width: 500px; max-height: 80%; overflow-y: auto;
                position: relative;
            `;
            
            content.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #dee2e6;">
                    <h3 style="margin: 0; color: var(--primary-color);">ğŸšƒ äº¤é€šæƒ…å ±</h3>
                    <button onclick="this.closest('.modal').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6c757d;">Ã—</button>
                </div>
                <div class="traffic-list">
                    ${trafficData.map(route => `
                        <div style="margin-bottom: 15px; padding: 12px; border: 1px solid #dee2e6; border-radius: 6px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <strong style="color: var(--primary-color);">${route.name}</strong>
                                <span style="background: ${route.status.color}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 600;">
                                    ${route.status.message}
                                </span>
                            </div>
                            <div style="font-size: 14px; color: var(--text-muted); margin-bottom: 8px;">
                                ${route.from} â†’ ${route.to}
                                ${route.status.delay > 0 ? `<br><span style="color: #dc3545;">ç´„${route.status.delay}åˆ†ã®é…ã‚Œ</span>` : ''}
                            </div>
                            <div style="font-size: 12px; color: var(--text-muted);">
                                æœ€çµ‚æ›´æ–°: ${route.status.lastUpdate} | 
                                <a href="${route.status.url}" target="_blank" style="color: var(--secondary-color);">å…¬å¼æƒ…å ±</a>
                            </div>
                        </div>
                    `).join('')}
                </div>
                <div style="text-align: center; margin-top: 15px;">
                    <button onclick="checkTrafficStatus()" style="background: var(--secondary-color); color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
                        ğŸ”„ æ›´æ–°
                    </button>
                </div>
            `;
            
            modal.appendChild(content);
            modal.className = 'modal';
            document.body.appendChild(modal);
            
            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®å¤–å´ã‚’ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }
        
        function displayFallbackTrafficInfo() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0, 0, 0, 0.8); z-index: 1000;
                display: flex; align-items: center; justify-content: center;
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: white; border-radius: 8px; padding: 20px;
                max-width: 400px; text-align: center;
            `;
            
            content.innerHTML = `
                <h3 style="color: var(--primary-color); margin-bottom: 15px;">ğŸšƒ äº¤é€šæƒ…å ±</h3>
                <p style="margin-bottom: 20px; color: var(--text-muted);">
                    ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚<br>
                    ä»¥ä¸‹ã®ã‚µã‚¤ãƒˆã§æœ€æ–°æƒ…å ±ã‚’ã”ç¢ºèªãã ã•ã„ã€‚
                </p>
                <div style="text-align: left;">
                    <a href="https://traininfo.jreast.co.jp/train_info/kanto.aspx" target="_blank" style="display: block; margin-bottom: 8px; color: var(--secondary-color);">
                        ğŸš„ JRæ±æ—¥æœ¬ é‹è¡Œæƒ…å ±
                    </a>
                    <a href="https://www.tokyu.co.jp/unkou/" target="_blank" style="display: block; margin-bottom: 8px; color: var(--secondary-color);">
                        ğŸšƒ æ±æ€¥é›»é‰„ é‹è¡Œæƒ…å ±
                    </a>
                    <a href="https://www.jartic.or.jp/" target="_blank" style="display: block; margin-bottom: 8px; color: var(--secondary-color);">
                        ğŸš— JARTIC é“è·¯äº¤é€šæƒ…å ±
                    </a>
                    <a href="https://transit.yahoo.co.jp/" target="_blank" style="display: block; color: var(--secondary-color);">
                        ğŸ” Yahoo!ä¹—æ›æ¡ˆå†…
                    </a>
                </div>
                <button onclick="this.closest('.modal').remove()" style="margin-top: 20px; background: var(--secondary-color); color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
                    é–‰ã˜ã‚‹
                </button>
            `;
            
            modal.appendChild(content);
            modal.className = 'modal';
            document.body.appendChild(modal);
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        function showTrainInfo(route) {
            const info = {
                'æ–°æ‰ç”°-ç™½æ¥½': 'JRæ ¹å²¸ç·šâ†’æ¨ªæµœé§…ã§æ±æ€¥æ±æ¨ªç·šã«ä¹—ã‚Šæ›ãˆã€‚ç´„30åˆ†ã€370å††ã€‚',
                'ç™½æ¥½-æ¸‹è°·': 'æ±æ€¥æ±æ¨ªç·šç‰¹æ€¥ç›´é€šã€‚ç´„25åˆ†ã€290å††ã€‚å¤œé–“ã‚‚é‹è¡Œã—ã¦ã„ã¾ã™ã€‚'
            };
            
            showNotification(info[route] || `${route}ã®æ™‚åˆ»è¡¨ã‚’ç¢ºèªä¸­...`, 'info');
        }

        // é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ 
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 4000);
        }

        // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰æ©Ÿèƒ½
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('dark-mode', isDark);
            
            const button = document.querySelector('.control-panel button[onclick="toggleDarkMode()"]');
            button.textContent = isDark ? 'â˜€ï¸' : 'ğŸŒ™';
            
            showNotification(`${isDark ? 'ãƒ€ãƒ¼ã‚¯' : 'ãƒ©ã‚¤ãƒˆ'}ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆã¾ã—ãŸ`, 'success');
        }

        // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰è¨­å®šã‚’èª­ã¿è¾¼ã¿
        function loadDarkMode() {
            const isDark = localStorage.getItem('dark-mode') === 'true';
            if (isDark) {
                document.body.classList.add('dark-mode');
                const button = document.querySelector('.control-panel button[onclick="toggleDarkMode()"]');
                if (button) button.textContent = 'â˜€ï¸';
            }
        }

        // åˆæœŸåŒ–æ™‚ã«ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰è¨­å®šã‚’èª­ã¿è¾¼ã¿ï¼ˆãƒ¡ã‚¤ãƒ³åˆæœŸåŒ–é–¢æ•°ã«çµ±åˆæ¸ˆã¿ï¼‰

        // å…±æœ‰æ©Ÿèƒ½
        function shareItinerary() {
            if (navigator.share) {
                navigator.share({
                    title: '2025å¹´7æœˆ19æ—¥ æ¸‹è°·â†’æ¨ªæµœ ä¸€æ—¥ãƒ—ãƒ©ãƒ³',
                    text: 'HELLO CYCLING ã¨é›»è»Šã‚’ä½¿ã£ãŸæ¨ªæµœã‚°ãƒ«ãƒ¡ãƒ»ã‚¤ãƒ™ãƒ³ãƒˆå·¡ã‚Š',
                    url: window.location.href
                });
            } else {
                const url = window.location.href;
                navigator.clipboard.writeText(url).then(() => {
                    showNotification('URLã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼', 'success');
                });
            }
        }

        // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½
        function exportItinerary() {
            const data = {
                title: '2025å¹´7æœˆ19æ—¥ æ¸‹è°·â†’æ¨ªæµœ ä¸€æ—¥ãƒ—ãƒ©ãƒ³',
                progress: {
                    completed: Array.from(completedItems),
                    delay: currentDelay
                },
                memo: localStorage.getItem('itinerary-memo') || '',
                favorites: JSON.parse(localStorage.getItem('itinerary-favorites') || '[]'),
                exportDate: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'itinerary-data.json';
            a.click();
            URL.revokeObjectURL(url);
            
            showNotification('ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸï¼', 'success');
        }

        // å…±æœ‰ãƒ»ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½ã‚’çµ±åˆæ¸ˆã¿

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹ãŸã‚ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('map-modal')) {
                closeMap();
            }
            if (e.target.classList.contains('expense-modal')) {
                closeExpenseModal();
            }
            if (e.target.classList.contains('photo-modal')) {
                closePhotoModal();
            }
        });

        // ESCã‚­ãƒ¼ã§ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeMap();
                closeFavoriteModal();
                closeExpenseModal();
                closePhotoModal();
            }
        });
    </script>
</body>
</html>
